<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="light dark" />
  <title>ImpulsoLocal ‚Äî Directorio de negocios locales</title>
  <meta name="description" content="ImpulsoLocal: encuentra y conecta con negocios locales en Per√∫. B√∫squeda r√°pida por rubros, ubicaci√≥n y palabras clave." />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='128' height='128'%3E%3Crect width='100%25' height='100%25' rx='24' fill='%230a7cff'/%3E%3Cpath d='M26 80 L64 22 L102 80 Z' fill='white'/%3E%3Ccircle cx='64' cy='86' r='10' fill='white'/%3E%3C/svg%3E" />
  <style>
    /* ==========================
       ImpulsoLocal ‚Äî Base CSS
       Bloque 1: Esqueleto, Header, Hero, Tokens
       ========================== */

    :root{
      --bg: #0b0f0e;
      --bg-soft:#111318;
      --surface:#171923;
      --surface-2:#1e2230;
      --text:#e7eaf3;
      --muted:#a8b0c2;
      --brand:#0a7cff;
      --brand-2:#62d1ff;
      --ok:#14b8a6;
      --warn:#f59e0b;
      --err:#ef4444;
      --card: #0f1117;

      --ring: 0 0 0 3px rgba(10,124,255,.35);
      --radius: 14px;
      --radius-sm: 10px;
      --radius-lg: 22px;

      --shadow-sm: 0 1px 2px rgba(0,0,0,.25);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --shadow-lg: 0 30px 80px rgba(0,0,0,.45);

      --container: 1160px;
      --gap: 14px;

      --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --bg-soft:#eef1f7;
        --surface:#ffffff;
        --surface-2:#f6f7fb;
        --text:#111827;
        --muted:#5b6477;
        --card:#ffffff;
        --shadow: 0 8px 24px rgba(16,24,40,.12);
        --shadow-lg: 0 24px 64px rgba(16,24,40,.16);
        
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      background: radial-gradient(1200px 600px at 70% -10%, rgba(10,124,255,.18), transparent 60%) , linear-gradient(180deg,var(--bg) 0%, var(--bg-soft) 100%);
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      text-rendering:optimizeLegibility;
    }

    a{color:inherit;text-decoration:none}
    img{display:block;max-width:100%}
    button,input,select,textarea{font:inherit;color:inherit}
    ::selection{background:rgba(10,124,255,.25)}

    .container{
      width:100%;
      max-width:var(--container);
      margin-inline:auto;
      padding-inline:clamp(16px, 3vw, 24px);
    }

    /* Header */
    header.site{
      position:sticky; top:0; z-index:50;
      backdrop-filter:saturate(1.1) blur(8px);
      background: linear-gradient(180deg, rgba(12,14,18,.75), rgba(12,14,18,.45));
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    @media (prefers-color-scheme: light){
      header.site{
        background: rgba(255,255,255,.7);
        border-bottom:1px solid rgba(16,24,40,.08);
      }
    }
    .nav{
      display:flex; align-items:center; gap:16px;
      padding-block:10px;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:8px 10px; border-radius:12px;
    }
    .brand-logo{
      width:34px; height:34px; border-radius:10px;
      background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--brand));
      box-shadow: inset 0 0 0 2px rgba(255,255,255,.12), var(--shadow-sm);
      display:grid; place-items:center; color:rgb(163, 237, 210); font-weight:800;
    }
    .brand-title{
      font-weight:800; letter-spacing:.2px; font-size:18px;
    }
    .nav-links{
      margin-left:auto; display:flex; align-items:center; gap:6px;
      background:var(--surface); padding:6px; border-radius:12px; box-shadow:var(--shadow-sm);
    }
    .nav-links a, .nav-links button{
      padding:8px 12px; border-radius:10px; border:1px solid transparent;
      transition:transform .12s ease, background .12s ease, border-color .12s ease;
      display:flex; align-items:center; gap:8px;
    }
    .nav-links a:hover{background:var(--surface-2); transform:translateY(-1px)}
    .nav-cta{
      background:linear-gradient(180deg,var(--brand), #00c4e6);
      color:white; font-weight:700; border:1px solid rgba(255,255,255,.14);
      box-shadow:0 6px 20px rgba(10,124,255,.35);
    }
    .nav-cta:hover{filter:brightness(1.05)}
    .nav-minor{
      color:var(--muted);
    }

    /* Hero / Buscador principal */
    .hero{
      position:relative; padding-block: max(28px, 6vh) max(36px, 6vh);
    }
    .hero-grid{
      display:grid; grid-template-columns:1.15fr .85fr; gap:26px; align-items:center;
    }
    @media (max-width: 940px){
      .hero-grid{grid-template-columns:1fr; gap:18px}
    }
    .hero-title{
      font-size: clamp(28px, 5vw, 46px);
      line-height:1.05; letter-spacing:-.02em; font-weight:900; margin:0;
      text-wrap:balance;
    }
    .hero-sub{
      color:var(--muted); margin-top:10px; font-size: clamp(15px, 2.2vw, 17px);
    }
    .search-card{
      margin-top:18px; background:linear-gradient(180deg, var(--surface), var(--surface-2));
      padding:14px; border-radius:var(--radius-lg); box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.06);
    }
    @media (prefers-color-scheme: light){
      .search-card{border:1px solid rgba(16,24,40,.08)}
    }
    .search-row{
      display:grid; grid-template-columns: 1fr .75fr .75fr auto; gap:10px;
    }
    @media (max-width:900px){
      .search-row{grid-template-columns: 1fr 1fr; grid-auto-rows:minmax(44px,auto)}
    }
    .input, .select{
      background:var(--card); border:1px solid rgba(255,255,255,.08);
      border-radius:12px; padding:12px 14px; outline:none; width:100%;
      transition:border-color .12s ease, box-shadow .12s ease, transform .06s ease;
    }
    @media (prefers-color-scheme: light){
      .input, .select{border-color: rgba(16,24,40,.10)}
    }
    .input:focus, .select:focus{box-shadow:var(--ring); border-color:transparent}
    .btn{
      appearance:none; border:0; padding:12px 16px; border-radius:12px; cursor:pointer;
      background:linear-gradient(180deg, var(--brand), #00b8e6); color:#ffffff; font-weight:800;
      box-shadow:0 10px 30px rgba(10,124,255,.35);
      transition:transform .06s ease, filter .12s ease;
      display:inline-flex; align-items:center; gap:10px;
    }
    .btn:hover{filter:brightness(1.06)}
    .btn:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent; color:var(--brand); border:1px solid currentColor; box-shadow:none;
    }

    /* KPIs */
    .kpis{
      display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; margin-top:14px;
    }
    @media (max-width:720px){ .kpis{grid-template-columns:1fr}}
    .kpi{
      background:linear-gradient(180deg, var(--surface), var(--surface-2));
      border:1px solid rgba(255,255,255,.06); border-radius:16px; padding:14px;
      display:flex; align-items:center; gap:12px; box-shadow:var(--shadow-sm);
    }
    @media (prefers-color-scheme: light){ .kpi{border-color: rgba(16,24,40,.08)}}
    .kpi-icon{
      width:44px;height:44px;border-radius:12px;background:linear-gradient(180deg,var(--brand-2),var(--brand));display:grid;place-items:center;color:white;font-weight:900;box-shadow:inset 0 0 0 2px rgba(255,255,255,.14)
    }
    .kpi-title{font-size:12px; color:var(--muted); margin:0}
    .kpi-value{font-size:22px; font-weight:900; line-height:1}

    /* Categor√≠as destacadas */
    .section{
      padding-block: 22px 34px;
    }
    .section h2{
      margin:0 0 12px 0; font-size: clamp(20px, 3.5vw, 26px); letter-spacing:-.01em
    }
    .section p.lead{
      margin:0 0 16px 0; color:var(--muted)
    }
    .cat-grid{
      display:grid; grid-template-columns: repeat(6, minmax(0,1fr)); gap:12px;
    }
    @media (max-width:1100px){ .cat-grid{grid-template-columns: repeat(4,1fr)}}
    @media (max-width:760px){ .cat-grid{grid-template-columns: repeat(2,1fr)}}
    .cat-card{
      position:relative; overflow:hidden; border-radius:16px; background:linear-gradient(180deg,var(--surface), var(--surface-2));
      border:1px solid rgba(255,255,255,.06); min-height:120px; display:flex; flex-direction:column; justify-content:space-between;
      transition:transform .12s ease, box-shadow .12s ease, border-color .12s ease;
    }
    .cat-card:hover{transform:translateY(-3px); box-shadow:var(--shadow)}
    @media (prefers-color-scheme: light){ .cat-card{border-color: rgba(16,24,40,.08)}}
    .cat-media{
      height:64px; background:
        radial-gradient(120px 40px at 30% 40%, rgba(98,209,255,.25), transparent),
        radial-gradient(160px 50px at 70% 20%, rgba(10,124,255,.25), transparent);
      display:grid; place-items:center; color:#fff; font-size:28px; font-weight:800;
    }
    .cat-body{ padding:12px; display:flex; align-items:center; justify-content:space-between; gap:10px}
    .badge{
      font-size:11px; color:#fff; background:linear-gradient(180deg,var(--brand),#0069e6);
      border-radius:999px; padding:6px 10px; font-weight:700; letter-spacing:.2px; box-shadow:0 6px 14px rgba(10,124,255,.35)
    }

    /* Footer */
    footer.site{
      border-top:1px solid rgba(255,255,255,.08); padding-block:20px; color:var(--muted);
    }
    @media (prefers-color-scheme: light){ footer.site{border-top:1px solid rgba(16,24,40,.08)}}
    .f-row{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap}
    .f-links{display:flex; gap:10px; flex-wrap:wrap}
    .f-links a{padding:6px 10px; border-radius:10px}
    .f-links a:hover{background:var(--surface-2)}
    .mono{font-family:var(--mono); font-size:12px; opacity:.9}

    /* Utilities / helpers */
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .hide{display:none !important}
    .chip{
      display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px;
      background:var(--surface-2); border:1px solid rgba(255,255,255,.06); color:var(--muted); font-size:12px;
    }
    .skeleton{
      position:relative; overflow:hidden; background:linear-gradient(90deg, rgba(255,255,255,.06), rgba(255,255,255,.12), rgba(255,255,255,.06));
      animation: shimmer 1.2s infinite linear; border-radius:12px; min-height:120px;
    }
    @keyframes shimmer{
      0%{background-position:-200% 0}
      100%{background-position:200% 0}
    }

    /* Print minimal for fichas (faltante en bloques siguientes) */
    @media print{
      header.site, .section--home-only{display:none}
      body{background:white; color:#000}
    }
    a:focus,
a:focus-visible,
a:target {
  outline: none !important;
  box-shadow: none !important;
}
.nav-links a:focus,
.nav-links a:focus-visible,
.nav-links a:target {
  outline: none !important;
  box-shadow: none !important;
  background: transparent !important;
}
  </style>
  <style>
.form-container {
  background: var(--card-bg, #f5f8eb);
  border-radius: 24px;
  padding: 32px;
  width: 100%;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
}

.form-group { margin-bottom: 18px; }
label { display:block; font-weight:600; margin-bottom:6px; color: var(--text-color,#2d3748); }

input, textarea {
  width:100%;
  padding:12px 14px;
  border:2px solid #d4ed9f;
  border-radius:12px;
  background:#efffcd;
  color:#2d3748;
  font-family:inherit;
  font-size:15px;
  transition:all 0.25s ease;
}
input:focus, textarea:focus {
  border-color:#9ae66e;
  background:#f8ffe9;
  outline:none;
  box-shadow:0 0 0 3px rgba(154,230,110,0.15);
}
textarea { resize:vertical; min-height:120px; }

.checkbox-group {
  display:flex; align-items:center; gap:10px; margin:18px 0;
}
.checkbox-group input { width:18px; height:18px; accent-color:#48bb78; cursor:pointer; }

.button-group {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:10px;
  margin-bottom:16px;
}

.btn {
  border:none;
  border-radius:12px;
  font-size:15px;
  font-weight:700;
  padding:14px;
  cursor:pointer;
  transition:all 0.3s ease;
  color:rgb(255, 255, 255);
}
.btn-whatsapp {
  background:linear-gradient(135deg,#25D366,#128C7E);
}
.btn-whatsapp:hover { background:linear-gradient(135deg,#20bd5a,#0e7a69); transform:translateY(-2px); }
.btn-gmail {
  background:linear-gradient(135deg,#ea9935,#C5221F);
}
.btn-gmail:hover { background:linear-gradient(135deg,#d9842f,#b01e1a); transform:translateY(-2px); }

.info-box {
  background:white;
  border-left:4px solid #48bb78;
  padding:14px;
  border-radius:12px;
  font-size:13px;
  color:#555;
}
.badge {
  margin-top:14px;
  display:flex;
  align-items:center;
  gap:6px;
  background:white;
  border-radius:20px;
  padding:8px 14px;
  font-weight:600;
  font-size:13px;
  box-shadow:0 2px 8px rgba(0,0,0,0.1);
}
.star { color:#f6ad55; }
.error { border-color:#fc8181!important; background:#fff5f5!important; }
.error-message { color:#c53030; font-size:12px; display:none; }
</style>

</head>
<body>
  <style>
/* ============================================================
   Efecto de transici√≥n amigable al cargar / recargar
   ============================================================ */
body {
  opacity: 0;
  transition: opacity 0.6s ease-in-out;
}
body.mostrando {
  opacity: 1;
}
#overlay-transicion {
  position: fixed;
  inset: 0;
  background: radial-gradient(circle at center, rgba(10,124,255,0.15), rgba(0,0,0,0.8));
  opacity: 0;
  transition: opacity 0.6s ease-in-out;
  z-index: 9999;
  pointer-events: none;
}
#overlay-transicion.activo {
  opacity: 1;
}


.fav-icon {
  position: absolute;
  top: 680px;
  right: 32px;
  font-size: 50px;
  cursor: pointer;
  color: #f1b952;
  user-select: none;
  transition: transform 0.25s ease, color 0.25s ease;
}

.fav-icon.fav-active {
  color: #ffed4d;
  transform: scale(0.6);
}

.fav-icon:hover {
  transform: scale(0.8);
}


.redes-superiores {
  position: absolute;
  top: 10px;
  right: 20px;
  display: flex;
  gap: 10px;
  z-index: 50;
}

.redes-superiores a {
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: white;
  border-radius: 50%;
  box-shadow: 0 4px 10px rgba(0,0,0,0.15);
  transition: transform .18s ease;
}

.redes-superiores a:hover {
  transform: scale(1.15);
}

.redes-superiores img {
  width: 20px;
  height: 20px;
}
/* Ajuste para iconos que son im√°genes */
.cat-media img {
  width: 68px;
  height: 68px;
  object-fit: contain;
  
}
/* Soporte para iconos de imagen en categor√≠as */
.cat-media {
  height: 84px;
  background:
    radial-gradient(120px 40px at 30% 40%, rgba(98,209,255,.25), transparent),
    radial-gradient(160px 50px at 70% 20%, rgba(10,124,255,.25), transparent);
  display: grid;
  place-items: center;
  color: #fff;
  font-size: 48px;
  font-weight: 800;
}



/* Si prefieres mantener los colores originales, comenta o elimina el filter */
@media (prefers-color-scheme: light) {
  .cat-media img {
    filter: none; /* Mantener colores originales en modo claro */
  }
}
/* Si prefieres mantener los colores originales de la imagen, comenta la l√≠nea de filter */









/* ============================================
   FORMATO SIMPLE Y LIMPIO PARA DESCRIPCIONES
============================================ */

/* Contenedor principal de descripci√≥n */
#panelDesc .desc,
#panelDesc p.desc {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  font-size: 15px;
  line-height: 1.8;
  color: #4a5568;
  text-align: justify;
  margin: 0;
  padding: 0;
}

/* Espaciado entre p√°rrafos */
#panelDesc .desc br {
  display: block;
  content: "";
  margin-bottom: 14px;
}

/* Descripci√≥n de im√°genes de galer√≠a */
#imageDescriptionText {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
  font-size: 14px;
  line-height: 1.7;
  color: #5a6c7d;
  padding: 10px 14px;
  background: rgba(255, 255, 255, 0.5);
  border-radius: 8px;
  margin-top: 8px;
  text-align: left;
}

/* Sin cursivas ni florituras */
#imageDescriptionText.muted {
  color: #9ca3af;
  font-style: normal;
}

/* Negrita simple */
#panelDesc .desc strong,
#imageDescriptionText strong {
  font-weight: 600;
  color: #2d3748;
}

/* Responsive */
@media (max-width: 640px) {
  #panelDesc .desc {
    font-size: 14px;
    line-height: 1.7;
    text-align: left;
  }
  
  #imageDescriptionText {
    font-size: 13px;
  }
}

/* Para tema verde-suave */
[data-theme='suave'] #panelDesc .desc {
  color: #4b5a24;
}

[data-theme='suave'] #imageDescriptionText {
  color: #5a6c42;
  background: rgba(255, 255, 255, 0.6);
}

[data-theme='suave'] strong {
  color: #2e3220;
}
</style>
<script>
/* ============================================================
   Fallback de navegaci√≥n: recargar al cambiar de secci√≥n
   (Evita quedarse con la vista vac√≠a si los m√≥dulos no cargan)
   ============================================================ */

document.addEventListener('click', (ev) => {
  const a = ev.target.closest('a[href^="#/"]');
  if (a) {
    ev.preventDefault();
    const href = a.getAttribute('href');
    // Forzar el cambio de hash + recarga completa
    if (location.hash !== href) {
      location.hash = href;
    }
    // üîÅ Espera un instante y recarga la p√°gina
    setTimeout(() => {
      location.reload();
    }, 30);
  }
});
</script>
<script>
/* ============================================================
   Transici√≥n visual al navegar o recargar
   ============================================================ */
(function() {
  // Crear el overlay de transici√≥n si no existe
  let overlay = document.getElementById('overlay-transicion');
  if (!overlay) {
    overlay = document.createElement('div');
    overlay.id = 'overlay-transicion';
    document.body.appendChild(overlay);
  }

  // Mostrar transici√≥n al cargar la p√°gina
  window.addEventListener('DOMContentLoaded', () => {
    document.body.classList.add('mostrando');
    overlay.classList.remove('activo');
  });

  // Mostrar una breve animaci√≥n de salida antes de cambiar de secci√≥n
  window.addEventListener('hashchange', () => {
    overlay.classList.add('activo');
    document.body.classList.remove('mostrando');
    setTimeout(() => {
      document.body.classList.add('mostrando');
      overlay.classList.remove('activo');
    }, 400); // Duraci√≥n de la transici√≥n entre secciones
  });

  // Efecto tambi√©n al recargar
  window.addEventListener('pageshow', () => {
    document.body.classList.add('mostrando');
    overlay.classList.remove('activo');
  });
})();


</script>


<script>
/* ============================================================
   Simular un clic autom√°tico al cargar / navegar
   (elimina el borde blanco de foco en t√≠tulos o enlaces)
   ============================================================ */

(function() {
  function clickAutomatico() {
    try {
      // üîπ Simula un clic en el body
      const evt = new MouseEvent('click', {
        bubbles: true,
        cancelable: true,
        view: window
      });
      document.body.dispatchEvent(evt);

      // üîπ Tambi√©n quita cualquier foco visual activo
      if (document.activeElement && typeof document.activeElement.blur === 'function') {
        document.activeElement.blur();
      }

      // üîπ Borra cualquier selecci√≥n residual
      if (window.getSelection) {
        const sel = window.getSelection();
        if (sel && sel.removeAllRanges) sel.removeAllRanges();
      }
    } catch (e) {
      console.warn('clickAutomatico:', e);
    }
  }

  // Ejecutar al cargar y al cambiar de hash (navegar entre secciones)
  window.addEventListener('load', () => setTimeout(clickAutomatico, 50));
  window.addEventListener('hashchange', () => setTimeout(clickAutomatico, 50));
})();
</script>


    <a href="#app" class="skip-link">Saltar al contenido principal</a>

  <!-- ================= Header ================= -->
  <header class="site" role="banner">
    <div class="container nav" aria-label="Barra de navegaci√≥n principal">
      <a class="brand" href="#/" aria-label="Ir a inicio ImpulsoLocal">
        <span class="brand-logo" aria-hidden="true">IL</span>
        <span class="brand-title">Impulso Local Lima<span style="opacity:.65"></span></span>
      </a>

      <nav class="nav-links" aria-label="Accesos">
        <a href="#/categorias" title="Explorar por categor√≠as">Categor√≠as</a>
        <a href="#/favoritos" class="nav-minor">Favoritos</a>
        <a href="#/sobre" class="nav-minor">Sobre</a>
        
        <a href="#/registrar" class="nav-cta">Registrar negocio</a>
      </nav>
    </div>
  </header>

  <!-- ================= Main / Home ================= -->
  <main id="app" class="container" role="main">
    <!-- Home Section (se ocultar√° al navegar por hash-router) -->
    <section id="home" class="section section--home-only">
      <div class="hero">
        <div class="hero-grid">
          <div>
            <h1 class="hero-title">Impulsa tu negocio local. <br/>Encuentra y conecta con <span style="background:linear-gradient(180deg,var(--brand-2),var(--brand)); -webkit-background-clip:text; background-clip:text; color:transparent;">proveedores y servicios</span> cerca de ti.</h1>
            <p class="hero-sub">Busca por rubro, ubicaci√≥n o palabra clave. Listamos negocios locales con perfiles claros y formas de contacto.</p>
            <div class="search-card" role="search" aria-label="Buscador principal">
              <form id="searchForm" class="search-row" autocomplete="off">
                <label class="sr-only" for="q">Qu√© negocio buscas</label>
                <input id="q" name="q" class="input" placeholder="¬øQu√© est√°s buscando? (p. ej., ferreter√≠a, panader√≠a, marketing)" />

                <label class="sr-only" for="cat">Categor√≠a</label>
                <select id="cat" name="cat" class="select">
                  <option value="">Todas las categor√≠as</option>
                </select>

                <label class="sr-only" for="loc">Ubicaci√≥n</label>
                <select id="loc" name="loc" class="select">
                  <option value="">Todo el Per√∫</option>
                  <option>Lima</option>
                  <option>Arequipa</option>
                  <option>Trujillo</option>
                  <option>Piura</option>
                  <option>Cusco</option>
                </select>

                <button class="btn" id="btnSearch" type="submit" title="Buscar ahora">
                  üîé Buscar
                </button>
              </form>
              <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap">
                <span class="chip">M√°s buscados:</span>
                <button class="chip btn-ghost" data-quick="Panader√≠a">Panader√≠a</button>
                <button class="chip btn-ghost" data-quick="Veterinaria">Veterinaria</button>
                <button class="chip btn-ghost" data-quick="Ferreter√≠a">Ferreter√≠a</button>
                <button class="chip btn-ghost" data-quick="Dise√±o Web">Dise√±o Web</button>
              </div>
            </div>

            <div class="kpis" aria-label="Indicadores del directorio">
              <div class="kpi">
                <div class="kpi-icon">üè¢</div>
                <div>
                  <p class="kpi-title">Negocios registrados</p>
                  <div id="kpiEmpresas" class="kpi-value">‚Äî</div>
                </div>
              </div>
              <div class="kpi">
                <div class="kpi-icon">üóÇÔ∏è</div>
                <div>
                  <p class="kpi-title">Categor√≠as destacadas</p>
                  <div id="kpiCategorias" class="kpi-value">‚Äî</div>
                </div>
              </div>
              <div class="kpi">
                <div class="kpi-icon">üåü</div>
                <div>
                  <p class="kpi-title">Mejores promociones
                  <div  class="kpi-value">4</div>
                </div>
              </div>
            </div>
          </div>

          <aside aria-label="Ilustraci√≥n">
            <div style="aspect-ratio:4/3; border-radius:22px; overflow:hidden; background:
              radial-gradient(240px 120px at 30% 20%, rgba(98,209,255,.25), transparent),
              radial-gradient(240px 120px at 80% 10%, rgba(10,124,255,.25), transparent),
              linear-gradient(180deg,var(--surface), var(--surface-2));
              border:1px solid rgba(255,255,255,.06); box-shadow:var(--shadow-lg); position:relative;">
              <svg viewBox="0 0 600 450" width="100%" height="100%" preserveAspectRatio="xMidYMid slice" aria-hidden="true">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1">
                    <stop offset="0" stop-color="#62d1ff"/><stop offset="1" stop-color="#0a7cff"/>
                  </linearGradient>
                </defs>
                <rect x="0" y="0" width="600" height="450" fill="transparent"/>
                <g opacity="0.8">
                  <rect x="40" y="40" width="520" height="50" rx="12" fill="url(#g1)"/>
                  <rect x="40" y="110" width="360" height="42" rx="10" fill="rgba(255,255,255,.18)"/>
                  <rect x="410" y="110" width="150" height="42" rx="10" fill="rgba(255,255,255,.18)"/>
                  <rect x="40" y="170" width="160" height="42" rx="10" fill="rgba(255,255,255,.18)"/>
                  <rect x="210" y="170" width="160" height="42" rx="10" fill="rgba(255,255,255,.18)"/>
                  <rect x="380" y="170" width="180" height="42" rx="10" fill="rgba(255,255,255,.18)"/>
                </g>
                <g opacity="0.9">
                  <rect x="40" y="238" width="160" height="140" rx="16" fill="rgba(255,255,255,.08)"/>
                  <rect x="220" y="238" width="160" height="140" rx="16" fill="rgba(255,255,255,.08)"/>
                  <rect x="400" y="238" width="160" height="140" rx="16" fill="rgba(255,255,255,.08)"/>
                </g>
              </svg>
            </div>
          </aside>
        </div>
      </div>

      <div class="section" id="sectionCats">
        <h2>Categor√≠as destacadas</h2>
        <p class="lead">Explora los rubros m√°s consultados por la comunidad. Haz clic para ver negocios.</p>
        <div class="cat-grid" id="catGrid" aria-live="polite">
          <!-- Skeletons iniciales -->
          <div class="cat-card skeleton"></div>
          <div class="cat-card skeleton"></div>
          <div class="cat-card skeleton"></div>
          <div class="cat-card skeleton"></div>
          <div class="cat-card skeleton"></div>
          <div class="cat-card skeleton"></div>
        </div>
      </div>
    </section>

    <!-- Contenedores para otras vistas (se poblar√°n en bloques siguientes) -->
    <section id="view-listado" class="section hide" aria-live="polite"></section>
    <section id="view-ficha" class="section hide" aria-live="polite"></section>
    <section id="view-static" class="section hide" aria-live="polite"></section>
  </main>

  <!-- ================= Footer ================= -->
  <footer class="site" role="contentinfo">
    <div class="container f-row">
      <div>¬© <span id="year"></span> <strong>ImpulsoLocal</strong> ¬∑ Directorio de negocios locales</div>
      <nav class="f-links" aria-label="Informaci√≥n">
        <a href="#/sobre">Sobre</a>
        <a href="#/terminos">T√©rminos</a>
        <a href="#/privacidad">Privacidad</a>
        <a href="#/contacto">Contacto</a>
      </nav>
      <div class="mono">v2.4 ¬∑ </div>
    </div>
  </footer>

  <!-- ================= Scripts ================= -->

  
  <script>
    // ============================================
    // ImpulsoLocal ‚Äî Bloque 1 JS
    // Esqueleto de datos, utilidades m√≠nimas, Home
    // ============================================

    // --- Datos seed (ficticios) ---
    const DATA = {
      categorias: [
        { id:'servicios-profesionales', nombre:'Servicios', icon:'images/14773849.png', total:0 },
        { id:'comida-bebida',           nombre:'Alimentos y Bebidas',       icon:'images/alimentos2.png', total:0 },
        { id:'hogar-ferreteria',        nombre:'Hogar',    icon:'images/4203528.png', total:0 },
        { id:'salud-belleza',           nombre:'Salud y Bienestar',       icon:'images/1970972.png', total:0 },
        { id:'tecnologia',              nombre:'Productos Digitales y Tecnolog√≠a',            icon:'images/productodigital.webp', total:0 },
        { id:'mascotas',                nombre:'Mascotas',              icon:'images/3047928.png', total:0 },
        { id:'alquileres-espacios',    nombre:'Alquileres y Espacios',            icon:'images/3524895.png', total:0 },
        { id:'educacion',               nombre:'Educaci√≥n',             icon:'images/3557635.png', total:0 },
        { id:'ropa-accesorios',               nombre:'Ropa y Accesorios',             icon:'images/7695898.png', total:0 },
      ],
      empresas: [
        { id:'e-001', nombre:'Jard√≠n de Ida', cat:'comida-bebida', loc:'San Miguel', verificada:true, cover: 'images/anturio blanco.webp', 
          // ‚≠ê NUEVO: Slogan personalizado
      slogan: 'Verde que inspira, vida que florece.',
         // ‚≠ê NUEVO: Banner superior
      banner: 'images/width_8001 (1).jpeg', // ‚Üê agrega esta l√≠nea

      // ‚≠ê NUEVO: Logo personalizado
      logo: 'images/6144736inspiraci√≥n.png', // ruta de tu imagen
      imgpresentacion: 'images/width_800.jpeg',
        galeria: [                            
        'images/anturio blanco.webp',
        'images/anturio rojo.jpeg', 
        'images/orquidea-phalaenopsis-blancas-bs.jpg',
        'images/orquideas-rosas-bs_negra_1_1_1.png',
        'images/width_800.jpeg',
        'images/wmremove-transformed (1).jpeg',
        
      ],

      descripciones: [
  'ü•§‚ú® ¬°Refresca tu d√≠a con la mejor Chicha Morada! ‚ú®ü•§<br><br>‚û°Ô∏è Se vende Chicha Morada casera, natural y deliciosa.<br>üìå Precio: S/ 5 el litro<br>‚úÖ 100% hecha en casa, con ma√≠z morado y fruta fresca.<br>Atenci√≥n de lunes a sabado ‚Ä¶ <br>Escr√≠benos al interno .<br>Ahora en envase no retornable...',
  'Anturio rojo vibrante en maceta cl√°sica.',
  'Orqu√≠dea Phalaenopsis blanca, elegante y delicada.',
  'Orqu√≠deas rosas en maceta negra moderna.',
  'Arreglo floral en tonos pastel.',
  'Composici√≥n art√≠stica con flores tropicales.',
],
      descripcion:[
        
        'Amamos las plantas.<br><br> Creemos que no solo son flores: son una forma de conexi√≥n, un s√≠mbolo de calma, belleza y equilibrio en medio del ritmo agitado de la ciudad.<br><br> Surgimos con una idea simple: acercar la elegancia natural de las orqu√≠deas y los anturios a cada rinc√≥n del hogar o espacio de trabajo. Sabemos que, a veces, basta una flor bien colocada para transformar no solo un ambiente‚Ä¶ sino tambi√©n un estado de √°nimo.',
        'Desde Lima, nos dedicamos a cuidar y seleccionar orqu√≠deas con dedicaci√≥n, para que t√∫ puedas disfrutarlas con la confianza de que est√°s recibiendo algo m√°s que una planta: est√°s recibiendo vida, detalle y prop√≥sito',
        
        
        '<br>Porque cada orqu√≠dea tiene su historia, y queremos que la tuya tambi√©n florezca.'
      ],
    
      horario: [
        { d: 'Lunes', h: '07:00‚Äì20:00' },
        { d: 'Martes', h: '07:00‚Äì20:00' },
        { d: 'Mi√©rcoles', h: '07:00‚Äì20:00' },
        { d: 'Jueves', h: '07:00‚Äì20:00' },
        { d: 'Viernes', h: '07:00‚Äì21:00' },
        { d: 'S√°bado', h: '08:00‚Äì18:00' },
        { d: 'Domingo', h: '08:00‚Äì14:00' }
      ],
      servicios: [
        'Venta al detall',
        'Delivery local',
        'Pedidos por encargo'
      ],
      descrip:[
        'Encuentra nuestro cat√°logo y escr√≠benos, estamos listos para ayudarte con cari√±o y detalle <br>.'
      ],
       // üî• NUEVAS REDES SOCIALES
      facebook: "https://www.facebook.com/ida.gaona.leon",
      instagram: "https://instagram.com/jardin.ida",
      tiktok: "https://www.tiktok.com/@jardin.ida",

      telefono: '+51 903322709',
      email: 'ilasacaowen@gmail.com',
      direccion: 'Av. Ejemplo 123, San Miguel',
      web: 'https://gaseosero.exampe',
      map: 'https://www.google.com/maps/embed?pb=!1m14!1m8!1m3!1d1950.8623994878822!2d-77.0941373!3d-12.0624464!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x9105c9f077b674c1%3A0x1c33b1a3d32d6609!2sAlto%20Venezuela%20%7C%20Imagina%20Inmobiliaria!5e0!3m2!1ses!2spe!4v1761437748692!5m2!1ses!2spe',
      
        },

        { id:'e-002', nombre:'VetCare San Miguel',       cat:'mascotas',      loc:'Lima',    verificada:false },
        { id:'e-003', nombre:'FerrePlus Pueblo Libre',   cat:'hogar-ferreteria', loc:'Lima',  verificada:true },
        { id:'e-004', nombre:'Innova Web Studio',        cat:'tecnologia',    loc:'Arequipa',  verificada:true },
        { id:'e-005', nombre:'Cl√≠nica Sonrisa',          cat:'salud-belleza', loc:'Trujillo',  verificada:false },
        { id:'e-006', nombre:'Abogados Andinos',         cat:'servicios-profesionales', loc:'Lima',  verificada:false, 
          telefono: '+51 936620504',
          email: 'pasosdeungm@gmail.com',
          
        },
        { id:'e-007', nombre:'AutoGlass Express',        cat:'automotriz', loc:'Lima',   verificada:true },
        { id:'e-008', nombre:'Academia Brillante',       cat:'educacion', loc:'Piura',   verificada:false },
        { id:'e-009', nombre:'Caf√© Origen Norte',        cat:'comida-bebida', loc:'Piura',   verificada:false },
      ]
    };

    // Completar conteos por categor√≠a
    (function hydrateCategoryTotals(){
      const byCat = {};
      for(const e of DATA.empresas){
        byCat[e.cat] = (byCat[e.cat]||0)+1;
      }
      for(const c of DATA.categorias){
        c.total = byCat[c.id]||0;
      }
    })();

    // --- Helpers m√≠nimos ---
    const $ = sel => document.querySelector(sel);
    const $$ = sel => Array.from(document.querySelectorAll(sel));

    function numberFmt(n){
      return new Intl.NumberFormat('es-PE',{maximumFractionDigits:0}).format(n);
    }

    function navigateTo(hash){
  if(location.hash !== hash) {
    location.hash = hash;
  } else {
    Router.dispatch(); // üëà fuerza render inmediato si es el mismo hash
  }
}

    // --- Render Home: KPIs y Categor√≠as ---
    function renderKPIs(){
      $('#kpiEmpresas').textContent = numberFmt(DATA.empresas.length);
      $('#kpiCategorias').textContent = numberFmt(DATA.categorias.length);
      
    }

    function renderCategoryOptions(){
      const sel = $('#cat');
      let opts = '<option value="">Todas las categor√≠as</option>';
      for(const c of DATA.categorias){
        opts += `<option value="${c.id}">${c.nombre}</option>`;
      }
      sel.innerHTML = opts;
    }

    function catCardTemplate(c){
  const href = `#/categoria/${c.id}`;
  const iconHtml = renderIcon(c.icon, '80px'); // üëà Usa la funci√≥n helper
  
  return `
  <a class="cat-card" href="${href}" data-cat="${c.id}" title="Ver ${c.nombre}">
    <div class="cat-media">${iconHtml}</div>
    <div class="cat-body">
      <div>
        <div style="font-weight:800">${c.nombre}</div>
        <div style="font-size:12px; color:var(--muted)">${numberFmt(c.total)} negocios</div>
      </div>
      <span class="badge">Explorar</span>
    </div>
  </a>`;
}

    function renderCategoryPreview(){
      const grid = $('#catGrid');
      grid.innerHTML = DATA.categorias.slice(0.9).map(catCardTemplate).join('');
    }

    // --- B√∫squeda (solo navegaci√≥n; resultados en bloques siguientes) ---
    function onSearchSubmit(ev){
      ev.preventDefault();
      const q = ($('#q').value || '').trim();
      const cat = $('#cat').value;
      const loc = $('#loc').value;
      const params = new URLSearchParams();
      if(q) params.set('q', q);
      if(cat) params.set('cat', cat);
      if(loc) params.set('loc', loc);
      navigateTo(`#/buscar?${params.toString()}`);
    }

    function onQuickChip(ev){
      const el = ev.target.closest('[data-quick]');
      if(!el) return;
      $('#q').value = el.getAttribute('data-quick');
      $('#cat').value = '';
      $('#loc').value = '';
      $('#btnSearch').focus();
    }

    // --- Router m√≠nimo (placeholder) ---
    function hideAllViews(){
      $('#home').classList.add('hide');
      $('#view-listado').classList.add('hide');
      $('#view-ficha').classList.add('hide');
      $('#view-static').classList.add('hide');
    }

    

    // --- Init ---
    document.addEventListener('DOMContentLoaded', () => {
      // A√±o footer
      $('#year').textContent = new Date().getFullYear();

      // Home
      renderKPIs();
      renderCategoryOptions();
      renderCategoryPreview();

      // Eventos
      $('#searchForm').addEventListener('submit', onSearchSubmit);
      document.body.addEventListener('click', onQuickChip);

      // Router
      
    });
  </script>
  <!-- ======= BLOQUE 2: Router avanzado + Plantillas + Buscador/Utils ======= -->
<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 2
   Router con rutas con par√°metros, mini motor de plantillas,
   utilidades (debounce, normalizador), y buscador cliente.
   ============================================================ */

/* ---------- Helpers de strings / normalizaci√≥n ---------- */
const Str = (() => {
  const rmDiacritics = s => s.normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  const toSearch = s => rmDiacritics(String(s||'').toLowerCase().trim().replace(/\s+/g,' '));
  const slug = s => toSearch(s).replace(/[^a-z0-9\s-]/g,'').replace(/\s+/g,'-').replace(/-+/g,'-').replace(/^-|-$/g,'');
  const clamp = (n,min,max) => Math.max(min, Math.min(max, n));
  return { rmDiacritics, toSearch, slug, clamp };
})();

/* ---------- Debounce / Throttle ---------- */
function debounce(fn, wait=250){
  let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn.apply(null,args), wait); };
}
function throttle(fn, wait=200){
  let t=0; return (...args)=>{ const now=Date.now(); if(now-t>=wait){ t=now; fn.apply(null,args);} };
}

/* ---------- Mini templating ({{prop}} y {{=expr}}) ---------- */
function tpl(str, ctx={}){
  return String(str).replace(/\{\{\s*([^}]+)\s*\}\}/g, (_, key) => {
    try{
      if(key.startsWith('=')){ /* expresi√≥n JS: {{= a + b}} */
        return Function(...Object.keys(ctx), `return (${key.slice(1)})`).apply(null, Object.values(ctx)) ?? '';
      }
      const path = key.split('.'); let v = ctx;
      for(const p of path){ v = v?.[p]; if(v==null) break; }
      return v ?? '';
    }catch{ return ''; }
  });
}

/* ---------- Render util (reemplazo seguro) ---------- */
function renderHTML(el, html){
  if(!el) return;
  el.innerHTML = html;
}

/* ---------- Toasts livianos ---------- */
const Toast = (() => {
  let holder;
  function ensure(){
    if(!holder){
      holder = document.createElement('div');
      holder.style.position='fixed';
      holder.style.inset='auto 0 24px 0';
      holder.style.display='grid';
      holder.style.placeItems='center';
      holder.style.pointerEvents='none';
      holder.style.zIndex='60';
      document.body.appendChild(holder);
    }
  }
  function show(msg, type='info'){
    ensure();
    const card = document.createElement('div');
    card.textContent = msg;
    card.style.pointerEvents='auto';
    card.style.maxWidth='92vw';
    card.style.background='var(--surface)';
    card.style.border='1px solid rgba(255,255,255,.10)';
    card.style.padding='10px 14px';
    card.style.borderRadius='12px';
    card.style.boxShadow='var(--shadow)';
    card.style.color= type==='error' ? 'var(--err)' : (type==='ok' ? 'var(--ok)' : 'inherit');
    card.style.margin='8px';
    holder.appendChild(card);
    setTimeout(()=>card.remove(), 2500);
  }
  return { show };
})();

/* ---------- Loading skeleton helpers ---------- */
function setLoadingGrid(el, count=6){
  if(!el) return;
  el.innerHTML = Array.from({length:count}).map(()=>'<div class="skeleton" style="min-height:120px;border-radius:16px"></div>').join('');
}

/* ---------- Query string utils ---------- */
function parseQS(qs=''){
  const out = {};
  const sp = new URLSearchParams(qs.startsWith('?')? qs.slice(1) : qs);
  for(const [k,v] of sp.entries()){ out[k]=v; }
  return out;
}
function toQS(obj){
  const sp = new URLSearchParams();
  Object.entries(obj||{}).forEach(([k,v])=>{ if(v!=null && v!=='') sp.set(k,v); });
  const s = sp.toString();
  return s ? `?${s}` : '';
}

/* ---------- Paginaci√≥n ---------- */
function paginate(arr, page=1, per=12){
  const total = arr.length;
  const pages = Math.max(1, Math.ceil(total/per));
  const p = Str.clamp(page, 1, pages);
  const start = (p-1)*per;
  const slice = arr.slice(start, start+per);
  return { items: slice, page: p, pages, per, total, start, end: start + slice.length };
}

/* ---------- √çndice de b√∫squeda ---------- */
const Search = (() => {
  let INDEX = [];
  function buildIndex(){
    INDEX = DATA.empresas.map(e => ({
      id: e.id,
      cat: e.cat,
      loc: e.loc,
      rating: e.rating||0,
      reviews: e.reviews||0,
      verificada: !!e.verificada,
      name: e.nombre,
      imgpresentacion: e.imgpresentacion || null,
      
      descrip: e.descrip|| '',
       logo: e.logo || null,
       slogan: e.slogan || '',
       breve: e.breve || '',
       subcat: e.subcat || '',
      text: Str.toSearch([e.nombre, e.loc, e.cat].join(' ')),
    }));
  }
  function byRank(a,b){
    // Orden: verificada desc, rating desc, reviews desc, nombre asc
    if(+b.verificada - +a.verificada !== 0) return +b.verificada - +a.verificada;
    if(b.rating - a.rating !== 0) return b.rating - a.rating;
    if(b.reviews - a.reviews !== 0) return b.reviews - a.reviews;
    return a.name.localeCompare(b.name,'es');
  }
  function matchQuery(q){
    if(!q) return () => true;
    const qq = Str.toSearch(q);
    const terms = qq.split(' ').filter(Boolean);
    return (row)=>{
      const txt = row.text;
      return terms.every(t => txt.includes(t));
    };
  }
  function search({q='', cat='', loc='', sort='rank'}={}){
    let rows = INDEX.slice();
    const predicate = matchQuery(q);
    rows = rows.filter(r => predicate(r));
    if(cat) rows = rows.filter(r => r.cat===cat);
    if(loc) rows = rows.filter(r => r.loc===loc);
    if(sort==='alpha'){ rows.sort((a,b)=>a.name.localeCompare(b.name,'es')); }
    else if(sort==='rating'){ rows.sort((a,b)=> (b.rating - a.rating) || (b.reviews - a.reviews)); }
    else { rows.sort(byRank); }
    return rows;
  }
  // Inicializa al cargar
  buildIndex();
  return { buildIndex, search };
})();

/* ---------- Componente Breadcrumbs (migas) ---------- */
function breadcrumbs(items){
  const parts = items.map((it,i)=>{
    const isLast = i===items.length-1;
    return `<a ${it.href && !isLast ? `href="${it.href}"`:'role="link"'} class="chip" style="text-decoration:none;${isLast?'opacity:.9;font-weight:700':''}">
      ${it.icon? it.icon+' ' : ''}${it.label}
    </a>`;
  }).join(' ');
  return `<nav aria-label="migas" style="display:flex;gap:8px;flex-wrap:wrap">${parts}</nav>`;
}

/* ---------- Tarjeta de empresa (compacta) ---------- */
function companyCard(e){
  const badge = e.verificada ? `<span class="badge" title="Empresa verificada">Verificada</span>` : '';
  const revs = `<span class="chip" >${e.reviews ?? 0} </span>`;
  const loc = `<span class="chip" title="Ubicaci√≥n">üìç ${e.loc}</span>`;
  
  // ‚úÖ Logo REAL como en la ficha
  const logo = e.logo || null;
  const icon = e.icon || 'üè¢';
  
  const logoHtml = logo && logo.trim() 
    ? `<img src="${logo}" alt="Logo de ${e.nombre}" loading="lazy" 
         style="width:100%;height:100%;object-fit:cover;border-radius:12px;background:white;padding:4px;"
         onerror="this.style.display='none';this.nextElementSibling.style.display='block';">
       <div style="display:none;font-size:32px;">${icon}</div>`
    : `<div style="font-size:32px;">${icon}</div>`;
  
  return `
  <article class="card-company">
    <header class="card-head">
      <div class="card-logo" style="width:60px;height:60px;border-radius:12px;display:grid;place-items:center;background:conic-gradient(from 180deg,var(--brand),var(--brand-2),var(--brand));box-shadow:inset 0 0 0 2px rgba(255,255,255,.14);flex-shrink:0;">
        ${logoHtml}
        ${e.verificada ? '<span style="position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;background:linear-gradient(135deg,#10b981,#34d399);border-radius:50%;display:grid;place-items:center;font-size:11px;box-shadow:0 2px 6px rgba(16,185,129,.4);border:2px solid white;z-index:2;">‚úì</span>' : ''}
      </div>
      <div class="card-title">
        <a href="#/empresa/${e.id}" style="font-weight:900;letter-spacing:.2px">${e.nombre}</a>
        ${e.slogan ? `<p class="empresa-slogan" style="font-size:13px;font-style:italic;color:var(--muted);margin:4px 0 6px 0;line-height:1.3;font-weight:500;">${e.slogan}</p>` : ''}
        <div class="card-badges">${badge}</div>
      </div>
    </header>
    <div class="card-body">
      <p style="margin:0;color:var(--muted);font-size:13px">${e.breve||'Negocio local cercano a ti.'}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">${revs}${loc}</div>
      <div class="card-actions">
        <a class="btn" href="#/empresa/${e.id}">Ver m√°s</a>
        <a class="btn btn-ghost" href="#/categoria/${e.cat}">Ver categor√≠a</a>
      </div>
    </div>
  </article>`;
}

/* ---------- Grilla de resultados (reutilizable) ---------- */
function renderGrid(list, targetSel){
  const target = typeof targetSel==='string' ? document.querySelector(targetSel) : targetSel;
  if(!target) return;
  if(!list?.length){
    target.innerHTML = `
      <div class="section">
        <h3>Sin resultados</h3>
        <p class="lead">No encontramos negocios que coincidan. Ajusta los filtros o intenta con otras palabras.</p>
        <a href="#/" class="btn">‚¨Ö Volver al inicio</a>
      </div>`;
    return;
  }
  
  // ‚úÖ Renderizar cada empresa con logo y slogan
  const html = list.map(e => {
    const badge = e.verificada ? `<span class="badge">Verificada</span>` : '';
    const logo = e.logo || null;
    const icon = e.icon || 'üè¢';
    
    // Logo HTML
    const logoHtml = logo && logo.trim() 
      ? `<img src="${logo}" alt="${e.nombre}" 
           style="width:100%;height:100%;object-fit:cover;border-radius:12px;background:white;padding:4px;"
           onerror="this.style.display='none';this.nextElementSibling.style.display='grid';">
         <span style="display:none;font-size:32px;">${icon}</span>`
      : `<span style="font-size:32px;">${icon}</span>`;
    
    return `
    <article class="card-company">
      <header class="card-head">
        <div class="card-logo" style="width:64px;height:64px;border-radius:14px;overflow:hidden;display:grid;place-items:center;background:conic-gradient(from 180deg,var(--brand),var(--brand-2),var(--brand));box-shadow:inset 0 0 0 2px rgba(255,255,255,.14);position:relative;flex-shrink:0;">
          ${logoHtml}
          ${e.verificada ? '<span style="position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;background:linear-gradient(135deg,#10b981,#34d399);border-radius:50%;display:grid;place-items:center;font-size:11px;color:white;">‚úì</span>' : ''}
        </div>
        <div class="card-title" style="flex:1;">
          <a href="#/empresa/${e.id}" style="font-weight:900;">${e.nombre}</a>
          ${e.slogan ? `<div style="font-size:13px;font-style:italic;color:var(--muted);margin-top:4px;">${e.slogan}</div>` : ''}
          <div class="card-badges">${badge}</div>
        </div>
      </header>
      <div class="card-body">
        <p style="margin:0;color:var(--muted);font-size:13px;">${e.breve || 'Negocio local'}</p>
        <div style="margin-top:8px;">
          <span class="chip">üìç ${e.loc}</span>
        </div>
        <div class="card-actions" style="margin-top:10px;">
          <a class="btn" href="#/empresa/${e.id}">Ver m√°s</a>
          <a class="btn btn-ghost" href="#/categoria/${e.cat}">Ver categor√≠a</a>
        </div>
      </div>
    </article>`;
  }).join('');
  
  target.innerHTML = `<div class="cat-grid">${html}</div>`;
}

/* ---------- Controles de paginaci√≥n ---------- */
function pagerControls(state, onNav){
  const {page,pages} = state;
  const btn = (p,label,disabled=false)=>`
    <button class="btn ${disabled?'btn-ghost':''}" data-page="${p}" ${disabled?'disabled':''} style="min-width:46px">${label}</button>`;
  const range = [];
  const start = Math.max(1, page-2);
  const end = Math.min(pages, page+2);
  for(let i=start;i<=end;i++){ range.push(i); }
  const html = `
    <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:flex-end;margin-top:14px">
      ${btn(page-1,'‚Äπ', page<=1)}
      ${range.map(i => btn(i, i, i===page)).join('')}
      ${btn(page+1,'‚Ä∫', page>=pages)}
    </div>`;
  const wrap = document.createElement('div');
  wrap.innerHTML = html;
  wrap.addEventListener('click', (ev)=>{
    const p = Number(ev.target?.dataset?.page||0);
    if(p){ onNav(p); }
  }, {once:false});
  return wrap.firstElementChild;
}

/* ---------- Router con patrones ---------- */
const Router = (() => {
  const routes = [];
  function pathToRegex(path){
    const keys = [];
    const regexStr = path.replace(/\/:\w+/g, (m)=>{ keys.push(m.slice(2)); return '/([^/]+)'; });
    return { regex: new RegExp(`^${regexStr}$`), keys };
  }
  function add(path, handler){
    const {regex, keys} = pathToRegex(path);
    routes.push({ path, regex, keys, handler });
  }
  function match(pathname){
    for(const r of routes){
      const m = pathname.match(r.regex);
      if(m){
        const params = {};
        r.keys.forEach((k, i)=> params[k] = decodeURIComponent(m[i+1]||''));
        return { handler: r.handler, params };
      }
    }
    return null;
  }
  function go(hash){
  if (location.hash !== hash) {
    location.hash = hash;
  } else {
    dispatch(); // üîß ejecuta el render inmediato si es el mismo hash
  }
}
  function dispatch(){
    const raw = location.hash || '#/';
    const [p, qs] = raw.replace(/^#/, '').split('?');
    const found = match(p||'/');
    hideAllViews();
    if(found){
      const ctx = { path:p||'/', qs: parseQS(qs||''), params: found.params };
      found.handler(ctx);
    }else{
      // 404 ‚Üí est√°tica simple
      $('#view-static').classList.remove('hide');
      renderHTML($('#view-static'), `<h2>P√°gina no encontrada</h2><p><a href="#/">Volver</a></p>`);
    }
  }
  window.addEventListener('hashchange', dispatch);
  return { add, go, dispatch };

})();

/* ---------- Vistas (handlers de rutas) ---------- */
function viewHome(){
  $('#home').classList.remove('hide');
}
function viewBuscar(ctx){
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);
  const { q='', cat='', loc='', sort='rank', page='1' } = ctx.qs;
  const rows = Search.search({ q, cat, loc, sort });
  const state = paginate(rows, Number(page)||1, 12);
  const title = `
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
      <div>
        <h2 style="margin:0">Resultados de b√∫squeda</h2>
        <p class="lead" style="margin:4px 0 0 0"><strong>${state.total}</strong> resultados
          ${q? ` para "<span class="mono">${q.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>"` : ''}</p>
      </div>
      <div>
        <label class="sr-only" for="sortSel">Ordenar</label>
        <select id="sortSel" class="select">
          <option value="rank"${sort==='rank'?' selected':''}>Relevancia</option>
          <option value="rating"${sort==='rating'?' selected':''}>Mejor calificados</option>
          <option value="alpha"${sort==='alpha'?' selected':''}>A‚ÄìZ</option>
        </select>
      </div>
    </div>
    ${breadcrumbs([
      {label:'Inicio', href:'#/', icon:'üè†'},
      {label:'Buscar', href:`#/buscar${toQS({q,cat,loc,sort,page})}`}
    ])}
  `;
  // Render de contenido
  setTimeout(()=>{ // peque√±o retardo para que se aprecie el skeleton
    container.innerHTML = title + `<div id="gridRes" class="section" style="padding-top:12px"></div>`;
    renderGrid(state.items, '#gridRes');
    const pag = pagerControls(state, (p)=>{
      const qs = toQS({ q, cat, loc, sort, page: p });
      Router.go(`#/buscar${qs}`);
    });
    container.appendChild(pag);
    $('#sortSel').addEventListener('change', (e)=>{
      const qs2 = toQS({ q, cat, loc, sort: e.target.value, page: 1 });
      Router.go(`#/buscar${qs2}`);
    });
  }, 240);
}
function viewCategoria(ctx){
  const { id } = ctx.params;
  const cat = DATA.categorias.find(c=>c.id===id);
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);
  const all = Search.search({ q:'', cat:id, loc: ctx.qs.loc||'', sort: ctx.qs.sort || 'rank' });
  const state = paginate(all, Number(ctx.qs.page||1), 12);
  setTimeout(()=>{
    const header = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h2 style="margin:0">${cat? cat.nombre : 'Categor√≠a'}</h2>
          <p class="lead" style="margin:4px 0 0 0">${state.total} negocios</p>
        </div>
        <div>
          <select id="sortCat" class="select">
            <option value="rank"${(ctx.qs.sort||'rank')==='rank'?' selected':''}>Relevancia</option>
            <option value="rating"${ctx.qs.sort==='rating'?' selected':''}>Mejor calificados</option>
            <option value="alpha"${ctx.qs.sort==='alpha'?' selected':''}>A‚ÄìZ</option>
          </select>
        </div>
      </div>
      ${breadcrumbs([
        {label:'Inicio', href:'#/', icon:'üè†'},
        {label:'Categor√≠as', href:'#/categorias', icon:'üóÇÔ∏è'},
        {label: cat? cat.nombre : id }
      ])}
    `;
    container.innerHTML = header + `<div id="gridCat" class="section" style="padding-top:12px"></div>`;
    renderGrid(state.items, '#gridCat');
    const pag = pagerControls(state, (p)=>{
      const qs = toQS({ page: p, sort: ctx.qs.sort||'rank', loc: ctx.qs.loc||'' });
      Router.go(`#/categoria/${id}${qs}`);
    });
    container.appendChild(pag);
    $('#sortCat').addEventListener('change', (e)=>{
      const qs2 = toQS({ page:1, sort: e.target.value, loc: ctx.qs.loc||'' });
      Router.go(`#/categoria/${id}${qs2}`);
    });
  }, 220);
}




/* ---------- Registrar rutas (VERSI√ìN FINAL Y DIRECTA) ---------- */
Router.add('/',        () => viewHome());
Router.add('/buscar',  (ctx) => viewBuscarV4(ctx)); // Usa la V4 del Bloque 4
Router.add('/categorias', () => viewCategoriasHub()); // Usa la del Bloque 3
Router.add('/categoria/:id', (ctx) => viewCategoriaV4(ctx)); // Usa la V4 del Bloque 4

// --- Reemplazo directo de placeholders ---
// En lugar de llamar a viewEmpresa y viewStatic, llamamos directamente a las funciones de los Bloques 5 y 6
Router.add('/empresa/:id',   (ctx) => viewEmpresaV5(ctx));
Router.add('/sobre',     () => viewSobre());
Router.add('/terminos',  () => viewTerminos());
Router.add('/privacidad',() => viewPrivacidad());
Router.add('/favoritos',   () => viewFavoritos());
Router.add('/registrar', () => viewRegistrar());

/* ---------- Integraci√≥n con el buscador del Home ---------- */
(function enhanceHomeSearch(){
  const input = $('#q');
  if(!input) return;

  // Autocomplete simple (chips din√°micos basados en DATA)
  let hintBox;
  function ensureHint(){
    if(hintBox) return hintBox;
    hintBox = document.createElement('div');
    hintBox.setAttribute('role','listbox');
    hintBox.style.position='absolute';
    hintBox.style.background='var(--surface)';
    hintBox.style.border='1px solid rgba(255,255,255,.08)';
    hintBox.style.borderRadius='12px';
    hintBox.style.boxShadow='var(--shadow)';
    hintBox.style.marginTop='6px';
    hintBox.style.padding='6px';
    hintBox.style.zIndex='40';
    hintBox.style.display='none';
    input.parentElement.style.position='relative';
    input.parentElement.appendChild(hintBox);
    document.addEventListener('click', (ev)=>{
      if(!hintBox.contains(ev.target) && ev.target!==input){ hintBox.style.display='none'; }
    });
    return hintBox;
  }

  function renderHints(value){
    const hb = ensureHint();
    const q = value.trim();
    if(!q){ hb.style.display='none'; return; }
    const list = Search.search({ q }).slice(0,6);
    if(!list.length){ hb.style.display='none'; return; }
    hb.innerHTML = list.map(r=>`
      <button type="button" role="option" class="chip" style="width:100%;justify-content:flex-start;margin:2px 0" data-fill="${r.name}">
        üîé ${r.name} ¬∑ <span class="mono" style="opacity:.8">${r.loc}</span>
      </button>`).join('');
    hb.style.display='block';
    hb.onclick = (e)=>{
      const b = e.target.closest('[data-fill]');
      if(!b) return;
      input.value = b.dataset.fill;
      hb.style.display='none';
      $('#btnSearch').click();
    };
  }

  input.addEventListener('input', debounce((e)=> renderHints(e.target.value), 180));
})();

/* ---------- Exponer App (para pr√≥ximos bloques) ---------- */
window.App = {
  Router, Search, tpl, renderHTML, Str, paginate, renderGrid,
  Toast, parseQS, toQS
};

// Despachar ruta actual (sobrescribe el renderRoute simple del bloque 1)
document.addEventListener('DOMContentLoaded', () => {
  Router.dispatch();
});


</script>
<!-- ======= BLOQUE 3: Listados por Categor√≠a + Grid + Filtros + Paginaci√≥n UI ======= -->
<style>
  /* ==========================
     Bloque 3 ‚Äî Estilos de listados
     ========================== */

  /* Toolbar de filtros/orden */
  .toolbar{
    display:flex; align-items:center; justify-content:space-between;
    gap:12px; flex-wrap:wrap; background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .toolbar{border-color: rgba(16,24,40,.08)}}
  .toolbar .left, .toolbar .right{
    display:flex; align-items:center; gap:8px; flex-wrap:wrap;
  }
  .pill{
    display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px;
    border:1px solid rgba(255,255,255,.08); background:var(--surface-2); color:var(--muted); font-size:13px;
  }
  @media (prefers-color-scheme: light){ .pill{border-color: rgba(16,24,40,.08)}}
  .pill strong{ color:var(--text); letter-spacing:.2px }
  .switch{
    --h: 24px;
    position:relative; width: 46px; height: var(--h); background: var(--surface-2);
    border:1px solid rgba(255,255,255,.08); border-radius: 999px; cursor:pointer;
    display:inline-block; vertical-align:middle;
  }
  .switch::after{
    content:''; position:absolute; top:2px; left:2px; width: calc(var(--h) - 4px); height: calc(var(--h) - 4px);
    background: linear-gradient(180deg, #fff, #e9edf5); border-radius:50%; transition:left .15s ease;
    box-shadow: 0 2px 6px rgba(0,0,0,.25), inset 0 0 0 1px rgba(0,0,0,.04);
  }
  .switch[data-on="1"]{ background: linear-gradient(180deg, var(--brand-2), var(--brand)); }
  .switch[data-on="1"]::after{ left: calc(100% - var(--h) + 2px); }

  .toolbar .select, .toolbar .input{
    min-width: 160px;
  }
  .toolbar .btn{ padding:10px 12px; }

  /* Grid m√°s denso para listados */
  .grid-list{
    display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px;
  }
  @media (max-width:1160px){ .grid-list{grid-template-columns: repeat(3, 1fr)}}
  @media (max-width:820px){ .grid-list{grid-template-columns: repeat(2, 1fr)}}
  @media (max-width:520px){ .grid-list{grid-template-columns: 1fr}}

  /* Tarjeta refinada para empresa */
  .card-company{
    position:relative; overflow:hidden; border-radius:16px;
    background:linear-gradient(180deg, var(--surface), var(--surface-2));
    border:1px solid rgba(255,255,255,.06);
    display:flex; flex-direction:column; min-height: 180px;
    transition: transform .12s ease, box-shadow .12s ease;
  }
  .card-company:hover{ transform: translateY(-2px); box-shadow: var(--shadow) }
  @media (prefers-color-scheme: light){ .card-company{border-color: rgba(16,24,40,.08)}}

  .card-head{
    display:flex; align-items:center; gap:12px; padding:12px; border-bottom:1px solid rgba(255,255,255,.06);
  }
  @media (prefers-color-scheme: light){ .card-head{border-bottom-color: rgba(16,24,40,.08)}}
  .card-logo{
    width:48px; height:48px; border-radius:12px; display:grid; place-items:center; color:white; font-weight:900;
    background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--brand));
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.14);
    flex: none;
  }
  .card-title{
    flex:1;
  }
  .card-title a{ font-weight:900; letter-spacing:.2px; }
  .card-badges{ display:flex; align-items:center; gap:8px; flex-wrap:wrap; }

  .card-body{
    padding:12px; display:flex; flex-direction:column; gap:10px;
  }
  .card-actions{ display:flex; gap:8px; flex-wrap:wrap; }

  /* Breadcrumbs m√°s sutil */
  .breadcrumbs{ display:flex; gap:8px; flex-wrap:wrap; }
  .breadcrumbs .chip{ background: var(--surface-2); }
  .breadcrumbs .chip[aria-current="page"]{ font-weight:800; opacity:.95 }

  /* Paginador */
  .pager{
    display:flex; gap:8px; align-items:center; justify-content:flex-end; flex-wrap:wrap; margin-top:14px;
  }
  .pager .btn[disabled]{ opacity:.65; cursor:not-allowed; transform:none }
  .pager .btn.btn-ghost[disabled]{ opacity:.45 }

  /* Vista de Categor√≠as /hub */
  .cats-hub .cat-card{ min-height:140px }
  .cats-hub .cat-media{ height:72px; font-size:30px }
  .cats-hub .cat-body{ padding:14px }
</style>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 3
   Listados por categor√≠a + filtros + grid y vista de "Categor√≠as"
   ============================================================ */

/* ---------- Ampliar dataset: subcategor√≠as y campos ---------- */
(function extendDataset(){
  if(DATA.subcategorias) return; // evitar duplicar si se pega varias veces
  DATA.subcategorias = {
    'comida-bebida': [
      {id:'panaderias', nombre:'Panader√≠as'},
      {id:'cafeterias', nombre:'Cafeter√≠as'},
      {id:'restaurantes', nombre:'Restaurantes'},
    ],
    'hogar-ferreteria': [
      {id:'ferreterias', nombre:'Ferreter√≠as'},
      {id:'electricos', nombre:'Materiales el√©ctricos'},
      {id:'pinturas', nombre:'Pinturas'},
    ],
    'tecnologia': [
      {id:'agencias-web', nombre:'Agencias web'},
      {id:'soporte-it', nombre:'Soporte IT'},
      {id:'tiendas-tech', nombre:'Tiendas Tech'},
    ],
    'servicios-profesionales': [
      {id:'abogados', nombre:'Abogados'},
      {id:'contadores', nombre:'Contadores'},
      {id:'marketing', nombre:'Marketing'},
    ]
  };

  // enriquecer empresas con subcat, breve y icon
  const pick = (arr)=> arr[Math.floor(Math.random()*arr.length)];
  const iconByCat = {
    'comida-bebida':'üçΩÔ∏è','hogar-ferreteria':'üõ†Ô∏è','tecnologia':'images/3524895.png','mascotas':'üêæ','automotriz':'üöó',
    'salud-belleza':'üíä','educacion':'üìö','servicios-profesionales':'üßë‚Äçüíº'
  };

  DATA.empresas = DATA.empresas.map(e => ({
    ...e,
    icon: iconByCat[e.cat] || 'üè¢',
    subcat: (DATA.subcategorias[e.cat]||[])[0]?.id || '',
    breve: (()=>{
      const map = {
        'comida-bebida':'Productos frescos y atenci√≥n r√°pida.',
        'hogar-ferreteria':'Soluciones para tu hogar y obra.',
        'tecnologia':'Sitios web, soporte y hardware.',
        'mascotas':'Cuidado integral para tu engre√≠do.',
        'automotriz':'Servicios r√°pidos y repuestos.',
        'salud-belleza':'Bienestar y est√©tica.',
        'educacion':'Aprendizaje efectivo.',
        'servicios-profesionales':'Asesor√≠a especializada.'
      };
      return map[e.cat] || 'Negocio local cercano a ti.';
    })()
  }));

  // A√±adimos algunos negocios extra para pruebas del grid/paginaci√≥n
  
  // Evitar duplicados si ya se peg√≥ este bloque
  const existingIds = new Set(DATA.empresas.map(e=>e.id));
  for(const e of seedMore){ if(!existingIds.has(e.id)) DATA.empresas.push(e); }

  // Recalcular totales y reconstruir √≠ndice
  (function hydrateCategoryTotals(){
    const byCat = {};
    for(const e of DATA.empresas){ byCat[e.cat] = (byCat[e.cat]||0)+1; }
    for(const c of DATA.categorias){ c.total = byCat[c.id]||0; }
  })();
  if(window.Search?.buildIndex) Search.buildIndex();
})();

/* ---------- Plantillas reforzadas ---------- */
function companyCardRich(e){
  const badge = e.verificada ? `<span class="badge" title="Empresa verificada">Verificada</span>` : '';
  
  // ‚≠ê Renderizar logo exactamente como en la ficha
  const logo = e.logo || null;
  const icon = e.icon || 'üè¢';
  
  const logoHtml = logo && logo.trim() 
    ? `<div class="card-logo">
         <img src="${logo}" 
              alt="Logo de ${e.nombre}" 
              loading="lazy"
              onerror="this.style.display='none'; this.parentElement.querySelector('.emoji-fallback').style.display='grid';">
         <span class="emoji-fallback" style="display:none;">${icon}</span>
         ${e.verificada ? '<span class="mini-verified">‚úì</span>' : ''}
       </div>`
    : `<div class="card-logo">
         <span class="emoji-fallback">${icon}</span>
         ${e.verificada ? '<span class="mini-verified">‚úì</span>' : ''}
       </div>`;
    // ‚úÖ Imagen de presentaci√≥n
  const imgPresentacion = e.imgpresentacion || null;
  
  const estiloFondo = imgPresentacion 
    ? `
      background: 
        linear-gradient(135deg, rgba(191, 255, 138, 0.88) 0%, rgba(219, 255, 149, 0.84) 50%, rgba(239, 255, 225, 0.80) 100%),
        url('${imgPresentacion}');
      background-size: cover;
      background-position: center;
      background-blend-mode: overlay;
    `
    : `background: linear-gradient(135deg, #bfff8a 0%, #dbff95 50%, #efffe1 100%);`;
  
  const chips = `
    <span class="chip" title="Ubicaci√≥n">üìç ${e.loc||'‚Äî'}</span>
    ${e.subcat ? `<span class="chip" title="Subcategor√≠a">üè∑Ô∏è ${e.subcat.replace(/-/g,' ')}</span>`:''}
  `;
  
  return `
  <article class="card-company">
    <header class="card-head">
      ${logoHtml}
      <div class="card-title">
        <a href="#/empresa/${e.id}" title="Ver ficha de ${e.nombre}">${e.nombre}</a>
        ${e.slogan ? `<p class="empresa-slogan">${e.slogan}</p>` : ''}
        <div class="card-badges">${badge}</div>
      </div>
    </header>
    <div class="card-body">
      <p style="margin:0;color:var(--muted);font-size:13px">${e.breve||'Negocio local cercano a ti.'}</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">${chips}</div>
      <div class="card-actions">
        <a class="btn" href="#/empresa/${e.id}">Ver m√°s</a>
        <a class="btn btn-ghost" href="#/categoria/${e.cat}">Ver categor√≠a</a>
      </div>
    </div>
  </article>`;
}

function renderGridRich(list, sel){
  const el = typeof sel==='string' ? document.querySelector(sel) : sel;
  if(!el) return;
  if(!list?.length){
    el.innerHTML = `
      <div class="section">
        <h3>Sin resultados</h3>
        <p class="lead">Ajusta los filtros o intenta otro t√©rmino.</p>
        <a href="#/" class="btn">‚¨Ö Volver al inicio</a>
      </div>`;
    return;
  }
  el.innerHTML = `<div class="grid-list">${list.map(companyCardRich).join('')}</div>`;
}

/* ---------- Filtros avanzados para listados ---------- */
function FilterState(init={}){
  const s = {
    q: init.q||'',
    cat: init.cat||'',
    loc: init.loc||'',
    subcat: init.subcat||'',
    sort: init.sort||'rank',
    verif: !!init.verif,
    minReviews: Number(init.minReviews||0),
    page: Number(init.page||1),
    per: Number(init.per||12)
  };
  return s;
}

function applyFilters(rows, st){
  let out = rows.slice();
  if(st.loc) out = out.filter(r=>r.loc===st.loc);
  if(st.subcat) out = out.filter(r=> (r.subcat||'')===st.subcat);
  if(st.verif) out = out.filter(r=> !!r.verificada);
  if(st.minReviews>0) out = out.filter(r=> (r.reviews||0) >= st.minReviews);
  // ordenar
  if(st.sort==='alpha'){ out.sort((a,b)=>a.name.localeCompare(b.name,'es')); }
  else if(st.sort==='rating'){ out.sort((a,b)=> (b.rating - a.rating) || (b.reviews - a.reviews)); }
  else { // rank (por defecto de Search)
    out.sort((a,b)=>{
      if(+b.verificada - +a.verificada !== 0) return +b.verificada - +a.verificada;
      if((b.rating||0) - (a.rating||0) !== 0) return (b.rating||0) - (a.rating||0);
      if((b.reviews||0) - (a.reviews||0) !== 0) return (b.reviews||0) - (a.reviews||0);
      return a.name.localeCompare(b.name,'es');
    });
  }
  return out;
}

/* ---------- UI: Toolbar para categor√≠a/b√∫squeda ---------- */
function renderToolbar({context='buscar', st, cat=null}){
  const subcats = cat ? (DATA.subcategorias[cat.id]||[]) : [];
  return `
  <div class="toolbar" role="region" aria-label="Controles de lista">
    <div class="left">
      <span class="pill"><span>Resultados:</span> <strong id="resCount">‚Äî</strong></span>
      <label class="sr-only" for="selLoc">Ubicaci√≥n</label>
      <select id="selLoc" class="select">
        <option value="">Todas las ubicaciones</option>
        ${['Lima','Arequipa','Trujillo','Piura','Cusco'].map(loc=>`<option value="${loc}"${st.loc===loc?' selected':''}>${loc}</option>`).join('')}
      </select>
      ${subcats.length ? `
      <label class="sr-only" for="selSubcat">Subcategor√≠a</label>
      <select id="selSubcat" class="select">
        <option value="">Todas las subcategor√≠as</option>
        ${subcats.map(s=>`<option value="${s.id}"${st.subcat===s.id?' selected':''}>${s.nombre}</option>`).join('')}
      </select>`:''}
      <label class="pill" style="gap:10px;cursor:pointer">
        <input id="chkVerif" type="checkbox" class="sr-only" ${st.verif?'checked':''} />
        <span aria-hidden="true" class="switch" data-on="${st.verif?1:0}"></span>
        <span>Solo verificadas</span>
      </label>
      <label class="pill" style="gap:10px">
        Min. 
        <input id="minReviews" type="number" min="0" step="5" class="input" style="width:90px" value="${st.minReviews||0}" />
      </label>
    </div>
    <div class="right">
      <label class="sr-only" for="selSort">Ordenar</label>
      <select id="selSort" class="select">
        <option value="rank"${st.sort==='rank'?' selected':''}>Relevancia</option>
        <option value="rating"${st.sort==='rating'?' selected':''}>Mejor calificados</option>
        <option value="alpha"${st.sort==='alpha'?' selected':''}>A‚ÄìZ</option>
      </select>
      <label class="pill" style="gap:10px">
        Por p√°gina
        <select id="selPer" class="select" style="min-width:96px">
          ${[12,24,36].map(n=>`<option value="${n}"${st.per===n?' selected':''}>${n}</option>`).join('')}
        </select>
      </label>
      ${context==='buscar' ? `<a class="btn btn-ghost" href="#/">‚¨Ö Inicio</a>` : `<a class="btn btn-ghost" href="#/categorias">üóÇÔ∏è Categor√≠as</a>`}
    </div>
  </div>`;
}

/* ---------- Paginador UI ---------- */
function renderPager(state){
  const {page,pages} = state;
  const btn = (p,label,disabled=false)=>`
    <button class="btn ${disabled?'btn-ghost':''}" data-page="${p}" ${disabled?'disabled':''} style="min-width:46px">${label}</button>`;
  const range = [];
  const start = Math.max(1, page-2);
  const end = Math.min(pages, page+2);
  for(let i=start;i<=end;i++){ range.push(i); }
  return `
    <div class="pager" id="pager">
      ${btn(1,'¬´', page<=1)}
      ${btn(page-1,'‚Äπ', page<=1)}
      ${range.map(i => btn(i, i, i===page)).join('')}
      ${btn(page+1,'‚Ä∫', page>=pages)}
      ${btn(pages,'¬ª', page>=pages)}
    </div>`;
}

/* ---------- Vista: Categor√≠a (reemplaza handler previo) ---------- */
function viewCategoriaV3(ctx){
  const { id } = ctx.params;
  const cat = DATA.categorias.find(c=>c.id===id);
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);

  const init = FilterState({
    q:'', cat:id, loc: ctx.qs.loc||'', subcat: ctx.qs.subcat||'',
    sort: ctx.qs.sort || 'rank', verif: ctx.qs.verif==='1',
    minReviews: Number(ctx.qs.minReviews||0), page: Number(ctx.qs.page||1), per: Number(ctx.qs.per||12)
  });

  // Base rows por categor√≠a usando √≠ndice de b√∫squeda
  const rowsBase = Search.search({ q:'', cat:id, loc:'', sort: init.sort });
  const recompute = ()=>{
    const filtered = applyFilters(rowsBase, init);
    const state = paginate(filtered, init.page, init.per);
    const header = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">${cat? cat.nombre : 'Categor√≠a'}</h1>
          <p class="lead" style="margin:4px 0 0 0">${state.total} negocios</p>
        </div>
      </div>
      <div class="breadcrumbs" style="margin-top:8px">
        <a class="chip" href="#/" title="Inicio">üè† Inicio</a>
        <a class="chip" href="#/categorias" title="Categor√≠as">üóÇÔ∏è Categor√≠as</a>
        <span class="chip" aria-current="page">${cat? cat.nombre : id}</span>
      </div>
      ${renderToolbar({context:'categoria', st:init, cat})}
      <div id="gridCat" class="section" style="padding-top:12px"></div>
      ${renderPager(state)}
    `;
    container.innerHTML = header;
    $('#resCount').textContent = state.total;
    renderGridRich(state.items, '#gridCat');

    // Eventos
    $('#selLoc')?.addEventListener('change', e=>{ init.loc = e.target.value; init.page=1; pushQS(); recompute(); });
    $('#selSubcat')?.addEventListener('change', e=>{ init.subcat = e.target.value; init.page=1; pushQS(); recompute(); });
    $('#selSort')?.addEventListener('change', e=>{ init.sort = e.target.value; init.page=1; pushQS(); recompute(); });
    $('#selPer')?.addEventListener('change', e=>{ init.per = Number(e.target.value); init.page=1; pushQS(); recompute(); });
    $('#chkVerif')?.addEventListener('change', e=>{
      init.verif = e.target.checked; document.querySelector('.switch').dataset.on = init.verif?1:0; init.page=1; pushQS(); recompute();
    });
    $('#minReviews')?.addEventListener('input', debounce(e=>{ init.minReviews = Math.max(0, Number(e.target.value||0)); init.page=1; pushQS(); recompute(); }, 250));
    $('#pager')?.addEventListener('click', e=>{
      const p = Number(e.target?.dataset?.page||0); if(!p) return;
      init.page = p; pushQS(); recompute();
    }, {passive:true});

    function pushQS(){
      const qs = toQS({
        page:init.page, sort:init.sort, loc:init.loc, subcat:init.subcat,
        verif: init.verif? '1':'', minReviews: init.minReviews||'',
        per: init.per===12? '' : init.per
      });
      history.replaceState(null, '', `#/categoria/${id}${qs}`);
    }
  };

  setTimeout(recompute, 180);
}

/* ---------- Vista: Buscar (mejorada con toolbar) ---------- */
function viewBuscarV3(ctx){
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);

  const init = FilterState({
    q: ctx.qs.q||'', cat: ctx.qs.cat||'', loc: ctx.qs.loc||'',
    sort: ctx.qs.sort||'rank', page: Number(ctx.qs.page||1), per: Number(ctx.qs.per||12),
    verif: ctx.qs.verif==='1', minReviews: Number(ctx.qs.minReviews||0)
  });

  const base = Search.search({ q:init.q, cat:init.cat, loc:'', sort:init.sort });

  const recompute = ()=>{
    const filtered = applyFilters(base, init);
    const state = paginate(filtered, init.page, init.per);
    const title = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">Resultados de b√∫squeda</h1>
          <p class="lead" style="margin:4px 0 0 0">
            <strong>${state.total}</strong> resultados
            ${init.q? ` para "<span class="mono">${init.q.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</span>"` : ''}
          </p>
        </div>
      </div>
      <div class="breadcrumbs" style="margin-top:8px">
        <a class="chip" href="#/" title="Inicio">üè† Inicio</a>
        <span class="chip" aria-current="page">Buscar</span>
      </div>
      ${renderToolbar({context:'buscar', st:init})}
      <div id="gridRes" class="section" style="padding-top:12px"></div>
      ${renderPager(state)}
    `;
    container.innerHTML = title;
    $('#resCount').textContent = state.total;
    renderGridRich(state.items, '#gridRes');

    // Eventos
    $('#selLoc')?.addEventListener('change', e=>{ init.loc = e.target.value; init.page=1; syncQS(); recompute(); });
    $('#selSort')?.addEventListener('change', e=>{ init.sort = e.target.value; init.page=1; syncQS(); recompute(); });
    $('#selPer')?.addEventListener('change', e=>{ init.per = Number(e.target.value); init.page=1; syncQS(); recompute(); });
    $('#chkVerif')?.addEventListener('change', e=>{ init.verif = e.target.checked; document.querySelector('.switch').dataset.on = init.verif?1:0; init.page=1; syncQS(); recompute(); });
    $('#minReviews')?.addEventListener('input', debounce(e=>{ init.minReviews = Math.max(0, Number(e.target.value||0)); init.page=1; syncQS(); recompute(); }, 250));
    $('#pager')?.addEventListener('click', e=>{
      const p = Number(e.target?.dataset?.page||0); if(!p) return;
      init.page = p; syncQS(); recompute();
    }, {passive:true});

    function syncQS(){
      const qs = toQS({
        q:init.q, cat:init.cat, loc:init.loc, sort:init.sort, page:init.page,
        per: init.per===12? '' : init.per, verif: init.verif? '1':'',
        minReviews: init.minReviews||''
      });
      history.replaceState(null, '', `#/buscar${qs}`);
    }
  };

  setTimeout(recompute, 200);
}

/* ---------- Vista: Hub de Categor√≠as (#/categorias) ---------- */
function viewCategoriasHub(){
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);

  setTimeout(()=>{
    const header = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">Categor√≠as</h1>
          <p class="lead" style="margin:4px 0 0 0">${DATA.categorias.length} categor√≠as en ImpulsoLocal</p>
        </div>
        <div>
          <input id="filterCat" class="input" placeholder="Filtrar categor√≠as‚Ä¶" style="min-width:220px" />
        </div>
      </div>
      <div class="breadcrumbs" style="margin-top:8px">
        <a class="chip" href="#/">üè† Inicio</a>
        <span class="chip" aria-current="page">Categor√≠as</span>
      </div>
      <div id="catsWrap" class="section cats-hub">
        <div class="cat-grid" id="catsGrid"></div>
      </div>
    `;
    container.innerHTML = header;

    const renderCats = (q='')=>{
      const qn = Str.toSearch(q);
      const cats = DATA.categorias.filter(c => !q || Str.toSearch(c.nombre).includes(qn));
      const grid = $('#catsGrid');
      if(!cats.length){ grid.innerHTML = `<p class="lead">Sin coincidencias.</p>`; return; }
      
      // üëá AQU√ç EST√Å EL CAMBIO IMPORTANTE
      grid.innerHTML = cats.map(c=>{
        // Detectar si el icono es imagen o emoji
        const icon = c.icon || 'üè¢';
        const isImage = icon.startsWith('images/') || icon.startsWith('http') || icon.includes('.png') || icon.includes('.jpg') || icon.includes('.svg');
        
        const iconHtml = isImage 
          ? `<img src="${icon}" alt="${c.nombre}" style="width:80px;height:80px;object-fit:contain;" loading="lazy">`
          : icon;
        
        return `
        <a class="cat-card" href="#/categoria/${c.id}" title="Ver ${c.nombre}">
          <div class="cat-media">${iconHtml}</div>
          <div class="cat-body">
            <div>
              <div style="font-weight:800">${c.nombre}</div>
              <div style="font-size:12px; color:var(--muted)">${c.total} negocios</div>
            </div>
            <span class="badge">Explorar</span>
          </div>
        </a>`;
      }).join('');
    };
    renderCats();

    $('#filterCat').addEventListener('input', debounce(e=> renderCats(e.target.value), 180));
  }, 160);
}

</script>
<!-- ======= BLOQUE 4: Buscador Global Mejorado (UX, resaltado, recientes, vista lista/grid, compartir) ======= -->
<style>
  /* ==========================
     Bloque 4 ‚Äî Estilos buscador avanzado
     ========================== */

  /* Barra de resultados (stats + acciones) */
  .results-bar{
    display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:10px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .results-bar{border-color: rgba(16,24,40,.08)}}
  .results-bar .stats{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .results-bar .actions{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
  .q-pill{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    background:var(--surface-2); border:1px solid rgba(255,255,255,.08); color:var(--muted); font-size:12px;
  }
  @media (prefers-color-scheme: light){ .q-pill{border-color: rgba(16,24,40,.08)}}
  .q-pill strong{ color:var(--text) }

  .view-toggle{
    display:inline-flex; background:var(--surface-2); border:1px solid rgba(255,255,255,.08); border-radius:10px; overflow:hidden;
  }
  .view-toggle button{
    border:0; background:transparent; padding:8px 10px; cursor:pointer; font-weight:700; min-width:46px;
  }
  .view-toggle button[aria-pressed="true"]{ background:linear-gradient(180deg,var(--brand-2),var(--brand)); color:#fff }

  /* Vista lista (alternativa a grid) */
  .list-view{ display:grid; gap:10px }
  .list-item{
    display:grid; grid-template-columns:60px 1fr auto; gap:12px; align-items:center;
    background:linear-gradient(180deg,var(--surface),var(--surface-2)); border:1px solid rgba(255,255,255,.06);
    border-radius:14px; padding:10px;
  }
  @media (max-width:620px){ .list-item{ grid-template-columns:48px 1fr } .list-item .cta{ display:none } }
  .list-item .logo{ width:60px; height:60px; border-radius:12px; display:grid; place-items:center; background:conic-gradient(from 180deg, var(--brand), var(--brand-2), var(--brand)); color:#fff; font-weight:900 }
  .list-item .meta{ display:flex; gap:8px; flex-wrap:wrap }
  .list-item .title{ font-weight:900; letter-spacing:.2px }
  .list-item .desc{ color:var(--muted); font-size:13px; margin-top:2px }

  /* Resaltado de coincidencias */
  .hl{ background: linear-gradient(180deg, rgba(98,209,255,.35), rgba(10,124,255,.20)); border-radius:6px; padding:0 2px }

  /* Recientes / guardados */
  .recent-wrap{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px }
  .recent-title{ color:var(--muted); font-size:13px }
  .recent-chip{
    display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
    background:var(--surface); border:1px solid rgba(255,255,255,.08); cursor:pointer;
  }
  .recent-chip .del{ opacity:.7; cursor:pointer }
  .recent-chip:hover{ transform: translateY(-1px) }
  @media (prefers-color-scheme: light){ .recent-chip{border-color: rgba(16,24,40,.08)}}

  /* Bot√≥n "cargar m√°s" */
  .load-more-wrap{ display:grid; place-items:center; margin-top:14px }
  .btn-outline{
    background:transparent; color:var(--brand); border:1px solid var(--brand); box-shadow:none;
  }

  /* Estado vac√≠o con sugerencias */
  .empty{
    border:1px dashed rgba(255,255,255,.18); border-radius:16px; padding:18px; text-align:center; color:var(--muted);
  }
  @media (prefers-color-scheme: light){ .empty{border-color: rgba(16,24,40,.18)}}
  .empty .sugs{ margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center }

  /* Accesibilidad: enfoque visible en interacciones clave */
  a:focus, button:focus, select:focus, input:focus{ outline:none; box-shadow: var(--ring) }
</style>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 4
   Experiencia de b√∫squeda global avanzada:
   - Resaltado de t√©rminos
   - Recientes (localStorage) y guardado manual
   - Vista lista / grid conmutable
   - Copiar link / compartir
   - "Cargar m√°s" (paginaci√≥n progresiva)
   ============================================================ */

/* ---------- Utilidades locales ---------- */
const Store = (() => {
  const KEY = 'IL_RECENT_SEARCHES_V1';
  function get(){
    try{ return JSON.parse(localStorage.getItem(KEY)||'[]'); }catch{ return []; }
  }
  function set(arr){ try{ localStorage.setItem(KEY, JSON.stringify(arr.slice(0,12))); }catch{} }
  function add(q){
    if(!q || !q.q) return;
    const cur = get().filter(x => !(x.q===q.q && x.cat===q.cat && x.loc===q.loc));
    cur.unshift({...q, ts: Date.now()});
    set(cur);
  }
  function del(index){
    const cur = get(); cur.splice(index,1); set(cur);
  }
  return { get, add, del };
})();

function copyToClipboard(text){
  if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(text).then(()=>Toast.show('Enlace copiado','ok'), ()=>Toast.show('No se pudo copiar','error')); }
  else{
    const ta = document.createElement('textarea'); ta.value = text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); ta.remove(); Toast.show('Enlace copiado','ok');
  }
}

/* ---------- Resaltado de t√©rminos ---------- */
function highlight(text, q){
  if(!q) return text;
  const terms = Str.toSearch(q).split(' ').filter(Boolean).map(t => t.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'));
  if(!terms.length) return text;
  const re = new RegExp('('+terms.join('|')+')','gi');
  return String(text).replace(re, m => `<mark class="hl">${m}</mark>`);
}

/* ---------- Render en modo lista ---------- */
function renderListView(items, sel, q){
  const el = typeof sel==='string' ? document.querySelector(sel) : sel;
  if(!el) return;
  if(!items?.length){
    el.innerHTML = `
      <div class="empty">
        <h3>Sin resultados</h3>
        <p class="lead">No encontramos negocios que coincidan con tu b√∫squeda.</p>
      </div>`;
    return;
  }
  el.innerHTML = `
    <div class="list-view">
      ${items.map(e => {
        // ‚úÖ Logo igual que en card
        const logo = e.logo || null;
        const icon = e.icon || 'üè¢';
        
        const logoHtml = logo && logo.trim()
          ? `<div class="logo">
               <img src="${logo}" 
                    alt="Logo de ${e.name||e.nombre}" 
                    loading="lazy"
                    onerror="this.style.display='none'; this.parentElement.querySelector('.emoji-fallback').style.display='grid';">
               <span class="emoji-fallback" style="display:none;">${icon}</span>
               ${e.verificada ? '<span class="mini-verified">‚úì</span>' : ''}
             </div>`
          : `<div class="logo">
               <span class="emoji-fallback">${icon}</span>
               ${e.verificada ? '<span class="mini-verified">‚úì</span>' : ''}
             </div>`;
        
        // ‚úÖ NUEVA: Imagen de presentaci√≥n en el tercio derecho
        const imgPresentacion = e.imgpresentacion || null;
        
        const imagenDerechaHtml = imgPresentacion 
          ? `<div class="list-item-bg-right" style="
               position: absolute;
               top: 0;
               right: 0;
               width: 33.333%;
               height: 100%;
               overflow: hidden;
               border-radius: 0 14px 14px 0;
               z-index: 0;
               opacity: 0.5;
             ">
               <img src="${imgPresentacion}" 
                    alt="Vista de ${e.name||e.nombre}" 
                    loading="lazy"
                    style="
                      width: 100%;
                      height: 100%;
                      object-fit: cover;
                      filter: brightness(1.05);
                    ">
               <div style="
                 position: absolute;
                 inset: 0;
                 background: linear-gradient(to right, 
                   rgba(255,255,255,0.85) 0%, 
                   rgba(255,255,255,0.3) 40%, 
                   transparent 100%
                 );
               "></div>
             </div>`
          : '';
        
        return `
        <article class="list-item" style="position: relative; overflow: hidden;">
          ${imagenDerechaHtml}
          ${logoHtml}
          <div style="position: relative; z-index: 1; max-width: 66%;">
            <a class="title" href="#/empresa/${e.id}">${highlight(e.name||e.nombre, q)}</a>
            ${e.slogan ? `<p class="empresa-slogan">${highlight(e.slogan, q)}</p>` : ''}
            <div class="meta">
              <span class="chip">üìç ${e.loc||'‚Äî'}</span>
              ${e.verificada? `<span class="badge">Verificada</span>`:''}
            </div>
            <p class="desc">
              ${
                highlight(
                  (
                    e.descrip?.length
                      ? e.descrip.join('. ')
                      : e.breve || 'Negocio local cercano a ti.'
                  ),
                  q
                )
              }
            </p>
          </div>
          <div class="cta" style="position: relative; z-index: 1;">
            <a class="btn" href="#/empresa/${e.id}">Ver ficha</a>
          </div>
        </article>`;
      }).join('')}
    </div>`;
}

/* ---------- UI Recientes ---------- */
function renderRecentChips(whereSel, onClick){
  const wrap = typeof whereSel==='string' ? document.querySelector(whereSel) : whereSel;
  if(!wrap) return;
  const rec = Store.get();
  if(!rec.length){ wrap.innerHTML=''; return; }
  wrap.innerHTML = `
    <div class="recent-wrap" id="recentWrap">
      <span class="recent-title">B√∫squedas recientes:</span>
      ${rec.map((r,i)=>`
        <span class="recent-chip" data-i="${i}" title="Buscar ${r.q || '‚Äî'}">
          üîé <span class="mono">${(r.q||'(vac√≠o)')}</span>${r.loc?` ¬∑ ${r.loc}`:''}${r.cat?` ¬∑ ${r.cat}`:''}
          <button class="del chip btn-ghost" type="button" aria-label="Eliminar" data-del="${i}">‚úï</button>
        </span>
      `).join('')}
    </div>`;
  wrap.onclick = (e)=>{
    const del = e.target.closest('[data-del]');
    const chip = e.target.closest('.recent-chip');
    if(del){
      Store.del(Number(del.dataset.del));
      renderRecentChips(whereSel, onClick);
      return;
    }
    if(chip){
      const i = Number(chip.dataset.i);
      const r = Store.get()[i];
      onClick?.(r||{});
    }
  };
}

/* ---------- "Cargar m√°s" progresivo ---------- */
function setupLoadMore(state, renderFn){
  const wrap = document.createElement('div');
  wrap.className = 'load-more-wrap';
  wrap.innerHTML = `<button id="btnLoadMore" class="btn btn-outline">Cargar m√°s</button>`;
  const btn = wrap.querySelector('#btnLoadMore');
  btn.addEventListener('click', ()=>{
    const next = state.page + 1;
    if(next > state.pages){ btn.disabled = true; return; }
    state.page = next;
    const more = state.items = state.items.concat(state.source.slice((next-1)*state.per, next*state.per));
    renderFn(more);
    if(state.page >= state.pages){ btn.disabled = true; btn.textContent='No hay m√°s'; }
  });
  return wrap;
}

/* ---------- Vista: Buscar con mejoras ---------- */
function viewBuscarV4(ctx){
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);

  // Estado inicial desde QS
  const init = {
    q: ctx.qs.q||'',
    cat: ctx.qs.cat||'',
    loc: ctx.qs.loc||'',
    sort: ctx.qs.sort||'rank',
    verif: ctx.qs.verif==='1',
    minReviews: Number(ctx.qs.minReviews||0),
    per: Number(ctx.qs.per||12),
    view: ctx.qs.view==='list' ? 'list' : 'grid'
  };

  // Run b√∫squeda base
  const base = Search.search({ q:init.q, cat:init.cat, loc:init.loc, sort:init.sort });
  // Aplicar filtros de Bloque 3
  let filtered = (()=>{
    const tmp = { ...init, page:1 };
    return applyFilters(base, tmp);
  })();

  // Guardar reciente
  Store.add({ q:init.q, cat:init.cat, loc:init.loc });

  // Plantilla principal
  const head = `
    <div class="results-bar" id="resultsBar">
      <div class="stats">
        <span class="q-pill">Resultados: <strong id="statTotal">${filtered.length}</strong></span>
        ${init.q ? `<span class="q-pill">Consulta: <strong class="mono">${init.q.replace(/</g,'&lt;').replace(/>/g,'&gt;')}</strong></span>`:''}
        ${init.cat ? `<span class="q-pill">Categor√≠a: <strong>${init.cat}</strong></span>`:''}
        ${init.loc ? `<span class="q-pill">Ubicaci√≥n: <strong>${init.loc}</strong></span>`:''}
      </div>
      <div class="actions">
        <label class="sr-only" for="selSortV4">Ordenar</label>
        <select id="selSortV4" class="select">
          <option value="rank"${init.sort==='rank'?' selected':''}>Relevancia</option>
          <option value="rating"${init.sort==='rating'?' selected':''}>Mejor calificados</option>
          <option value="alpha"${init.sort==='alpha'?' selected':''}>A‚ÄìZ</option>
        </select>
        <div class="view-toggle" role="group" aria-label="Cambiar vista">
          <button id="viewGrid" aria-pressed="${init.view==='grid'?'true':'false'}" title="Vista en cuadr√≠cula">‚ñ¶</button>
          <button id="viewList" aria-pressed="${init.view==='list'?'true':'false'}" title="Vista en lista">‚â£</button>
        </div>
        <button class="btn btn-ghost" id="btnShare" title="Copiar enlace">üîó Compartir</button>
        <a class="btn btn-ghost" href="#/">‚¨Ö Inicio</a>
      </div>
    </div>
    <div id="recentMount"></div>
    <div class="section" style="padding-top:12px">
      <div id="resultsMount"></div>
      <div id="moreMount"></div>
    </div>
  `;
  setTimeout(()=>{
    container.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">Resultados de b√∫squeda</h1>
          <p class="lead" style="margin:4px 0 0 0">Explora y filtra negocios locales.</p>
        </div>
      </div>
      <div class="breadcrumbs" style="margin-top:8px">
        <a class="chip" href="#/">üè† Inicio</a>
        <span class="chip" aria-current="page">Buscar</span>
      </div>
      ${head}
    `;

    // Montar recientes
    renderRecentChips('#recentMount', (r)=>{
      const qs = toQS({ q:r.q||'', cat:r.cat||'', loc:r.loc||'', sort:init.sort, view:init.view });
      Router.go(`#/buscar${qs}`);
    });

    // Estado de paginaci√≥n progresiva para "cargar m√°s"
    const prog = {
      per: init.per || 12,
      page: 1,
      pages: Math.max(1, Math.ceil(filtered.length / (init.per||12))),
      source: filtered.slice(),
      items: filtered.slice(0, init.per || 12)
    };

    // Render inicial seg√∫n vista
    const mount = $('#resultsMount');
    const doRender = ()=>{
      $('#statTotal').textContent = filtered.length;
      if(init.view==='grid'){
        renderGridRich(prog.items, mount);
      }else{
        renderListView(prog.items, mount, init.q);
      }
      // Cargar m√°s
      const mm = $('#moreMount'); mm.innerHTML='';
      if(prog.page < prog.pages){
        mm.appendChild(setupLoadMore(prog, (items)=>{
          if(init.view==='grid'){ renderGridRich(items, mount); }
          else { renderListView(items, mount, init.q); }
        }));
      }
    };
    doRender();

    // Interacciones
    $('#selSortV4').addEventListener('change', e=>{
      init.sort = e.target.value;
      // recomputar orden
      filtered = Search.search({ q:init.q, cat:init.cat, loc:init.loc, sort:init.sort });
      filtered = applyFilters(filtered, { ...init, page:1 });
      // recomputar progresivo
      prog.page = 1; prog.pages = Math.max(1, Math.ceil(filtered.length / (init.per||12)));
      prog.source = filtered.slice(); prog.items = filtered.slice(0, init.per||12);
      syncQS(); doRender();
    });
    $('#viewGrid').addEventListener('click', ()=>{
      init.view='grid';
      document.getElementById('viewGrid').setAttribute('aria-pressed','true');
      document.getElementById('viewList').setAttribute('aria-pressed','false');
      doRender(); syncQS();
    });
    $('#viewList').addEventListener('click', ()=>{
      init.view='list';
      document.getElementById('viewGrid').setAttribute('aria-pressed','false');
      document.getElementById('viewList').setAttribute('aria-pressed','true');
      doRender(); syncQS();
    });
    $('#btnShare').addEventListener('click', ()=>{
      copyToClipboard(location.href);
    });

    function syncQS(){
      const qs = toQS({ q:init.q, cat:init.cat, loc:init.loc, sort:init.sort, view:init.view });
      history.replaceState(null,'', `#/buscar${qs}`);
      // Opcional: actualizar t√≠tulo/meta (b√°sico)
      document.title = init.q ? `${init.q} ‚Äî ImpulsoLocal` : 'ImpulsoLocal ‚Äî Resultados';
    }
  }, 160);
}

/* ---------- Vista: Categor√≠a con mejoras (resaltado + recientes) ---------- */
function viewCategoriaV4(ctx){
  const { id } = ctx.params;
  const cat = DATA.categorias.find(c=>c.id===id);
  const container = $('#view-listado');
  container.classList.remove('hide');
  setLoadingGrid(container, 12);

  const init = {
    q: '', cat:id, loc: ctx.qs.loc||'', subcat: ctx.qs.subcat||'',
    sort: ctx.qs.sort || 'rank', verif: ctx.qs.verif==='1',
    minReviews: Number(ctx.qs.minReviews||0), page: Number(ctx.qs.page||1),
    per: Number(ctx.qs.per||12), view: ctx.qs.view==='list' ? 'list' : 'grid'
  };

  // Base rows por categor√≠a
  let rowsBase = Search.search({ q:'', cat:id, loc:init.loc, sort: init.sort });
  let filtered = applyFilters(rowsBase, init);

  const head = `
    <div class="results-bar">
      <div class="stats">
        <span class="q-pill">Categor√≠a: <strong>${cat? cat.nombre : id}</strong></span>
        <span class="q-pill">Resultados: <strong id="statCat">${filtered.length}</strong></span>
      </div>
      <div class="actions">
        <select id="selSortCatV4" class="select">
          <option value="rank"${init.sort==='rank'?' selected':''}>Relevancia</option>
          <option value="rating"${init.sort==='rating'?' selected':''}>Mejor calificados</option>
          <option value="alpha"${init.sort==='alpha'?' selected':''}>A‚ÄìZ</option>
        </select>
        <div class="view-toggle" role="group" aria-label="Cambiar vista">
          <button id="viewGridC" aria-pressed="${init.view==='grid'?'true':'false'}">‚ñ¶</button>
          <button id="viewListC" aria-pressed="${init.view==='list'?'true':'false'}">‚â£</button>
        </div>
        <a class="btn btn-ghost" href="#/categorias">üóÇÔ∏è Categor√≠as</a>
      </div>
    </div>
    <div id="recentMountCat"></div>
    <div id="filtersMountCat" style="margin-top:10px"></div>
    <div class="section" style="padding-top:12px">
      <div id="gridCatV4"></div>
      <div id="moreCat"></div>
    </div>
  `;

  setTimeout(()=>{
    container.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">${cat? cat.nombre : 'Categor√≠a'}</h1>
          <p class="lead" style="margin:4px 0 0 0">Negocios listados por rubro.</p>
        </div>
      </div>
      <div class="breadcrumbs" style="margin-top:8px">
        <a class="chip" href="#/">üè† Inicio</a>
        <a class="chip" href="#/categorias">üóÇÔ∏è Categor√≠as</a>
        <span class="chip" aria-current="page">${cat? cat.nombre : id}</span>
      </div>
      ${head}
    `;

    // Recientes montados (redirigen a buscar con q/cat)
    renderRecentChips('#recentMountCat', (r)=>{
      const qs = toQS({ q:r.q||'', cat:r.cat||'', loc:r.loc||'', sort:'rank' });
      Router.go(`#/buscar${qs}`);
    });

    // Progresivo
    const prog = {
      per: init.per || 12,
      page: 1,
      pages: Math.max(1, Math.ceil(filtered.length / (init.per||12))),
      source: filtered.slice(),
      items: filtered.slice(0, init.per||12)
    };

    const mount = $('#gridCatV4');
    const doRender = ()=>{
      $('#statCat').textContent = filtered.length;
      if(init.view==='grid'){ renderGridRich(prog.items, mount); }
      else { renderListView(prog.items, mount, ''); }
      const mm = $('#moreCat'); mm.innerHTML='';
      if(prog.page < prog.pages){
        mm.appendChild(setupLoadMore(prog, (items)=>{
          if(init.view==='grid'){ renderGridRich(items, mount); }
          else { renderListView(items, mount, ''); }
        }));
      }
    };
    doRender();

    // Eventos
    $('#selSortCatV4').addEventListener('change', e=>{
      init.sort = e.target.value;
      rowsBase = Search.search({ q:'', cat:id, loc:init.loc, sort:init.sort });
      filtered = applyFilters(rowsBase, init);
      prog.page=1; prog.pages=Math.max(1, Math.ceil(filtered.length/(init.per||12)));
      prog.source=filtered.slice(); prog.items=filtered.slice(0, init.per||12);
      syncQS(); doRender();
    });
    $('#viewGridC').addEventListener('click', ()=>{ init.view='grid'; setPress('#viewGridC', true); setPress('#viewListC', false); syncQS(); doRender(); });
    $('#viewListC').addEventListener('click', ()=>{ init.view='list'; setPress('#viewGridC', false); setPress('#viewListC', true); syncQS(); doRender(); });

    function setPress(sel, val){ const b = document.querySelector(sel); b && b.setAttribute('aria-pressed', val?'true':'false'); }
    function syncQS(){
      const qs = toQS({ page:init.page, sort:init.sort, loc:init.loc, subcat:init.subcat, verif: init.verif? '1':'', minReviews: init.minReviews||'', per: init.per===12? '' : init.per, view: init.view });
      history.replaceState(null,'', `#/categoria/${id}${qs}`);
      document.title = `${cat? cat.nombre : id} ‚Äî ImpulsoLocal`;
    }
  }, 150);
}


</script>
<!-- ======= BLOQUE 5: Ficha de Empresa (galer√≠a, info, chips, formulario de contacto) ======= -->
<style>
  /* ==========================
     Bloque 5 ‚Äî Estilos Ficha
     ========================== */

  .ficha{
    display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;
  }
  @media (max-width: 980px){ .ficha{ grid-template-columns: 1fr } }

  /* Header de ficha */
  .ficha-head{
    display:flex; align-items:center; gap:12px; background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .ficha-head{border-color: rgba(16,24,40,.08)}}
  .ficha-logo{ width:60px; height:60px; border-radius:14px; display:grid; place-items:center; font-weight:900; color:#fff;
    background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--brand));
    box-shadow: inset 0 0 0 2px rgba(255,255,255,.14);
  }
  .ficha-title{ flex:1 }
  .ficha-title h1{ margin:0; font-size:clamp(20px, 4vw, 28px); line-height:1.1; letter-spacing:.2px }
  .stars{ display:inline-flex; gap:6px; align-items:center; flex-wrap:wrap }
  .stars .chip{ background: var(--surface-2) }
  .verify{ display:inline-flex; gap:8px; align-items:center; font-weight:700 }
  .verify .badge{ box-shadow:none }

  /* Galer√≠a */
  .gallery{
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:10px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .gallery{border-color: rgba(16,24,40,.08)}}
  .gallery-main{
    aspect-ratio: 14/9; border-radius:16px; overflow:hidden; position:relative;
    background:
      radial-gradient(360px 180px at 20% 20%, rgba(98,209,255,.25), transparent),
      radial-gradient(360px 180px at 80% 0%, rgba(10,124,255,.25), transparent),
      linear-gradient(180deg, var(--surface), var(--surface-2));
    border:1px solid rgba(255,255,255,.06);
  }
  .gallery-thumbs{
    display:grid; grid-template-columns: repeat(6, 1fr); gap:10px; margin-top:10px;
  }
  @media (max-width: 720px){ .gallery-thumbs{ grid-template-columns: repeat(4,1fr) } }
  .thumb{
    aspect-ratio: 4/3; border-radius:10px; overflow:hidden; cursor:pointer; border:1px solid rgba(255,255,255,.06);
    background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
  }
  .thumb[aria-current="true"]{ outline: 2px solid var(--brand); outline-offset:2px; }
  .thumb img{ width:100%; height:100%; object-fit:cover; display:block }

  /* Secciones laterales (datos, contacto) */
  .side-card{
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:12px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .side-card{border-color: rgba(16,24,40,.08)}}
  .side-card h3{ margin:0 0 8px 0; font-size:18px; letter-spacing:.2px }

  .info-list{ display:grid; gap:8px }
  .info-row{ display:flex; align-items:flex-start; gap:8px }
  .info-row .k{ width:120px; color:var(--muted); font-size:13px }
  .info-row .v{ flex:1 }

  .tags{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px }
  .tags .chip{ background: var(--surface-2) }

  /* Tabs */
  .tabs{
    display:flex; gap:6px; border-bottom:1px solid rgba(255,255,255,.08); margin-top:12px;
  }
  @media (prefers-color-scheme: light){ .tabs{border-bottom-color: rgba(16,24,40,.08)}}
  .tabs button{
    appearance:none; border:0; background:transparent; padding:10px 12px; border-radius:10px 10px 0 0; cursor:pointer; font-weight:800;
  }
  .tabs button[aria-selected="true"]{
    background:linear-gradient(180deg,var(--surface-2),var(--surface)); box-shadow: var(--shadow-sm); border:1px solid rgba(255,255,255,.08); border-bottom:0;
  }
  @media (prefers-color-scheme: light){ .tabs button[aria-selected="true"]{border-color: rgba(16,24,40,.08)}}

  /* Contenido tabular */
  .tab-panel{ padding:12px; border:1px solid rgba(255,255,255,.08); border-radius:0 12px 12px 12px; background:linear-gradient(180deg,var(--surface),var(--surface-2)); box-shadow:var(--shadow-sm) }
  @media (prefers-color-scheme: light){ .tab-panel{border-color: rgba(16,24,40,.08)}}
  .desc{ color:var(--muted); line-height:1.65 }
  .table{
    width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid rgba(255,255,255,.08);
  }
  .table th, .table td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left }
  .table tr:last-child td{ border-bottom:0 }
  .table th{ background: var(--surface-2); font-size:12px; color:var(--muted) }

  /* Formulario de contacto */
  .form{
    display:grid; gap:10px;
  }
  .field{ display:grid; gap:6px }
  .field label{ font-size:13px; color:var(--muted) }
  .input, .textarea{
    background:var(--card); border:1px solid rgba(255,255,255,.10); border-radius:12px; padding:12px 14px; outline:none; width:100%;
  }
  .textarea{ min-height:120px; resize:vertical }
  .invalid{ border-color: var(--err) !important; }
  .hint{ font-size:12px; color:var(--muted) }
  .form .btn{ width:fit-content }

  /* Mapa simulado */
  .map{
    aspect-ratio: 4/3; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.06);
    background:
      radial-gradient(260px 120px at 75% 24%, rgba(10,124,255,.18), transparent),
      radial-gradient(200px 160px at 30% 70%, rgba(98,209,255,.18), transparent),
      linear-gradient(180deg, var(--surface), var(--surface-2));
    display:grid; place-items:center; color:#fff; font-weight:900; letter-spacing:.2px
  }

  /* Acciones sticky (CTA) */
  .sticky-cta{
    position:sticky; bottom:0; z-index:40; margin-top:10px;
    background: linear-gradient(180deg, rgba(12,14,18,.0), rgba(12,14,18,.55));
    padding-top:10px;
  }
  .sticky-cta .bar{
    background:linear-gradient(180deg,var(--surface),var(--surface-2)); border:1px solid rgba(255,255,255,.08);
    border-radius:12px; padding:10px; display:flex; align-items:center; justify-content:space-between; gap:10px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .sticky-cta .bar{border-color: rgba(16,24,40,.08)}}

  /* Impresi√≥n */
  @media print{
    .gallery-thumbs, .sticky-cta, #contactCard, .map, .tabs, .tab-actions{ display:none !important }
    .ficha{ grid-template-columns:1fr }
  }
</style>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 5
   Ficha de empresa con:
   - Galer√≠a (placeholder)
   - Tabs: Descripci√≥n, Horario, Servicios
   - Datos laterales: contacto breve, mapa simulado, chips
   - Formulario "Enviar consulta" con validaci√≥n
   ============================================================ */

/* ---------- Datos extendidos para fichas ---------- */
// ...existing code...
(function extendCompanyProfiles(){
  if(DATA.profiles) return;
  const lorem = "Somos un negocio local comprometido con la calidad y la atenci√≥n personalizada...";
  const defaultHours = [
    {d:'Lunes', h:'09:00‚Äì18:00'}, {d:'Martes', h:'09:00‚Äì18:00'}, {d:'Mi√©rcoles', h:'09:00‚Äì18:00'},
    {d:'Jueves', h:'09:00‚Äì18:00'}, {d:'Viernes', h:'09:00‚Äì18:00'}, {d:'S√°bado', h:'09:00‚Äì13:00'}, {d:'Domingo', h:''}
  ];

  DATA.profiles = {};
  for(const e of DATA.empresas){
    DATA.profiles[e.id] = {
      slogan: e.slogan || '',
      desc: e.desc || lorem,
      descripciones: e.descripciones || [],
      imgpresentacion: e.imgpresentacion || null,
       logo: e.logo || null,
       
       descripcion: e.descripcion || [],
      servicios: e.servicios || [
        'Atenci√≥n personalizada',
        'Entrega a domicilio',
        'Asesor√≠a previa a la compra',
        'Garant√≠a en productos/servicios'
      ],
      horario: e.horario || defaultHours,
      // ‚≠ê NUEVO: Campo para banner
      banner: e.banner || null, // ruta de imagen del banner

      telefono: e.telefono || ('+51 9' + Math.floor(10000000 + Math.random()*89999999)),
      email: e.email || `${Str.slug(e.nombre||'contacto')}@ejemplo.pe`,
      direccion: e.direccion || `${e.loc||'Lima'}, Per√∫`,
      web: e.web || ('https://impulsolocal/' + e.id),
      tags: [
        e.cat.replace(/-/g,' '),
        e.subcat ? e.subcat.replace(/-/g,' ') : 'general',
        e.loc||'Per√∫'
      ].slice(0,3),
      imagenes: e.galeria || (e.cover ? [e.cover] : Array.from({length:7}).map((_,i)=>`placeholder-${e.cat}-${i+1}`)),
      
      map: e.map || ''
      
    };
  }
})();
// ...existing code...

/* ---------- Utilidad: generar SVG placeholder ---------- */
function ph(width, height, label){
  const w = width||800, h = height||450;
  const text = encodeURIComponent(label||'Imagen');
  const grad1 = encodeURIComponent('#0a7cff');
  const grad2 = encodeURIComponent('#62d1ff');
  return `data:image/svg+xml;charset=utf-8,`+
   encodeURIComponent(
    `<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'>
      <defs>
        <linearGradient id='g' x1='0' x2='1'>
          <stop offset='0' stop-color='${grad2}'/><stop offset='1' stop-color='${grad1}'/>
        </linearGradient>
      </defs>
      <rect width='100%' height='100%' fill='url(#g)' opacity='.18'/>
      <rect x='6' y='6' width='${w-12}' height='${h-12}' rx='18' fill='none' stroke='white' opacity='.2'/>
      <g fill='white' opacity='.9' font-family='Inter, Arial' font-size='${Math.max(14, Math.floor(w/20))}' font-weight='800'>
        <text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle'>${text}</text>
      </g>
    </svg>`);
}

/* ---------- Vista: Ficha ---------- */
function viewEmpresaV5(ctx){
  const id = ctx.params?.id;
  const e = DATA.empresas.find(x=>x.id===id);
  const p = DATA.profiles?.[id];
  const container = $('#view-ficha');
  container.classList.remove('hide');

  if(!e || !p){
    renderHTML(container, `
      <h2>Empresa no encontrada</h2>
      <p class="lead">La ficha solicitada no existe.</p>
      <p><a class="btn" href="#/">‚¨Ö Volver</a></p>
    `);
    return;
  }

  // Breadcrumbs
  const migas = `
    <div class="breadcrumbs" style="margin-top:8px;margin-bottom:8px">
      <a class="chip" href="#/">üè† Inicio</a>
      <a class="chip" href="#/categorias">üóÇÔ∏è Categor√≠as</a>
      <a class="chip" href="#/categoria/${e.cat}">üè∑Ô∏è ${e.cat.replace(/-/g,' ')}</a>
      <span class="chip" aria-current="page">${e.nombre}</span>
    </div>`;
// ‚≠ê NUEVO: Banner superior (agregar ANTES del header)
  const bannerHtml = p.banner && p.banner.trim() 
    ? `<div class="empresa-banner">
         <img src="${p.banner}" alt="Banner de ${e.nombre}" loading="eager">
       </div>`
    : ''; // si no hay banner, no se muestra nada
  // Header de ficha
  const head = `
  <div class="ficha-head">

    <!-- LOGO -->
    ${renderLogo(e, 'large')}

    <!-- TITULO -->
    <div class="ficha-title">
      <h1>${e.nombre}</h1>
      ${e.slogan ? `<p class="empresa-slogan">${e.slogan}</p>` : ''}
      <div class="stars">
        <span class="chip">üìç ${e.loc || '‚Äî'}</span>
      </div>
    </div>

    <!-- üî• REDES SOCIALES SUPERIORES -->
    <div class="redes-superiores">
      ${ e.facebook  ? `<a href="${e.facebook}"  target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/124/124010.png"></a>` : '' }
      ${ e.instagram ? `<a href="${e.instagram}" target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/174/174855.png"></a>` : '' }
      ${ e.tiktok    ? `<a href="${e.tiktok}"    target="_blank"><img src="https://cdn-icons-png.flaticon.com/512/3046/3046121.png"></a>` : '' }
    </div>

    <!-- VERIFICACI√ìN -->
    <div class="verify">
      ${e.verificada
        ? `<span class="badge">Empresa verificada</span>`
        : `<span class="chip">No verificada</span>`
      }
    </div>

  </div>
`;

  // Galer√≠a: usar cover real o primera imagen de p.imagenes; thumbs respetan rutas reales
  const realImgs = Array.isArray(p.imagenes) ? p.imagenes : [];
  const mainSrc = (e.cover && e.cover.trim()) ? e.cover : (realImgs[0] || ph(1200, 675, e.nombre));
  const thumbs = realImgs.map((src,i)=>{
    const isReal = String(src).startsWith('images/') || String(src).startsWith('/');
    const thumbSrc = isReal ? src : ph(640, 480, `${e.nombre} ${i+1}`);
    return `<button class="thumb" type="button" data-index="${i}" data-src="${src}" aria-current="${i===0?'true':'false'}" title="Imagen ${i+1}">
      <img loading="lazy" alt="Imagen ${i+1} de ${e.nombre}" src="${thumbSrc}">
    </button>`;
  }).join('');
  const gal = `
    <div class="gallery">
      <div class="gallery-main">
        <img id="galMain" src="${mainSrc}" alt="Vista principal de ${e.nombre}" loading="eager" style="width:100%;height:100%;object-fit:cover" />
      </div>
      <div class="gallery-thumbs" id="galThumbs">${thumbs}</div>
    </div>
    
    `;


const imageDescription = `
  <div id="imageDescription" class="image-description" aria-live="polite">
    <h3 style="margin:0 0 6px 0; font-size:15px; color:var(--text);">Descripci√≥n</h3>
    <p id="imageDescriptionText" class="muted">Sin descripci√≥n para esta imagen.</p>
  </div>
`;
// al montar la secci√≥n de galer√≠a -> usa:
// output = gal + imageDescription + tabs
  // Tabs contenido
  const tabs = `
    <div class="tabs" role="tablist" aria-label="Informaci√≥n de ${e.nombre}">
      <button id="tabDesc" role="tab" aria-selected="true" aria-controls="panelDesc">Nosotros</button>
      <button id="tabHorario" role="tab" aria-selected="false" aria-controls="panelHorario">Horario</button>
      <button id="tabServicios" role="tab" aria-selected="false" aria-controls="panelServicios">Servicios</button>
    </div>
    <section id="panelDesc" class="tab-panel" role="tabpanel" aria-labelledby="tabDesc">
      <p class="desc">
  ${
    p.descripcion.length > 0
      ? p.descripcion.join('. ')
      : p.desc || 'Somos un negocio local comprometido con la calidad y la atenci√≥n personalizada.'
  }
</p>
      <div class="tags">${p.tags.map(t=>`<span class="chip">#${t}</span>`).join('')}</div>
    </section>
    <section id="panelHorario" class="tab-panel hide" role="tabpanel" aria-labelledby="tabHorario">
      <table class="table">
        <thead><tr><th>D√≠a</th><th>Horario</th></tr></thead>
        <tbody>
          ${p.horario.map(h=>`<tr><td>${h.d}</td><td>${h.h}</td></tr>`).join('')}
        </tbody>
      </table>
    </section>
    <section id="panelServicios" class="tab-panel hide" role="tabpanel" aria-labelledby="tabServicios">
      <ul style="margin:0;padding-left:18px">${p.servicios.map(s=>`<li>${s}</li>`).join('')}</ul>
      <div class="tab-actions" style="margin-top:10px">
        
      </div>
    </section>
  `;

  // Columna lateral: contacto + mapa
    // Si p.map est√° definido mostramos iframe embed, si no mostramos el mapa simulado
  const mapHtml = p.map && p.map.trim()
    ? `<div style="aspect-ratio: 4/3; border-radius:12px; overflow:hidden; border:1px solid rgba(255,255,255,.06);">
         <iframe src="${p.map}" width="100%" height="100%" style="border:0; display:block;" loading="lazy" referrerpolicy="no-referrer-when-downgrade" allowfullscreen></iframe>
       </div>`
    : `<div class="map" aria-label="Mapa simulado">MAPA</div>`;

  const side = `
    <aside>
      <div class="side-card">
        <h3>Datos de contacto</h3>
        <div class="info-list">
          <div class="fav-icon" data-id="${IL_EMPRESA}">‚ô°</div>
          <div class="info-row"><div class="k">Tel√©fono</div><div class="v"><a href="tel:${p.telefono}" class="btn btn-ghost">${p.telefono}</a></div></div>
          <div class="info-row"><div class="k">Correo</div><div class="v"><a href="mailto:${p.email}" class="chip">${p.email}</a></div></div>
          <div class="info-row"><div class="k">Vitrina digital</div><div class="v"><a href="${p.web}" target="_blank" rel="nofollow noopener" class="chip">${p.web.replace(/^https?:\/\//,'')}</a></div></div>
          <div class="info-row"><div class="k">Direcci√≥n</div><div class="v">${p.direccion}</div></div>
          
        </div>
      </div>

      <div class="side-card" style="margin-top:10px">
        <h3>Ubicaci√≥n</h3>
        ${mapHtml}
        <p class="hint" style="margin-top:8px">Abre en Google Maps para indicaciones exactas.</p>
      </div>

      <div id="contactCard" class="side-card" style="margin-top:10px;">
  <div class="form-container">
    <h3 id="contacto" style="margin-bottom:20px;">Enviar consulta</h3>
    
    <form id="contactForm" novalidate>
      <div class="form-group">
        <label for="nombre">Nombre</label>
        <input 
          type="text" 
          id="nombre" 
          name="nombre" 
          placeholder="Tu nombre completo"
          required
        >
        <span class="error-message" id="errorNombre">Este campo es obligatorio</span>
      </div>

      <div class="form-group">
        <label for="correo">Correo</label>
        <input 
          type="email" 
          id="correo" 
          name="correo" 
          placeholder="tucorreo@ejemplo.com"
          required
        >
        <span class="error-message" id="errorCorreo">Ingresa un correo v√°lido</span>
      </div>

      <div class="form-group">
        <label for="telefono">Tel√©fono (opcional)</label>
        <input 
          type="tel" 
          id="telefono" 
          name="telefono" 
          placeholder="+51 9XXXXXXXX"
        >
      </div>

      <div class="form-group">
        <label for="mensaje">Mensaje</label>
        <textarea 
          id="mensaje" 
          name="mensaje" 
          placeholder="Describe tu requerimiento..."
          required
        ></textarea>
        <span class="error-message" id="errorMensaje">Escribe tu consulta</span>
      </div>

      <div class="checkbox-group">
        <input type="checkbox" id="politica" name="politica" required>
        <label for="politica">Acepto la pol√≠tica de privacidad</label>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-whatsapp" id="btnWhatsApp">WhatsApp</button>
        <button type="button" class="btn btn-gmail" id="btnGmail">Gmail</button>
      </div>

      <div class="info-box">
        <strong id="IL_nombreEmpresaBox">Se enviar√° a: </strong>
        Elige tu m√©todo de contacto preferido.
Si usas correo, enviaremos tu consulta con los datos del formulario.  Por WhatsApp, el env√≠o ser√° autom√°tico.
      </div>

      <div class="badge">
        
        
        <span>üìç San Miguel</span>
        <span style="background: linear-gradient(90deg, #48bb78, #38a169); color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px;">Verificada</span>
      </div>
    </form>
  </div>
</div>


      
  `;
  // Montaje principal
  renderHTML(container, `
    <div>
      ${migas}
      ${bannerHtml}  <!-- ‚≠ê Agregar banner AQU√ç -->
      ${head}
      <div class="ficha" style="margin-top:10px">
        <section>
          ${gal}
          ${imageDescription}
          ${tabs}
        </section>
        ${side}
      </div>
      <p style="margin-top:12px"><a class="btn btn-ghost" href="#/categoria/${e.cat}">‚¨Ö Volver a ${e.cat.replace(/-/g,' ')}</a></p>
    </div>
  `);
// ‚úÖ LLAMAR A setupImageDescriptions despu√©s del renderizado
setTimeout(() => {
  setupImageDescriptions(e, p);
}, 100);
  // Interacciones: galer√≠a thumbs
  // ...existing code...
  const main = $('#galMain');
  const thumbsEl = $('#galThumbs');

  // Asegura que la imagen principal se ajuste sin recortar (letterbox)
  function setMainContain(){
    if(!main) return;
    main.style.objectFit = 'contain';
    main.style.backgroundColor = 'var(--surface-2)'; // color de letterbox
    main.style.width = '100%';
    main.style.height = '100%';
    main.style.display = 'block';
    main.style.transition = 'filter .22s ease, opacity .22s ease';
    // evitar que se aplique cache-bust por data: urls
    main.removeAttribute('data-no-observe');
  }
  setMainContain();

  // Manejo de clicks en thumbs: precargar y mostrar con contain (sin crop)
  thumbsEl?.addEventListener('click', (ev)=>{
    const b = ev.target.closest('.thumb'); if(!b) return;
    // marcar thumb activo
    thumbsEl.querySelectorAll('.thumb').forEach(t => t.setAttribute('aria-current','false'));
    b.setAttribute('aria-current','true');

    const src = (b.dataset.src || '').trim();
    const idx = Number(b.dataset.index || 0);
    const finalSrc = src ? src : ph(1200, 675, `${e.nombre} ¬∑ ${idx+1}`);

    // efecto de carga
    main.classList.add('img-ph'); // blur temporal
    // Preload seguro para evitar flashes y comprobar dimensiones
    const pre = new Image();
    pre.onload = () => {
      setMainContain();         // asegurar contain antes de asignar src
      // asignar src ya cargada (evita parpadeos)
      main.src = finalSrc;
      // quitar estado de carga cuando ya est√© lista
      setTimeout(()=> main.classList.remove('img-ph'), 80);
    };
    pre.onerror = () => {
      // fallback a placeholder si falla
      setMainContain();
      main.src = ph(1200, 675, e.nombre);
      main.classList.remove('img-ph');
    };
    // desencadena la carga
    pre.src = finalSrc;
  });

  // Mantener contain si la ventana cambia de tama√±o
  window.addEventListener('resize', debounce(()=> setMainContain(), 120));
// ...existing code...
  thumbsEl?.addEventListener('click', (ev)=>{
    const b = ev.target.closest('.thumb'); if(!b) return;
    // marcar thumb activo
    thumbsEl.querySelectorAll('.thumb').forEach(t => t.setAttribute('aria-current','false'));
    b.setAttribute('aria-current','true');

    // obtener ruta preferida (data-src ‚Üí real path; si no existe usar placeholder)
    const src = (b.dataset.src || '').trim();
    const idx = Number(b.dataset.index || 0);
    const finalSrc = src ? src : ph(1200, 675, `${e.nombre} ¬∑ ${idx+1}`);

    // efecto de carga: blur mientras carga
    try {
      main.classList.add('img-ph');
      // Forzar recarga even si es la misma ruta (cache bust si necesario)
      if(main.src === finalSrc){
        // si es la misma src, recargar forzando un peque√±o query param temporal
        const stamp = Date.now();
        main.src = finalSrc + (finalSrc.indexOf('data:') === 0 ? '' : `?v=${stamp}`);
      } else {
        main.src = finalSrc;
      }
      // cuando termine de cargar quitar el blur/placeholder class
      main.addEventListener('load', function _onLoad(){
        main.classList.remove('img-ph');
        main.removeEventListener('load', _onLoad);
      }, {once:true});
     main.addEventListener('error', function _onErr(){
       // si falla, mostrar placeholder legible
        main.classList.remove('img-ph');
        main.src = ph(1200, 675, e.nombre);
        main.removeEventListener('error', _onErr);
      }, {once:true});
    } catch (err) {
      // fallback silencioso
      main.src = finalSrc;
    }
  });
  // ...existing code...
  

  // Interacciones: tabs
  const tabsEls = [{btn:'#tabDesc', panel:'#panelDesc'}, {btn:'#tabHorario', panel:'#panelHorario'}, {btn:'#tabServicios', panel:'#panelServicios'}];
  tabsEls.forEach(({btn, panel})=>{
    document.querySelector(btn)?.addEventListener('click', ()=>{
      tabsEls.forEach(({btn:pbtn, panel:pp})=>{
        document.querySelector(pbtn)?.setAttribute('aria-selected','false');
        document.querySelector(pp)?.classList.add('hide');
      });
      document.querySelector(btn)?.setAttribute('aria-selected','true');
      document.querySelector(panel)?.classList.remove('hide');
    });
  });

  // Validaci√≥n simple del formulario
  const f = $('#contactForm');
  const sw = document.querySelector('#cfPolicy')?.nextElementSibling;
  document.querySelector('#cfPolicy')?.addEventListener('change', (e)=> sw.setAttribute('data-on', e.target.checked? '1':'0'));

  f?.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const form = new FormData(f);
    const name = String(form.get('name')||'').trim();
    const email = String(form.get('email')||'').trim();
    const phone = String(form.get('phone')||'').trim();
    const msg = String(form.get('msg')||'').trim();
    const policy = document.querySelector('#cfPolicy')?.checked;

    // Reset invalids
    ['#cfName','#cfEmail','#cfMsg'].forEach(sel => document.querySelector(sel)?.classList.remove('invalid'));

    let ok = true;
    if(name.length < 3){ ok=false; document.querySelector('#cfName').classList.add('invalid'); }
    const emailOk = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    if(!emailOk){ ok=false; document.querySelector('#cfEmail').classList.add('invalid'); }
    if(msg.length < 10){ ok=false; document.querySelector('#cfMsg').classList.add('invalid'); }
    if(!policy){ ok=false; Toast.show('Debes aceptar la pol√≠tica de privacidad','error'); }

    if(!ok){
      Toast.show('Por favor, completa los campos requeridos.','error');
      return;
    }

    // Simulaci√≥n de env√≠o
    const payload = { empresaId:id, empresa:e.nombre, name, email, phone, msg, ts: new Date().toISOString() };
    console.log('Lead simulado:', payload);
    Toast.show('Consulta enviada a la empresa.','ok');

    // Limpieza
    f.reset();
    sw?.setAttribute('data-on','0');
  }, {passive:false});
}


</script>
<!-- ======= BLOQUE 6: P√°ginas informativas + Acceso/Registro (UI est√°tica) ======= -->
<style>
  /* ==========================
     Bloque 6 ‚Äî Estilos p√°ginas est√°ticas y auth
     ========================== */

  /* Tarjeta gen√©rica */
  .card{
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:14px; box-shadow:var(--shadow-sm);
  }
  @media (prefers-color-scheme: light){ .card{border-color: rgba(16,24,40,.08)}}

  /* Layout est√°tico */
  .static-wrap{
    display:grid; grid-template-columns: 1.1fr .9fr; gap:14px;
  }
  @media (max-width: 980px){ .static-wrap{ grid-template-columns: 1fr } }

  .static-body{ display:grid; gap:12px }
  .static-body h1{ margin:0; font-size: clamp(22px, 4vw, 30px) }
  .static-body h2{ margin:14px 0 6px 0; font-size: 20px }
  .static-body p{ margin:0; color:var(--muted) }
  .static-body .list{ padding-left:18px; margin:0; color:var(--muted); line-height:1.7 }

  /* Bloques info */
  .info-block{
    display:flex; gap:10px; align-items:flex-start; border:1px dashed rgba(255,255,255,.14);
    border-radius:12px; padding:10px;
  }
  .info-icon{
    width:40px; height:40px; border-radius:10px; display:grid; place-items:center; color:#fff; font-weight:900;
    background:conic-gradient(from 180deg, var(--brand), var(--brand-2), var(--brand));
  }

  /* Side panel */
  .side{
    display:grid; gap:10px;
  }
  .side .item{ padding:12px; border-radius:14px; background:linear-gradient(180deg,var(--surface),var(--surface-2)); border:1px solid rgba(255,255,255,.08) }
  @media (prefers-color-scheme: light){ .side .item{border-color: rgba(16,24,40,.08)}}
  .side .item h3{ margin:0 0 8px 0; font-size:18px }
  .side .item p{ margin:0; color:var(--muted) }

  /* Auth UI */
  .auth{
    max-width: 560px; margin-inline:auto;
  }
  .auth h1{ margin:0 0 8px 0 }
  .auth .sub{ color:var(--muted); margin:0 0 12px 0 }
  .auth .form{ display:grid; gap:10px }
  .auth .row{ display:grid; gap:6px }
  .auth .row label{ font-size:13px; color:var(--muted) }
  .auth .input, .auth .select, .auth .textarea{ background:var(--card); border:1px solid rgba(255,255,255,.10) }
  .auth .hint{ font-size:12px; color:var(--muted) }
  .auth .actions{ display:flex; gap:8px; align-items:center; justify-content:space-between; flex-wrap:wrap }
  .auth .alt{ display:flex; gap:8px; flex-wrap:wrap }

  /* Password strength */
  .pw-meter{ display:grid; grid-template-columns: repeat(4,1fr); gap:6px; margin-top:6px }
  .pw-meter span{ height:6px; border-radius:999px; background: rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.08) }
  .pw-meter[data-score="1"] span:nth-child(-n+1){ background:#ef4444 }
  .pw-meter[data-score="2"] span:nth-child(-n+2){ background:#f59e0b }
  .pw-meter[data-score="3"] span:nth-child(-n+3){ background:#10b981 }
  .pw-meter[data-score="4"] span:nth-child(-n+4){ background:#0a7cff }

  .divider{ height:1px; background: rgba(255,255,255,.08); margin:10px 0 }
  @media (prefers-color-scheme: light){ .divider{ background: rgba(16,24,40,.08) } }

  /* Tabla legal */
  .legal-table{
    width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:12px; border:1px solid rgba(255,255,255,.08);
  }
  .legal-table th, .legal-table td{ padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); text-align:left; vertical-align:top }
  .legal-table tr:last-child td{ border-bottom:0 }
  .legal-table th{ background: var(--surface-2); font-size:12px; color:var(--muted); width:220px }
</style>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 6
   P√°ginas:
   - /sobre (qui√©nes somos + c√≥mo funciona)
   - /terminos (t√©rminos y condiciones)
   - /privacidad (pol√≠tica de privacidad)
   - /acceder (login UI est√°tica con validaci√≥n)
   - /registrar (registro UI, fuerza de contrase√±a)
   * Simulaci√≥n simple de "sesi√≥n" en localStorage (email)
   ============================================================ */

/* ---------- Simulaci√≥n Auth (localStorage) ---------- */
const Auth = (() => {
  const KEY = 'IL_AUTH_EMAIL_V1';
  function isLogged(){ return !!localStorage.getItem(KEY); }
  function login(email){ localStorage.setItem(KEY, String(email||'')); }
  function logout(){ localStorage.removeItem(KEY); }
  function me(){ return localStorage.getItem(KEY)||''; }
  return { isLogged, login, logout, me };
})();

/* ---------- Helpers de UI ---------- */
function heroBreadcrumbs(items){
  return `
    <div class="breadcrumbs" style="margin-top:8px">
      ${items.map((it,i)=>{
        const last = i===items.length-1;
        return last
          ? `<span class="chip" aria-current="page">${it.label}</span>`
          : `<a class="chip" href="${it.href||'#/'}">${it.icon||''} ${it.label}</a>`;
      }).join('')}
    </div>`;
}

function sideLinks(){
  return `
    <div class="item">
      <h3>Accesos r√°pidos</h3>
      <div style="display:flex; gap:8px; flex-wrap:wrap">
        <a class="btn btn-ghost" href="#/categorias">Explorar categor√≠as</a>
        <a class="btn btn-ghost" href="#/buscar">Buscar negocios</a>
        <a class="btn" href="#/registrar">Registrar empresa</a>
      </div>
    </div>
    <div class="item">
      <h3>¬øNecesitas ayuda?</h3>
      <p>Escr√≠benos a <a class="chip" href="mailto:soporte@ImpulsoLocal">soporte@ImpulsoLocal</a></p>
      <p class="hint">Tiempo de respuesta estimado: 24‚Äì48 h h√°biles.</p>
    </div>
  `;
}

/* ---------- Vista: Sobre ---------- */
function viewSobre(){
  const el = $('#view-static');
  el.classList.remove('hide');
  const body = `
    <div class="card static-body">
      <h1>Sobre ImpulsoLocal</h1>
      <p>Nuestro objetivo es <strong>conectar negocios locales con personas</strong> que buscan soluciones cercanas, confiables y claras. Impulsamos la visibilidad de pymes con perfiles completos y herramientas sencillas.</p>

      <div class="info-block">
        <div class="info-icon">üöÄ</div>
        <div>
          <h2 style="margin:0 0 6px 0">¬øQu√© encontrar√°s aqu√≠?</h2>
          <ul class="list">
            <li>Buscador r√°pido por rubro, ubicaci√≥n y palabras clave.</li>
            <li>Perfiles de empresas con descripci√≥n, horario y contacto.</li>
            <li>Etiquetas de <strong>empresa verificada</strong> </li>
          </ul>
        </div>
      </div>

      <div class="info-block">
        <div class="info-icon">üß≠</div>
        <div>
          <h2 style="margin:0 0 6px 0">¬øC√≥mo funciona?</h2>
          <ol class="list">
            <li>Explora categor√≠as o usa el buscador.</li>
            <li>Revisa la ficha del negocio y solicita una cotizaci√≥n.</li>
            <li>Contacta directamente y concluye tu compra fuera de la plataforma.</li>
          </ol>
        </div>
      </div>

      <div class="info-block">
        <div class="info-icon">üõ°Ô∏è</div>
        <div>
          <h2 style="margin:0 0 6px 0">Verificaci√≥n de negocios</h2>
          <p>Marcamos como ‚ÄúVerificada‚Äù a los negocios que han validado informaci√≥n clave ( contacto, actividad). Este proceso es gradual y puede requerir documentaci√≥n adicional.</p>
        </div>
      </div>
    </div>
  `;
  const side = `
    <div class="side">
      <div class="item">
        <h3>Cont√°ctanos</h3>
        <p>Correo: <a class="chip" href="mailto:hola@impulsolocal">hola@impulsolocal</a></p>
        <p>Horario: Lun‚ÄìVie 9:00‚Äì18:00</p>
      </div>
      ${sideLinks()}
    </div>
  `;
  el.innerHTML = `
    <div>
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap">
        <div>
          <h1 style="margin:0">Sobre</h1>
          <p class="lead" style="margin:4px 0 0 0">Qui√©nes somos y c√≥mo te ayudamos a impulsar tu negocio.</p>
        </div>
      </div>
      ${heroBreadcrumbs([{label:'Inicio', href:'#/', icon:'üè†'},{label:'Sobre'}])}
      <div class="static-wrap" style="margin-top:10px">
        ${body}
        ${side}
      </div>
      <p style="margin-top:12px"><a class="btn btn-ghost" href="#/">‚¨Ö Volver</a></p>
    </div>
  `;
}

/* ---------- Vista: T√©rminos ---------- */
function viewTerminos(){
  const el = $('#view-static');
  el.classList.remove('hide');
  const legal = `
    <table class="legal-table">
      <tbody>
        <tr>
          <th>Uso permitido</th>
          <td>Queda permitido navegar, buscar y contactar a empresas listadas. No se permite el uso automatizado abusivo, scraping masivo ni actividades que afecten la disponibilidad.</td>
        </tr>
        <tr>
          <th>Contenido de terceros</th>
          <td>Los perfiles y datos de empresas pueden ser provistos por terceros. No garantizamos la exactitud o disponibilidad de dichos datos.</td>
        </tr>
        <tr>
          <th>Limitaci√≥n de responsabilidad</th>
          <td>ImpulsoLocal no participa en la transacci√≥n final entre usuarios y empresas. Toda compra/servicio se realiza fuera de la plataforma bajo responsabilidad de las partes.</td>
        </tr>
        <tr>
          <th>Propiedad intelectual</th>
          <td>El dise√±o y c√≥digo de la plataforma son propiedad de sus autores. Las marcas y logos pertenecen a sus due√±os.</td>
        </tr>
        <tr>
          <th>Modificaciones</th>
          <td>Podemos actualizar estos t√©rminos en cualquier momento. La fecha de √∫ltima actualizaci√≥n se mostrar√° en esta p√°gina.</td>
        </tr>
      </tbody>
    </table>
    <p class="hint" style="margin-top:8px">√öltima actualizaci√≥n: <strong id="legalDate"></strong></p>
  `;
  el.innerHTML = `
    <div>
      <h1 style="margin:0">T√©rminos y condiciones</h1>
      <p class="lead" style="margin:4px 0 10px 0">Lee atentamente antes de usar ImpulsoLocal</p>
      ${heroBreadcrumbs([{label:'Inicio', href:'#/', icon:'üè†'},{label:'T√©rminos'}])}
      <div class="card" style="margin-top:10px">${legal}</div>
      <p style="margin-top:12px"><a class="btn btn-ghost" href="#/">‚¨Ö Volver</a></p>
    </div>
  `;
  $('#legalDate').textContent = new Date().toLocaleDateString('es-PE', {year:'numeric', month:'long', day:'2-digit'});
}

/* ---------- Vista: Privacidad ---------- */
function viewPrivacidad(){
  const el = $('#view-static');
  el.classList.remove('hide');
  const body = `
    <div class="card static-body">
      <h1>Pol√≠tica de privacidad</h1>
      <p>En ImpulsoLocal nos tomamos en serio tu privacidad. Esta pol√≠tica describe qu√© datos recolectamos y c√≥mo los usamos.</p>
      <h2>Datos que recopilamos</h2>
      <ul class="list">
        <li>Consultas de b√∫squeda (para mejorar resultados de forma agregada).</li>
        <li>Informaci√≥n de contacto enviada en formularios a empresas (solo se comparte con el destinatario elegido).</li>
        <li>Datos opcionales de registro (nombre, email).</li>
      </ul>
      <h2>C√≥mo usamos los datos</h2>
      <ul class="list">
        <li>Mejorar la experiencia de b√∫squeda y la calidad del listado.</li>
        <li>Permitir que las empresas respondan a tus consultas.</li>
        <li>Comunicar cambios relevantes del servicio.</li>
      </ul>
      <h2>Tus derechos</h2>
      <ul class="list">
        <li>Acceder, rectificar o eliminar tus datos solicit√°ndolo a <a class="chip" href="mailto:privacidad@ImpulsoLocal">privacidad@ImpulsoLocal</a>.</li>
        <li>Revocar consentimientos no esenciales.</li>
      </ul>
      <p class="hint">No vendemos datos personales. Usamos almacenamiento local del navegador para preferencias b√°sicas.</p>
    </div>
  `;
  const side = `
    <div class="side">
      <div class="item">
        <h3>Preferencias</h3>
        <p>Tu idioma, tema del sistema y √∫ltimas b√∫squedas se guardan localmente en tu navegador.</p>
      </div>
      ${sideLinks()}
    </div>
  `;
  el.innerHTML = `
    <div>
      <h1 style="margin:0">Privacidad</h1>
      <p class="lead" style="margin:4px 0 10px 0">Transparencia en el tratamiento de tus datos.</p>
      ${heroBreadcrumbs([{label:'Inicio', href:'#/', icon:'üè†'},{label:'Privacidad'}])}
      <div class="static-wrap" style="margin-top:10px">
        ${body}
        ${side}
      </div>
      <p style="margin-top:12px"><a class="btn btn-ghost" href="#/">‚¨Ö Volver</a></p>
    </div>
  `;
}



/* ---------- Vista: Favoritos ---------- */
function viewFavoritos(){
  const el = $('#view-static');
  el.classList.remove('hide');

  // Obtener favoritos
  const favs = JSON.parse(localStorage.getItem("FAV_EMPRESAS") || "[]");

  // Construcci√≥n base de la vista
  let html = `
    <div class="auth card">
      <h1>Mis Favoritos</h1>
      <p class="sub">Aqu√≠ se muestran los negocios que marcaste con üß°.</p>
      ${heroBreadcrumbs([{label:'Inicio', href:'#/', icon:'üè†'},{label:'Favoritos'}])}
  `;

  // Si no hay favoritos
  if (favs.length === 0) {

    html += `
      <div class="empty-state" style="margin-top:20px;">
        <p>A√∫n no tienes empresas favoritas.</p>
        <p class="sub">Marca el coraz√≥n en una empresa para agregarla aqu√≠.</p>
        <a class="btn btn-ghost" href="#/">Ir al inicio</a>
      </div>
    </div>
    `;

    el.innerHTML = html;
    return;
  }

  // Si hay favoritos
  html += `<div class="fav-list" style="margin-top:20px;">`;

  favs.forEach(id => {
    const emp = DATA.empresas.find(e => e.id === id);
    if (!emp) return;

    html += `
      <div class="empresa-card" data-id="${emp.id}"
        style="
          border:1px solid #e0e0e0;
          border-radius:12px;
          padding:14px;
          margin-bottom:14px;
          background:#fff;
          cursor:pointer;
          transition:0.2s;
        ">
        <strong>${emp.nombre}</strong><br>
        <small>${emp.loc || ''}</small>
      </div>
    `;
  });

  html += `
      </div>
    </div>
  `;

  el.innerHTML = html;

  // Acci√≥n al hacer clic en una empresa
  document.querySelectorAll(".empresa-card").forEach(card => {
    card.addEventListener("click", () => {
      const id = card.getAttribute("data-id");
      window.location.hash = `#/empresa/${id}`;
      window.location.reload();
    });
  });
}


/* ---------- Vista: Registrar ---------- */
function viewRegistrar(){
  const el = $('#view-static');
  el.classList.remove('hide');

  el.innerHTML = `
    <div class="auth card">
      <h1>Crear cuenta</h1>
      <p class="sub">Reg√≠strate para administrar el perfil de tu empresa.</p>
      ${heroBreadcrumbs([{label:'Inicio', href:'#/', icon:'üè†'},{label:'Registrar'}])}
      <form id="regForm" class="form" novalidate>
        <div class="row">
          <label for="rgName">Nombre y apellidos</label>
          <input id="rgName" class="input" placeholder="Tu nombre completo" required />
        </div>
        <div class="row">
          <label for="rgEmail">Correo electr√≥nico</label>
          <input id="rgEmail" class="input" inputmode="email" placeholder="tucorreo@ejemplo.com" required />
        </div>
        <div class="row">
          <label for="rgPass">Contrase√±a</label>
          <input id="rgPass" class="input" type="password" placeholder="M√≠nimo 0 caracteres" required />
          <div class="pw-meter" id="pwMeter" data-score="0"><span></span><span></span><span></span><span></span></div>
          <div class="hint">Usa may√∫sculas, min√∫sculas, n√∫meros y s√≠mbolos.</div>
        </div>
        <div class="row">
          <label class="pill" style="gap:10px; cursor:pointer">
            <input id="rgPolicy" type="checkbox" class="sr-only" />
            <span aria-hidden="true" class="switch" data-on="0"></span>
            <span>Acepto t√©rminos y privacidad</span>
          </label>
        </div>
        <div class="actions">
          <div class="alt">
            <button class="btn" type="submit">Crear cuenta</button>
            <a class="btn btn-ghost" href="#/acceder">Ya tengo cuenta</a>
          </div>
          <a class="chip" href="#/terminos">Leer t√©rminos</a>
        </div>
      </form>
      <div class="divider"></div>
      <p class="hint">Al registrarte, confirmas que la informaci√≥n proporcionada es veraz y que representas a la empresa o cuentas con autorizaci√≥n para gestionarla.</p>
    </div>
  `;

  const pass = $('#rgPass');
  const meter = $('#pwMeter');
  pass?.addEventListener('input', ()=>{
    const s = scorePassword(pass.value);
    meter?.setAttribute('data-score', String(s));
  });

  const rgPolicy = $('#rgPolicy');
  const sw = rgPolicy?.nextElementSibling;
  rgPolicy?.addEventListener('change', (e)=> sw?.setAttribute('data-on', e.target.checked? '1':'0'));

  $('#regForm')?.addEventListener('submit', (ev)=>{
    ev.preventDefault();
    const name = $('#rgName').value.trim();
    const email = $('#rgEmail').value.trim();
    const pw = $('#rgPass').value;
    const okName = name.length>=3;
    const okEmail = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
    const okPw = pw.length>=8 && scorePassword(pw)>=3;
    const okPol = $('#rgPolicy').checked;
    if(!(okName && okEmail && okPw && okPol)){
      Toast.show('Completa los campos y acepta t√©rminos.','error');
      return;
    }
    // Simulaci√≥n: iniciar sesi√≥n autom√°tica
    Auth.login(email);
    Toast.show('Cuenta creada. ¬°Bienvenido/a!','ok');
    App.Router.go('#/acceder');
  });
}


</script>
<!-- ======= BLOQUE 7: Pulido visual + micro-animaciones + accesibilidad + rendimiento ======= -->
<style>
  /* ==========================
     Bloque 7 ‚Äî Visual polish, a11y y performance
     ========================== */

  /* Skip link */
  .skip-link{
    position:absolute; left:-9999px; top:auto; width:1px; height:1px; overflow:hidden;
  }
  .skip-link:focus{
    position:fixed; left:10px; top:10px; width:auto; height:auto; padding:8px 12px; z-index:100;
    background:var(--surface); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px;
    box-shadow:var(--shadow);
  }

  /* Enfoque visible y accesible */
  :where(a,button,[role="button"],.select,.input,.textarea,.chip,.badge):focus-visible{
    outline:none; box-shadow: var(--ring);
  }

  /* Micro-animaciones (desactivables por reduced-motion) */
  @media (prefers-reduced-motion: no-preference){
    .btn, .chip, .cat-card, .card-company, .list-item{
      transition: transform .16s ease, background .16s ease, box-shadow .16s ease, border-color .16s ease, opacity .16s ease;
    }
    .btn:hover{ transform: translateY(-1px) }
    .cat-card:hover, .card-company:hover, .list-item:hover{ transform: translateY(-2px) }
    .badge{ transition: transform .16s ease }
    .badge:hover{ transform: translateY(-1px) }
  }

  /* Transiciones de ruta */
  .route{
    view-transition-name: route; /* algunos navegadores soportan */
    opacity: 0; transform: translateY(6px);
  }
  .route.is-enter{
    opacity: 1; transform: translateY(0);
    transition: opacity .18s ease, transform .18s ease;
  }
  @media (prefers-reduced-motion: reduce){
    .route{ opacity:1; transform:none }
    .route.is-enter{ transition:none }
  }

  /* Efecto ‚Äúreveal‚Äù al aparecer en viewport */
  .reveal{ opacity:0; transform: translateY(8px) }
  .reveal.reveal--in{ opacity:1; transform:none; transition: opacity .25s ease, transform .25s ease }

  /* Tooltips m√≠nimos usando atributo [data-tip] */
  [data-tip]{ position:relative }
  [data-tip]::after{
    content: attr(data-tip);
    position:absolute; left:50%; bottom: calc(100% + 8px);
    transform: translateX(-50%); pointer-events:none; white-space:nowrap;
    background: var(--surface); color: var(--text); border:1px solid rgba(255,255,255,.12); border-radius:8px;
    padding:6px 8px; font-size:12px; opacity:0; translate: 0 4px; transition: opacity .12s ease, translate .12s ease;
    box-shadow: var(--shadow-sm); visibility:hidden;
  }
  [data-tip]:hover::after, [data-tip]:focus-visible::after{
    opacity:1; translate: 0 0; visibility:visible;
  }

  /* Bot√≥n volver arriba */
  .to-top{
    position:fixed; right:16px; bottom:166px; z-index:60; opacity:0; pointer-events:none;
    transition: opacity .18s ease, transform .18s ease; transform: translateY(6px);
  }
  .to-top.is-shown{ opacity:1; pointer-events:auto; transform:none }

  /* Sombra del header cuando haces scroll */
  .site.has-shadow{
    box-shadow: 0 6px 18px rgba(0,0,0,.28);
  }

  /* content-visibility para mejorar performance en secciones grandes */
  #home, #view-listado, #view-ficha, #view-static{
    content-visibility: auto;
    contain-intrinsic-size: 600px; /* tama√±o estimado, evita saltos grandes */
  }

  /* Estados de carga de im√°genes (progressive reveal) */
  .img-ph{
    filter: blur(10px); transform: scale(1.02); opacity:.8;
    transition: filter .25s ease, transform .25s ease, opacity .25s ease;
  }
  .img-ph.is-ready{
    filter: blur(0); transform: none; opacity:1;
  }

  /* Overlays y ayuda r√°pida */
  .hint-overlay{
    position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; place-items:center; z-index:80;
    padding:16px;
  }
  .hint-card{
    max-width: 720px; width:100%;
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:14px; box-shadow:var(--shadow-lg);
  }
  .hint-card h3{ margin:0 0 8px 0 }
  .hint-card kbd{
    background: var(--surface-2); border:1px solid rgba(255,255,255,.12); border-radius:6px; padding:2px 6px; font-family:var(--mono); font-size:12px
  }

  /* Mejora del ‚Äústicky-cta‚Äù en iOS/Android */
  .sticky-cta .bar{ -webkit-backdrop-filter: saturate(1.1) blur(6px); backdrop-filter: saturate(1.1) blur(6px) }
</style>

<!-- Skip link para a11y -->
<a href="#app" class="skip-link">Saltar al contenido principal</a>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 7
   - Transiciones de ruta + reveal on scroll
   - Observers: scroll header, lazy images mejorado
   - Accesibilidad: announcer aria-live, skip link, focus mgmt
   - UX: bot√≥n ‚Äúvolver arriba‚Äù, tooltips, atajos de teclado
   - Rendimiento: content-visibility, scroll/route state
   ============================================================ */

(function setupA11yAndPerf(){
  /* ---------- Announcer (aria-live) para mensajes y navegaci√≥n ---------- */
  let announcer = document.getElementById('sr-announce');
  if(!announcer){
    announcer = document.createElement('div');
    announcer.id = 'sr-announce';
    announcer.className = 'sr-only';
    announcer.setAttribute('aria-live','polite');
    announcer.setAttribute('aria-atomic','true');
    document.body.appendChild(announcer);
  }
  function announce(msg){ announcer.textContent = msg; }
  window.Announce = announce;

  /* ---------- Header shadow al hacer scroll ---------- */
  const header = document.querySelector('header.site');
  const onScroll = ()=>{
    const y = window.scrollY || document.documentElement.scrollTop || 0;
    header.classList.toggle('has-shadow', y > 6);
    toTopBtn.classList.toggle('is-shown', y > 280);
  };
  document.addEventListener('scroll', onScroll, {passive:true});

  /* ---------- Bot√≥n volver arriba ---------- */
  const toTopBtn = document.createElement('button');
  toTopBtn.className = 'btn to-top';
  toTopBtn.id = 'btnToTop';
  toTopBtn.innerHTML = '‚Üë Arriba';
  toTopBtn.setAttribute('data-tip','Volver arriba');
  toTopBtn.addEventListener('click', ()=>{
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    window.scrollTo({ top:0, behavior: prefersReduced ? 'auto' : 'smooth' });
  });
  document.body.appendChild(toTopBtn);

  /* ---------- Intersection Observer: reveal ---------- */
  const revealObserver = new IntersectionObserver((entries)=>{
    for(const e of entries){
      if(e.isIntersecting){
        e.target.classList.add('reveal--in');
        revealObserver.unobserve(e.target);
      }
    }
  }, {rootMargin:'0px 0px -10% 0px', threshold: 0.05});

  // Marcar elementos iniciales como reveal
  const markReveal = (scope=document) => {
    scope.querySelectorAll('.cat-card, .card-company, .list-item, .kpi, .side-card, .card, .gallery, .ficha-head').forEach(el=>{
      el.classList.add('reveal'); revealObserver.observe(el);
    });
  };

  /* ---------- Lazy images: efecto progressive ---------- */
  const imgObserver = new IntersectionObserver((entries)=>{
    for(const it of entries){
      if(!it.isIntersecting) continue;
      const img = it.target;
      const src = img.dataset.src || img.getAttribute('src'); // soporta data-src
      if(!src){ imgObserver.unobserve(img); continue; }
      // a√±adir clase ‚Äúimg-ph‚Äù y cuando cargue quitar blur
      img.classList.add('img-ph');
      if(img.dataset.src) img.src = src;
      if(img.complete){ img.classList.add('is-ready'); }
      else{
        img.addEventListener('load', ()=> img.classList.add('is-ready'), {once:true});
        img.addEventListener('error', ()=> img.classList.remove('img-ph'), {once:true});
      }
      imgObserver.unobserve(img);
    }
  }, {rootMargin:'120px 0px', threshold: 0.01});

  const trackImages = (scope=document) => {
    scope.querySelectorAll('img:not([data-no-observe])').forEach(img=> imgObserver.observe(img));
  };

  /* ---------- Transici√≥n de rutas + gesti√≥n de foco ---------- */
  const views = ['#home','#view-listado','#view-ficha','#view-static'];
  function applyRouteTransition(){
    views.forEach(sel=>{
      const el = document.querySelector(sel);
      if(!el) return;
      el.classList.add('route');
      // Cuando se muestre una vista, forzamos reflow y le aplicamos is-enter
      if(!el.classList.contains('hide')){
        // primer elemento con tabindex o encabezado para foco
        requestAnimationFrame(()=>{
          el.classList.add('is-enter');
          // foco: busquemos un h1/h2 o el contenedor
          const h = el.querySelector('h1, h2, [role="heading"]') || el;
          if(h && document.activeElement === document.body){
            h.setAttribute('tabindex','-1');
            h.focus({preventScroll:true});
          }
        });
      }else{
        el.classList.remove('is-enter');
      }
    });
  }

  /* ---------- Guardar/restaurar posici√≥n de scroll por ruta ---------- */
  const scrollMap = new Map();
  function saveScrollFor(hash){ scrollMap.set(hash||'#/', window.scrollY || 0); }
  function restoreScrollFor(hash){
    const y = scrollMap.get(hash||'#/') || 0;
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    window.scrollTo({ top:y, behavior: prefersReduced ? 'auto' : 'smooth' });
  }

  // Hookear Router si existe
  document.addEventListener('DOMContentLoaded', ()=>{
    const Router = window.App?.Router;
    if(!Router){
      // Si a√∫n no est√°, reintenta en el pr√≥ximo tick
      setTimeout(()=>setupRouterHooks(), 0);
    }else{
      setupRouterHooks();
    }
  });

  function setupRouterHooks(){
    const Router = window.App?.Router;
    if(!Router || setupRouterHooks._done) return;
    setupRouterHooks._done = true;

    // Interceptar navegaci√≥n por hash
    const origDispatch = Router.dispatch;
    Router.dispatch = function(){
      // guardar scroll de ruta anterior
      saveScrollFor(window._lastHash);
      origDispatch.apply(Router, arguments);
      // anunciar y transicionar
      const hash = location.hash || '#/';
      const path = hash.replace(/^#/, '').split('?')[0] || '/';
      Announce?.(`Navegaste a ${path==='/'?'Inicio':path.replace('/','')}`);
      applyRouteTransition();
      restoreScrollFor(hash);
      // marcar reveals y observar im√°genes despu√©s de render
      setTimeout(()=>{
        markReveal(document);
        trackImages(document);
      }, 0);
      window._lastHash = hash;
    };

    // Primera ejecuci√≥n
    window._lastHash = location.hash || '#/';
    applyRouteTransition();
    markReveal(document);
    trackImages(document);
  }

  /* ---------- Prefocus buscador con "/" y atajos "g" ---------- */
  const keyState = { g:false };
  document.addEventListener('keydown', (ev)=>{
    // Evitar en inputs
    const tag = document.activeElement?.tagName?.toLowerCase();
    const typing = tag==='input' || tag==='textarea' || document.activeElement?.isContentEditable;
    if(ev.key === '/' && !typing){
      ev.preventDefault();
      const q = document.querySelector('#q');
      if(q){ q.focus(); Announce?.('Buscador enfocado'); }
      return;
    }
    // g h ‚Üí home | g c ‚Üí categor√≠as | g s ‚Üí buscar
    if(ev.key === 'g' && !typing){ keyState.g = true; return; }
    if(keyState.g){
      if(ev.key.toLowerCase() === 'h'){ ev.preventDefault(); App?.Router?.go('#/'); Announce?.('Ir a inicio'); }
      if(ev.key.toLowerCase() === 'c'){ ev.preventDefault(); App?.Router?.go('#/categorias'); Announce?.('Ir a categor√≠as'); }
      if(ev.key.toLowerCase() === 's'){ ev.preventDefault(); App?.Router?.go('#/buscar'); Announce?.('Ir a buscar'); }
    }
  });
  document.addEventListener('keyup', (ev)=>{ if(ev.key==='g') keyState.g=false; });

  /* ---------- Overlay de ayuda "?" ---------- */
  const overlay = document.createElement('div');
  overlay.className = 'hint-overlay';
  overlay.innerHTML = `
    <div class="hint-card">
      <h3>Atajos y ayuda</h3>
      <p class="lead">Navega m√°s r√°pido con estos atajos:</p>
      <ul style="margin:0; padding-left:18px; line-height:1.8">
        <li><kbd>/</kbd> Enfocar buscador</li>
        <li><kbd>g</kbd> luego <kbd>h</kbd> ‚Üí Inicio</li>
        <li><kbd>g</kbd> luego <kbd>c</kbd> ‚Üí Categor√≠as</li>
        <li><kbd>g</kbd> luego <kbd>s</kbd> ‚Üí Buscar</li>
        <li>Haz clic en <kbd>üîó</kbd> para copiar enlace de resultados</li>
      </ul>
      <div style="display:flex;justify-content:flex-end;margin-top:10px">
        <button class="btn btn-ghost" id="closeHint">Cerrar</button>
      </div>
    </div>`;
  document.body.appendChild(overlay);
  function openHint(){ overlay.style.display='grid'; }
  function closeHint(){ overlay.style.display='none'; }
  overlay.addEventListener('click', (e)=>{ if(e.target===overlay || e.target.id==='closeHint') closeHint(); });
  document.addEventListener('keydown', (ev)=>{ if(ev.key==='?' && !ev.shiftKey){ openHint(); }});

  // A√±adir ayuda al footer versi√≥n
  const vBadge = document.querySelector('footer .mono');
  if(vBadge){
    vBadge.innerHTML = `${vBadge.textContent} ¬∑ <button class="chip btn-ghost" id="openHint" type="button" data-tip="Ver atajos">Ayuda</button>`;
    document.getElementById('openHint')?.addEventListener('click', openHint);
  }

  /* ---------- Hover pre-carga sencilla: si el enlace es interno, no hace nada (sin redes) ----------
     (placeholder para extensiones futuras; no usamos fetch para evitar CORS) */
})();

/* ============================================================
   Mejora de Home: animar KPIs y chips + tooltips
   ============================================================ */
(function enhanceHomeUX(){
  const kpiEls = ['#kpiEmpresas','#kpiCategorias','#kpiResenas'].map(sel=>document.querySelector(sel)).filter(Boolean);
  if(!kpiEls.length) return;

  // Contador animado (simple)
  function animateCount(el, to){
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    if(prefersReduced){ el.textContent = App ? App.numberFmt?.(to) || to : to; return; }
    const start = 0;
    const dur = 600; // ms
    const t0 = performance.now();
    function step(t){
      const k = Math.min(1, (t - t0)/dur);
      const val = Math.round(start + (to - start)*k);
      el.textContent = new Intl.NumberFormat('es-PE').format(val);
      if(k < 1) requestAnimationFrame(step);
    }
    requestAnimationFrame(step);
  }

  // Si estamos en Home, activar animaci√≥n una vez visible
  const home = document.querySelector('#home');
  if(!home) return;
  const obs = new IntersectionObserver((entries)=>{
    for(const en of entries){
      if(!en.isIntersecting) continue;
      animateCount(kpiEls[0], DATA.empresas.length);
      animateCount(kpiEls[1], DATA.categorias.length);
      const totalReviews = DATA.empresas.reduce((a,e)=>a+(e.reviews||0),0);
      animateCount(kpiEls[2], totalReviews);
      obs.disconnect();
    }
  }, {threshold:.2});
  obs.observe(home);

  // Tooltips en chips ‚Äúm√°s buscados‚Äù
  document.querySelectorAll('[data-quick]').forEach(b => b.setAttribute('data-tip','Rellenar buscador'));

  // Cargar im√°genes con el observer del bloque 7 (si existen)
  setTimeout(()=> {
    document.querySelectorAll('img').forEach(img => img.setAttribute('loading','lazy'));
  }, 0);
})();

/* ============================================================
   Mejora de listados y ficha: data-tip y reveals en nuevas tarjetas
   ============================================================ */
(function polishListsAndDetail(){
  // Cuando Router navegue, a√±adir tooltips a botones clave
  function enhanceCurrentView(){
    // Botones de compartir si existen
    document.querySelectorAll('#btnShare').forEach(b => b.setAttribute('data-tip','Copiar enlace'));
    // Botones de vista
    document.querySelectorAll('#viewGrid,#viewList,#viewGridC,#viewListC').forEach(b => b.setAttribute('data-tip','Cambiar vista'));
    // En fichas: CTA
    document.querySelectorAll('.sticky-cta a.btn, .sticky-cta a.btn-ghost').forEach(a=> a.setAttribute('data-tip','Acci√≥n r√°pida'));
    // A√±adir clase reveal a elementos reci√©n renderizados
    document.querySelectorAll('#view-listado .grid-list > * , #view-listado .list-item, #view-ficha .side-card').forEach(el => el.classList.add('reveal'));
  }

  // Hook a Router si existe
  const Router = window.App?.Router;
  if(Router){
    const origDispatch = Router.dispatch;
    Router.dispatch = function(){
      origDispatch.apply(Router, arguments);
      setTimeout(enhanceCurrentView, 0);
    };
    // primera pasada
    setTimeout(enhanceCurrentView, 60);
  }else{
    // fallback si a√∫n no existe Router
    document.addEventListener('DOMContentLoaded', ()=> setTimeout(enhanceCurrentView, 120));
  }
})();

/* ============================================================
   Peque√±as utilidades p√∫blicas a√±adidas a App (sin romper API)
   ============================================================ */
(function extendApp(){
  if(!window.App) window.App = {};
  if(!App.numberFmt){
    App.numberFmt = function(n){ return new Intl.NumberFormat('es-PE',{maximumFractionDigits:0}).format(n); };
  }
})();
</script>
<!-- ======= BLOQUE 8: Dataset ampliado (40‚Äì80 negocios) + Modo impresi√≥n + utilidades de prueba ======= -->
<style>
  /* ==========================
     Bloque 8 ‚Äî Estilos impresi√≥n y utilidades
     ========================== */

  /* Print-friendly */
  @media print{
    body{ background:white !important; color:#000 !important; -webkit-print-color-adjust:exact; print-color-adjust:exact }
    header.site, footer.site, .sticky-cta, .breadcrumbs, .results-bar, .toolbar, .pager, .tab-actions, .gallery-thumbs,
    #recentMount, #recentMountCat, #moreMount, #moreCat, .to-top, .hint-overlay, #devPanel { display:none !important }
    .ficha{ grid-template-columns:1fr !important }
    .ficha-head{ border-color:#000 !important }
    .tab-panel{ border-color:#000 !important }
    .chip, .badge{ border:1px solid #000 !important; color:#000 !important; background:#fff !important; box-shadow:none !important }
    .map{ border-color:#000 !important }
    .card-company, .list-item, .side-card, .gallery, .card, .cat-card{ border-color:#000 !important; box-shadow:none !important }
    a{ color:#000 !important; text-decoration:underline !important }
    .print-meta{ display:block !important }
  }

  .print-actions{
    display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end; margin:10px 0;
  }
  .print-meta{
    display:none; margin-top:8px; font-size:12px; color:var(--muted)
  }

  /* Dev utilities panel */
  #devPanel{
    position:fixed; right:16px; top:76px; width:min(360px, 92vw); z-index:70; display:none;
    background:linear-gradient(180deg,var(--surface),var(--surface-2));
    border:1px solid rgba(255,255,255,.12); border-radius:16px; padding:12px; box-shadow:var(--shadow-lg);
  }
  #devPanel .row{ display:grid; gap:8px }
  #devPanel h3{ margin:0 0 6px 0; font-size:16px }
  #devPanel .grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap:8px }
  #devPanel .mono{ font-family:var(--mono) }
  #btnDev{ position:fixed; right:16px; top:16px; z-index:71 }
</style>

<script>
/* ============================================================
   ImpulsoLocal ‚Äî Bloque 8
   - Ampliaci√≥n del dataset a ~60 empresas (ficticias)
   - ‚ÄúModo impresi√≥n‚Äù √∫til en la ficha de empresa (bot√≥n imprimir/exportar)
   - Utilidades de prueba: panel #/dev, export JSON, rutas r√°pidas
   ============================================================ */

/* ---------- 1) Dataset ampliado ---------- */
(function expandDatasetMore(){
  // Evita duplicado de seeding si bloque se pega varias veces
  if(window.__IL_SEEDED_B8__) return;
  window.__IL_SEEDED_B8__ = true;

  const LUGARES = ['Lima','Arequipa','Trujillo','Piura','Cusco','Chiclayo','Iquitos','Tacna','Huancayo','Chimbote'];
  const SUBS = {
    'comida-bebida':['panaderias','cafeterias','restaurantes'],
    'hogar-ferreteria':['ferreterias','electricos','pinturas'],
    'tecnologia':['agencias-web','soporte-it','tiendas-tech'],
    'servicios-profesionales':['abogados','contadores','marketing'],
    'salud-belleza':['odontologia','cosmetica','opticas'],
    'mascotas':['veterinarias','accesorios','adiestramiento'],
    'automotriz':['taller','repuestos','lubricentro'],
    'educacion':['academias','idiomas','computacion']
  };
  const ICON = {'comida-bebida':'üçΩÔ∏è','hogar-ferreteria':'üõ†Ô∏è','tecnologia':'images/3524895.png','mascotas':'images/3524895.png','alquileres-espacios':'images/3524895.png','salud-belleza':'üíä','educacion':'üìö','servicios-profesionales':'üßë‚Äçüíº'};

  // Crea un nombre ficticio
  function nombreFalso(cat, loc, idx){
    const base = {
      'comida-bebida':['Caf√©','Panader√≠a','Bistr√≥','Sabor','Do√±a','Don','Rinc√≥n','Sabores'],
      'hogar-ferreteria':['Ferreter√≠a','Casa','Hogar','Pinturas','Color','Obras','Martillo'],
      'tecnologia':['Tecno','Pixel','Innova','Web','Data','Bit','Nube','Code'],
      'mascotas':['Vet','Mascota','Pet','Huella','Canes','Gatos','Amigos'],
      'automotriz':['Auto','Motor','Ruedas','Taller','Torque','Turbo'],
      'salud-belleza':['Cl√≠nica','Salud','Sonrisa','Belleza','Derma','√ìptica'],
      'educacion':['Academia','Instituto','Colegio','Aula','Idioma','Campus'],
      'servicios-profesionales':['Estudio','Consultores','Asesores','Legal','Contable','Marketing']
    }[cat] || ['Negocio'];
    const suf = ['Plus','Express','Andino','Per√∫','Center','Norte','Sur','Este','Oeste','Prime'];
    const pick = a => a[Math.floor(Math.random()*a.length)];
    return `${pick(base)} ${pick(suf)} ${loc}`;
  }

  // Genera N empresas por categor√≠a hasta completar ~60
  function genEmpresasObjetivo(targetTotal=60){
    const have = new Set(DATA.empresas.map(e=>e.id));
    let idCounter = DATA.empresas.length + 1;
    const cats = DATA.categorias.map(c=>c.id);
    while(DATA.empresas.length < targetTotal){
      const cat = cats[Math.floor(Math.random()*cats.length)];
      const loc = LUGARES[Math.floor(Math.random()*LUGARES.length)];
      const sub = (SUBS[cat]||[])[Math.floor(Math.random()*((SUBS[cat]||[]).length||1))] || '';
      const name = nombreFalso(cat, loc, idCounter);
      const id = `e-${String(idCounter).padStart(3,'0')}`;
      idCounter++;
      if(have.has(id)) continue;
      DATA.empresas.push({
        id, nombre:name, cat, loc, rating: (3.7 + Math.random()*1.3), reviews: Math.floor(Math.random()*180),
        verificada: Math.random() < 0.45, subcat: sub, icon: ICON[cat] || 'üè¢',
        breve: ({
          'comida-bebida':'Productos frescos y atenci√≥n r√°pida.',
          'hogar-ferreteria':'Soluciones para tu hogar y obra.',
          'tecnologia':'Sitios web, soporte y hardware.',
          'mascotas':'Cuidado integral para tu engre√≠do.',
          'automotriz':'Servicios r√°pidos y repuestos.',
          'salud-belleza':'Bienestar y est√©tica.',
          'educacion':'Aprendizaje efectivo.',
          'servicios-profesionales':'Asesor√≠a especializada.'
        })[cat] || 'Negocio local cercano a ti.'
      });
    }
  }

  

  // Recalcular totales y reconstruir √≠ndice
  (function hydrateCategoryTotals(){
    const byCat = {};
    for(const e of DATA.empresas){ byCat[e.cat] = (byCat[e.cat]||0)+1; }
    for(const c of DATA.categorias){ c.total = byCat[c.id]||0; }
  })();
  if(window.Search?.buildIndex) Search.buildIndex();

  // Actualiza KPIs del home si ya est√° montado
  if(document.getElementById('kpiEmpresas')){
    document.getElementById('kpiEmpresas').textContent = new Intl.NumberFormat('es-PE').format(DATA.empresas.length);
    document.getElementById('kpiCategorias').textContent = new Intl.NumberFormat('es-PE').format(DATA.categorias.length);
    const totalReviews = DATA.empresas.reduce((a,e)=>a+(e.reviews||0),0);
    document.getElementById('kpiResenas').textContent = new Intl.NumberFormat('es-PE').format(totalReviews);
  }
})();

/* ---------- 2) Modo impresi√≥n en Ficha: bot√≥n Imprimir/Exportar ---------- */




/* ---------- 4) Peque√±as mejoras de UX finales ---------- */
(function finalPolish(){
  // ‚ÄúCopiar enlace‚Äù tambi√©n en ficha (si no estuviera)
  const Router = window.App?.Router;
  if(!Router) return;
  const origDispatch = Router.dispatch;
  Router.dispatch = function(){
    origDispatch.apply(Router, arguments);
    setTimeout(()=>{
      const inFicha = !document.getElementById('view-ficha')?.classList.contains('hide');
      if(inFicha){
        // Si no existe bot√≥n compartir, lo a√±adimos a la cabecera
        const head = document.querySelector('#view-ficha .ficha-head');
        if(head && !head.querySelector('#btnShareFicha')){
          const share = document.createElement('button');
          share.id = 'btnShareFicha';
          share.className = 'btn btn-ghost';
          share.textContent = 'üîó Compartir';
          share.setAttribute('data-tip','Copiar enlace de la ficha');
          share.addEventListener('click', ()=> {
            if(navigator.clipboard?.writeText){ navigator.clipboard.writeText(location.href).then(()=>Toast.show('Enlace copiado','ok')); }
            else{ const ta=document.createElement('textarea'); ta.value=location.href; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); Toast.show('Enlace copiado','ok'); }
          });
          head.appendChild(share);
        }
      }
    }, 0);
  };
})();

document.addEventListener('DOMContentLoaded', () => {
  // ‚ö° fuerza a re-disparar el router cuando ya cargaron todos los bloques
  if (window.App?.Router) {
    window.App.Router.dispatch();
  } else if (typeof Router !== 'undefined') {
    Router.dispatch();
  }
});
</script>





<script>
document.addEventListener('readystatechange', () => {
  // Solo cuando todos los scripts han terminado de cargarse
  if (document.readyState === 'complete') {
    if (window.App?.Router) {
      window.App.Router.dispatch();
    } else if (typeof Router !== 'undefined') {
      Router.dispatch();
    }
  }
});
</script>






<script>
/* ============================================================
   Recarga controlada para el bot√≥n "Buscar"
   ============================================================ */
(function() {
  function recargarDespuesDeBuscar(e) {
    try {
      // Evita que se dispare varias veces seguidas
      if (window.__busquedaRecargando) return;
      window.__busquedaRecargando = true;

      // Espera unos milisegundos para que se procese el resultado
      setTimeout(() => {
        // Recarga controlada (sin perder hash ni desplazamiento)
        const scrollY = window.scrollY;
        window.location.reload();
        window.scrollTo(0, scrollY);
      }, 300); // ajusta el tiempo si es necesario
    } catch (err) {
      console.warn('recargarDespuesDeBuscar error:', err);
    }
  }

  // Detecta el bot√≥n Buscar por su texto o clase
  window.addEventListener('DOMContentLoaded', () => {
    // puedes afinar el selector seg√∫n tu HTML real
    const botonBuscar = document.querySelector('button, input[type="button"], input[type="submit"]');
    if (botonBuscar) {
      botonBuscar.addEventListener('click', recargarDespuesDeBuscar);
    }
  });
})();
</script>


<!-- ========================================================= -->
<!-- BLOQUE PLUS 01 ‚Äî INTERFAZ VERDE-SUAVE PROFESIONAL -->
<!-- Paleta: #efffe1, #eeffcd, #e7ffad, #dbff95, #bfff8a -->
<!-- Estilo fresco, claro y natural -->
<!-- ========================================================= -->
<style>
  :root[data-theme='suave'] {
    /* PALETA BASE */
    --verde-suave: #bfff8a;   /* principal */
    --verde-claro: #dbff95;   /* acento */
    --verde-medio: #e7ffad;   /* medio */
    --verde-pastel: #eeffcd;  /* fondo medio */
    --crema: #efffe1;         /* fondo principal */

    /* DERIVADOS Y MATICES */
    --bg: var(--crema);
    --surface: var(--verde-pastel);
    --surface-2: var(--verde-medio);
    --surface-3: var(--verde-claro);
    --overlay: rgba(102, 255, 102, 0.518);

    /* TEXTO */
    --text: #1b1c17;
    --text-strong: #2e3220;
    --subtext: #4b5a24;
    --muted: #1e4734;

    /* ACCENTOS */
    --primary: var(--verde-suave);
    --primary-light: var(--verde-claro);
    --primary-dark: #91e67f;
    --accent: #24835f;
    --highlight: #fafff2;

    /* BORDES Y SOMBRAS */
    
  --brand: #10b981;
  --brand-2: #34d399;

    --border: #cde5a5;
    --border-strong: #a3dc76;
    --shadow-sm: 0 2px 10px rgba(107, 186, 80, 0.25);
    --shadow-md: 0 6px 20px rgba(107, 186, 80, 0.35);

    /* BOTONES Y EFECTOS */
    --btn-text: #1a1a1a;
    --hover: rgb(176, 241, 221);
    --danger: #f37a6a;
    
  }

  /* Transiciones */
  body.theme-transition,
  body.theme-transition * {
    transition: background-color 0.45s ease, color 0.45s ease, border-color 0.45s ease, box-shadow 0.45s ease;
  }
  body.fade-in-theme {
    animation: fadeTheme 0.5s ease forwards;
  }
  @keyframes fadeTheme {
    from { filter: brightness(0.85); opacity: 0.7; }
    to { filter: brightness(1); opacity: 1; }
  }

  /* Estructura global */
  :root[data-theme='suave'] body {
    background: var(--bg);
    color: var(--text);
  }

  :root[data-theme='suave'] header.app,
  :root[data-theme='suave'] main,
  :root[data-theme='suave'] footer.app,
  :root[data-theme='suave'] .container {
    background: var(--surface);
    box-shadow: var(--shadow-sm);
    border-color: var(--border);
  }

  :root[data-theme='suave'] header.app {
    background: var(--surface-3);
    border-bottom: 1px solid var(--border);
  }

  :root[data-theme='suave'] footer.app {
    background: var(--surface-2);
    border-top: 1px solid var(--border);
    color: var(--subtext);
  }

  /* Texto y enlaces */
  :root[data-theme='suave'] h1, 
  :root[data-theme='suave'] h2, 
  :root[data-theme='suave'] h3 {
    color: var(--text-strong);
  }
  :root[data-theme='suave'] p, 
  :root[data-theme='suave'] span, 
  :root[data-theme='suave'] a {
    color: var(--text);
  }
  

  /* Botones */
  :root[data-theme='suave'] .btn-primary {
    background: linear-gradient(90deg, var(--primary-dark), var(--primary));
    color: var(--btn-text);
    box-shadow: 0 3px 10px rgba(107,186,80,0.25);
  }
  :root[data-theme='suave'] .btn-primary:hover {
    background: var(--primary-light);
  }
  :root[data-theme='suave'] .btn-ghost {
    background: var(--hover);
    color: var(--text);
    border: 1px solid var(--border);
  }
  :root[data-theme='suave'] .btn-ghost:hover {
    background: var(--accent);
  }

  /* Inputs */
  :root[data-theme='suave'] input,
  :root[data-theme='suave'] textarea,
  :root[data-theme='suave'] select {
    background: var(--surface-3);
    border: 1px solid var(--border);
    color: var(--text);
  }
  :root[data-theme='suave'] input::placeholder {
    color: var(--muted);
  }

  /* Hero y tarjetas */
  :root[data-theme='suave'] .hero {
    background: linear-gradient(180deg, var(--highlight), var(--surface-3));
    border-radius: 14px;
    box-shadow: var(--shadow-sm);
    padding: 20px;
  }
  :root[data-theme='suave'] .hero .title { color: var(--text-strong); }
  :root[data-theme='suave'] .hero .lead { color: var(--subtext); }

  :root[data-theme='suave'] .cat-card {
    background: var(--surface);
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    transition: transform 0.2s ease, box-shadow 0.2s ease;
  }
  :root[data-theme='suave'] .cat-card:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow-md);
  }

  :root[data-theme='suave'] .cat-media {
    background: linear-gradient(180deg, var(--primary), var(--primary-dark));
    color: #201011;
  }
  :root[data-theme='suave'] .badge {
    background: linear-gradient(90deg, var(--primary), var(--primary-dark));
    color: #202010;
  }

  /* Bot√≥n de cambio de interfaz */
  .theme-toggle {
    position: fixed;
    top: 14px;
    right: 18px;
    background: var(--primary);
    color: #4fe7a2;
    border: none;
    border-radius: 40px;
    padding: 0.5rem 1.1rem;
    font-size: 0.9rem;
    box-shadow: 0 2px 10px rgba(107,186,80,0.25);
    cursor: pointer;
    z-index: 9999;
    transition: background 0.25s ease, transform 0.25s ease;
  }
  .theme-toggle:hover {
    background: var(--primary-dark);
    transform: scale(1.05);
  }
  .theme-toggle span {
    margin-left: 6px;
    font-weight: 600;
  }
  .theme-toggle::after {
    content: "Modo Verde-Suave";
    position: absolute;
    bottom: -1.6rem;
    left: 50%;
    transform: translateX(-50%);
    font-size: 0.7rem;
    color: var(--subtext);
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2px 6px;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
  }
  .theme-toggle:hover::after { opacity: 1; }






  /* DEGRADADOS M√ÅS NOTORIOS */

/* 1. BORDE CON DEGRADADO M√ÅS FUERTE */
[data-theme='suave'] .cat-card::before,
[data-theme='suave'] .card-company::before {
  content: '' !important;
  position: absolute !important;
  inset: -3px !important;
  border-radius: inherit !important;
  background: linear-gradient(135deg, #bfff8a 0%, #91e67f 25%, #dbff95 50%, #e7ffad 75%, #bfff8a 100%) !important;
  z-index: -1 !important;
  opacity: 1 !important;
}

/* 2. HOVER M√ÅS BRILLANTE */
[data-theme='suave'] .cat-card:hover::before,
[data-theme='suave'] .card-company:hover::before {
  background: linear-gradient(135deg, #91e67f 0%, #bfff8a 25%, #dbff95 50%, #bfff8a 75%, #91e67f 100%) !important;
  inset: -4px !important;
  filter: brightness(1.1) !important;
}

/* 3. HERO M√ÅS VIBRANTE */
[data-theme='suave'] .hero {
  background: linear-gradient(135deg, #e7ffad 0%, #dbff95 30%, #bfff8a 60%, #efffe1 100%) !important;
}

/* 4. HEADER CON M√ÅS COLOR */
[data-theme='suave'] header.site {
  background: linear-gradient(180deg, #dbff95 0%, #eeffcd 50%, rgba(239, 255, 225, 0.95) 100%) !important;
  backdrop-filter: blur(12px) !important;
}
/* FORZADOR DE EJECUCI√ìN - Pegar al FINAL de todo el <style> */

/* 1. CABECERA DE EMPRESA */
[data-theme='suave'] .ficha-head {
  background: linear-gradient(135deg, #e7ffad 0%, #dbff95 50%, #bfff8a 100%) !important;
  border: 3px solid transparent !important;
  position: relative !important;
  z-index: 1 !important;
}

[data-theme='suave'] .ficha-head::before {
  content: '' !important;
  position: absolute !important;
  inset: -3px !important;
  border-radius: 16px !important;
  background: linear-gradient(135deg, #bfff8a, #91e67f, #dbff95, #e7ffad) !important;
  z-index: -1 !important;
}

/* 2. LOGO BRILLANTE */
[data-theme='suave'] .ficha-logo,
[data-theme='suave'] .brand-logo,
[data-theme='suave'] .card-logo {
  background: linear-gradient(135deg, #bfff8a 0%, #91e67f 50%, #dbff95 100%) !important;
  box-shadow: 0 4px 16px rgba(191, 255, 138, 0.5) !important;
}

/* 3. GALER√çA */
[data-theme='suave'] .gallery,
[data-theme='suave'] .gallery-main {
  border: 3px solid #bfff8a !important;
  box-shadow: 0 8px 24px rgba(191, 255, 138, 0.3) !important;
}



/* 5. BADGE VERIFICADA */
[data-theme='suave'] .badge {
  background: linear-gradient(135deg, #bfff8a 0%, #91e67f 100%) !important;
  box-shadow: 0 4px 12px rgba(191, 255, 138, 0.6) !important;
  border: 2px solid rgba(255, 255, 255, 0.7) !important;
  color: #1a1a1a !important;
}

/* 6. MINIATURA ACTIVA */
[data-theme='suave'] .thumb[aria-current="true"] {
  outline: 3px solid #bfff8a !important;
  outline-offset: 2px !important;
  box-shadow: 0 0 20px rgba(191, 255, 138, 0.6) !important;
}

/* 7. TABS ACTIVO */
[data-theme='suave'] .tabs button[aria-selected="true"] {
  background: linear-gradient(180deg, #e7ffad 0%, #dbff95 100%) !important;
  border-top: 3px solid #bfff8a !important;
  box-shadow: 0 -2px 8px rgba(191, 255, 138, 0.3) !important;
}

/* 8. MAPA */
[data-theme='suave'] .map iframe,
[data-theme='suave'] iframe[src*="google.com/maps"] {
  border: 3px solid #dbff95 !important;
  box-shadow: 0 6px 18px rgba(191, 255, 138, 0.3) !important;
  border-radius: 12px !important;
}

/* 9. BREADCRUMBS */
[data-theme='suave'] .breadcrumbs,
[data-theme='suave'] .migas {
  background: linear-gradient(90deg, transparent, rgba(191, 255, 138, 0.15), transparent) !important;
  padding: 12px !important;
  border-radius: 12px !important;
}

/* 10. FORZAR A TODO EL CONTENIDO DE FICHA */
[data-theme='suave'] #view-ficha .section,
[data-theme='suave'] #view-ficha > div {
  position: relative !important;
}


</style>


<script>
  /* ======================================================
     BLOQUE PLUS 01 ‚Äî L√ìGICA DE INTERFAZ MARINO-JADE
  ====================================================== */
  document.addEventListener("DOMContentLoaded", () => {
    const toggleBtn = document.createElement("button");
    toggleBtn.className = "theme-toggle";
    toggleBtn.innerHTML = "üåø<span>Interfaz</span>";
    document.body.appendChild(toggleBtn);

    const savedTheme = localStorage.getItem("impulsolocal_theme");
    if (savedTheme === "suave") {
      document.documentElement.setAttribute("data-theme", "suave");
    }

    toggleBtn.addEventListener("click", () => {
      const isActive = document.documentElement.getAttribute("data-theme") === "suave";
      document.body.classList.add("theme-transition", "fade-in-theme");
      setTimeout(() => document.body.classList.remove("theme-transition", "fade-in-theme"), 650);

      if (isActive) {
        document.documentElement.removeAttribute("data-theme");
        localStorage.removeItem("impulsolocal_theme");
      } else {
        document.documentElement.setAttribute("data-theme", "suave");
        localStorage.setItem("impulsolocal_theme", "suave");
      }
    });
  });


  
</script>
<!-- ========================================================= -->
<!-- BLOQUE PLUS 01 FIN -->
<!-- ========================================================= -->


<style>
/* Lightbox simple tipo "WhatsApp" */
.il-lightbox {
  position: fixed;
  inset: 0;
  display: none;
  place-items: center;
  background: rgba(0,0,0,0.72);
  z-index: 9999;
  cursor: zoom-out;
  touch-action: none;
}
.il-lightbox.show { display: grid; }
.il-lightbox .wrap {
  position: relative;
  /* centrar contenido y reservar espacio para imagen ampliada */
  display: flex;
  align-items: center;
  justify-content: center;
  max-width: 95vw;
  max-height: 95vh;
  overflow: hidden;
  padding: 12px;
}
.il-lightbox img {
  display:block;
  /* ocupar hasta el 95% del viewport, mantener proporci√≥n */
  max-width: 95vw;
  max-height: 95vh;
  width: auto;
  height: auto;
  object-fit: contain;
  transition: transform .18s ease, opacity .18s ease;
  transform-origin: center center;
  cursor: zoom-in;
  touch-action: none;
  user-select: none;
  -webkit-user-drag: none;
}
.il-lightbox .caption {
  position: absolute; left:12px; right:12px; bottom:12px;
  color: #fff; font-size:13px; text-align:center; opacity:.95;
  text-shadow: 0 2px 8px rgba(0,0,0,.5);
}
</style>

<script>
(function(){
  // crear overlay
  let lb = document.getElementById('ilLightbox');
  if(!lb){
    lb = document.createElement('div');
    lb.id = 'ilLightbox';
    lb.className = 'il-lightbox';
    lb.innerHTML = `<div class="wrap"><img id="ilLightboxImg" alt=""><div class="caption" id="ilLightboxCaption"></div></div>`;
    document.body.appendChild(lb);
  }
  const overlay = lb;
  const img = overlay.querySelector('#ilLightboxImg');
  const caption = overlay.querySelector('#ilLightboxCaption');

  // estado de interacci√≥n
  let scale = 1, tx = 0, ty = 0;
  let dragging = false, startX=0, startY=0, startTx=0, startTy=0;
  function resetTransform(){
    scale = 1; tx = 0; ty = 0;
    img.style.transform = 'translate(0px,0px) scale(1)';
    img.style.cursor = 'zoom-in'; overlay.style.cursor = 'zoom-out';
  }

  // abrir lightbox con src y texto opcional
  function openLightbox(src, alt){
    img.src = src;
    img.alt = alt || '';
    caption.textContent = alt || '';
    resetTransform();
    overlay.classList.add('show');
    // focus para cerrar con Esc
    setTimeout(()=> overlay.focus?.(), 10);
  }

  function closeLightbox(){
    overlay.classList.remove('show');
    // opcional: liberar src si se usan dataURLs muy grandes
    // img.src = '';
  }

  // toggle zoom en doble click / double tap
  function toggleZoom(cx, cy){
    const rect = img.getBoundingClientRect();
    const relX = cx - rect.left;
    const relY = cy - rect.top;
    const originX = (relX / rect.width) * 100;
    const originY = (relY / rect.height) * 100;
    img.style.transformOrigin = `${originX}% ${originY}%`;

    if(scale > 1.1){
      // volver
      resetTransform();
    } else {
      // acercar (2x)
      scale = 2;
      const ox = (relX - rect.width/2);
      const oy = (relY - rect.height/2);
      tx = Math.max(Math.min(-ox, rect.width * (scale-1)/2), -rect.width * (scale-1));
      ty = Math.max(Math.min(-oy, rect.height * (scale-1)/2), -rect.height * (scale-1));
      img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
      img.style.cursor = 'grab'; overlay.style.cursor = 'default';
    }
  }

  // pointer pan handlers
  img.addEventListener('pointerdown', (ev)=>{
    if(scale <= 1){ return; }
    dragging = true;
    img.setPointerCapture(ev.pointerId);
    startX = ev.clientX; startY = ev.clientY;
    startTx = tx; startTy = ty;
    img.style.cursor = 'grabbing';
    ev.preventDefault();
  });
  window.addEventListener('pointermove', (ev)=>{
    if(!dragging) return;
    const dx = ev.clientX - startX;
    const dy = ev.clientY - startY;
    tx = startTx + dx; ty = startTy + dy;
    img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
  }, {passive:true});
  window.addEventListener('pointerup', (ev)=>{
    if(!dragging) return;
    dragging = false;
    img.releasePointerCapture?.(ev.pointerId);
    img.style.cursor = 'grab';
  });

  // wheel to zoom (desktop)
  overlay.addEventListener('wheel', (ev)=>{
    if(!overlay.classList.contains('show')) return;
    ev.preventDefault();
    const delta = Math.sign(ev.deltaY);
    const rect = img.getBoundingClientRect();
    const cx = ev.clientX, cy = ev.clientY;
    let newScale = Math.max(1, Math.min(4, scale - delta*0.25));
    if(newScale === scale) return;
    const relX = cx - rect.left;
    const relY = cy - rect.top;
    const ratio = newScale / scale;
    tx = (tx - (relX - rect.width/2)) * ratio + (relX - rect.width/2);
    ty = (ty - (relY - rect.height/2)) * ratio + (relY - rect.height/2);
    scale = newScale;
    img.style.transform = `translate(${tx}px, ${ty}px) scale(${scale})`;
    img.style.cursor = scale>1 ? 'grab' : 'zoom-in';
  }, {passive:false});

  // double click / double tap
  let lastTap = 0;
  img.addEventListener('click', (ev)=>{
    const now = Date.now();
    if(now - lastTap < 350){
      toggleZoom(ev.clientX, ev.clientY);
      lastTap = 0;
    } else {
      lastTap = now;
    }
  });

  // click fuera de la imagen: si est√° zoomed s√≥lo desactivar zoom; si no, cerrar
  overlay.addEventListener('click', (ev)=>{
    if(ev.target !== overlay) return;
    if(scale > 1.05){
      // desactivar s√≥lo el zoom (mantener lightbox abierto)
      resetTransform();
    } else {
      // si no hay zoom, cerrar lightbox
      closeLightbox();
    }
  });

  // Esc key to close
  window.addEventListener('keydown', (ev)=>{
    if(ev.key === 'Escape' && overlay.classList.contains('show')) {
      // si est√° zoomed, quitar zoom primero
      if(scale > 1.05) resetTransform();
      else closeLightbox();
    }
  });

  // conectar con la imagen principal de la ficha
  function attachToMain(){
    const main = document.querySelector('#galMain');
    if(!main) return;
    main.style.cursor = 'zoom-in';
    main.addEventListener('click', (ev)=>{
      // usar la src mostrada actualmente
      const src = main.getAttribute('src') || main.dataset.src || '';
      openLightbox(src, main.alt || main.getAttribute('alt') || '');
    });
  }

  // si la vista se re-renderiza, re-atachar
  document.addEventListener('DOMContentLoaded', attachToMain);
  const mo = new MutationObserver(()=> attachToMain());
  mo.observe(document.body, { childList:true, subtree:true });
})();



</script>



<!-- ========================================================= -->
<!-- BLOQUE PLUS 02 (FINAL) ‚Äî Principal exclusivo, modo oscuro  -->
<!--  -->
<!-- ========================================================= -->

<script>
/* ------------------------------------------------------------
   Ajuste autom√°tico:
   - Desplaza barra de t√©rminos si existe (.footer-terms)
   - Oculta bloque "p√°gina no encontrada" si interfiere
   - Fuerza visibilidad del panel principal
-------------------------------------------------------------*/
document.addEventListener('DOMContentLoaded', () => {
  const notFound = document.querySelector('.page-404, #notFound, .notfound');
  if (notFound) notFound.style.display = 'none';
  const footer = document.querySelector('.footer-terms, .footer, #footer');
  if (footer) footer.style.marginTop = '140px';

  const nav = document.querySelector('.nav-links');
  if (nav && !nav.querySelector('[data-nav="principal"]')) {
    const a = document.createElement('a');
    a.href = '#/principal';
    a.dataset.nav = 'principal';
    a.title = 'Principal';
    a.textContent = 'Principal';
    nav.insertBefore(a, nav.firstChild);
  }
});
</script>

<style>
/* =========================================================
   BLOQUE PLUS 02 ‚Äî Estilos visuales adaptados a modo oscuro
   ========================================================= */

/* usa colores del tema existente o alterna seg√∫n prefers-color-scheme */
@media (prefers-color-scheme: dark){
  :root{
    --surface:#0f1117;
    --surface-2:#1a1c22;
    --text:#f5f6fa;
    --muted:#9ca3af;
    --brand:#0b78ff;
    --brand-2:#00d4ff;
  }
}
@media (prefers-color-scheme: light){
  :root{
    --surface:#ffffff;
    --surface-2:#f8fafc;
    --text:#111827;
    --muted:#6b7280;
    --brand:#0b78ff;
    --brand-2:#00d4ff;
  }
}

/* Panel */
#principalPanel{
  display:none;
  padding:28px 0;
  position:relative;
  z-index:99999; /* siempre arriba */
  background:linear-gradient(180deg,rgba(11,120,255,0.03),transparent);
  color:var(--text);
}
.pp-container{max-width:1200px;margin:0 auto;padding:0 clamp(12px,3vw,24px);}

/* Header */
.pp-header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;margin-bottom:14px;}
.pp-title{font-size:1.7rem;font-weight:900;margin:0;}
.pp-sub{color:var(--muted);font-size:.95rem;}

/* Filtro simple */
.pp-filters{display:flex;gap:8px;align-items:center;margin-bottom:14px;background:var(--surface-2);
padding:10px;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,.05);}
.pp-filters input[type="search"], .pp-filters select{
  padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
  background:var(--surface);color:var(--text);
}
.pp-filters .search{flex:1;display:flex;align-items:center;gap:8px;}
.pp-filters .small-btn{padding:8px 10px;border-radius:10px;}

/* Grid */
.pp-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:14px;}
@media(max-width:1100px){.pp-grid{grid-template-columns:repeat(2,1fr);}}
@media(max-width:700px){.pp-grid{grid-template-columns:1fr;}}

/* Tarjetas */
.pp-card{
  background:linear-gradient(180deg,var(--surface),var(--surface-2));
  border-radius:14px;overflow:hidden;box-shadow:0 8px 24px rgba(0,0,0,.12);
  border:1px solid rgba(255,255,255,.06);display:flex;flex-direction:column;
  transition:transform .16s ease,box-shadow .16s ease;
}
.pp-card:hover{transform:translateY(-6px);box-shadow:0 18px 36px rgba(0,0,0,.18);}

/* Imagen / carrusel */

.pp-media img{width:100%;height:100%;object-fit:cover;display:block;}
.pp-media .img-count{position:absolute;right:10px;top:10px;background:rgba(222, 18, 18, 0.5);color:#e11212;
padding:6px 8px;border-radius:999px;font-weight:700;font-size:12px;}

/* Contenido */
.pp-body{padding:14px;display:flex;flex-direction:column;gap:10px;}
.pp-row{display:flex;justify-content:space-between;align-items:center;gap:8px;}
.pp-titleCard{font-weight:900;font-size:1.05rem;line-height:1.15;}
.pp-subline{color:var(--muted);font-size:13px;}
.pp-badges{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.badge{background:linear-gradient(90deg,var(--brand-2),var(--brand));color:#fff;
padding:6px 8px;border-radius:999px;font-weight:800;font-size:12px;}
.pp-desc{color:var(--text);font-size:14px;min-height:48px;}
.pp-ctas{display:flex;gap:8px;align-items:center;margin-top:6px;}
.pp-cta-primary{padding:10px 14px;border-radius:10px;background:linear-gradient(90deg,var(--brand-2),var(--brand));
color:#fff;text-decoration:none;font-weight:800;}
.pp-cta-ghost{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.08);
background:var(--surface);color:var(--text);cursor:pointer;}

/* Floating button */
.float-offers-btn{position:fixed;bottom:22px;right:22px;background:linear-gradient(90deg,var(--brand-2),var(--brand));
color:#fff;font-weight:800;border:none;border-radius:40px;padding:14px 18px;
box-shadow:0 12px 36px rgba(11,120,255,.18);cursor:pointer;z-index:999999;
transition:transform .14s ease,box-shadow .14s ease;}
.float-offers-btn:hover{transform:scale(1.05);}
.small{font-size:13px;color:var(--muted);}

/* ESTILO PROFESIONAL PARA PANEL DE CATEGOR√çAS Y LISTADO */

/* 1. ENCABEZADO DE CATEGOR√çA */
[data-theme='suave'] #view-listado h1,
[data-theme='suave'] #view-listado h2 {
  background: linear-gradient(135deg, #2e3220, #4b5a24, #6b7a42) !important;
  -webkit-background-clip: text !important;
  -webkit-text-fill-color: transparent !important;
  background-clip: text !important;
  font-weight: 900 !important;
  text-shadow: 0 2px 4px rgba(191, 255, 138, 0.1) !important;
}

/* 2. BARRA DE INFORMACI√ìN (Categor√≠a: X | Resultados: X) */
[data-theme='suave'] .results-bar,
[data-theme='suave'] .toolbar {
  background: linear-gradient(135deg, #ffffff 0%, #f9ffe9 50%, #ffffff 100%) !important;
  border: 2px solid transparent !important;
  border-radius: 16px !important;
  padding: 16px !important;
  position: relative !important;
  backdrop-filter: blur(10px) !important;
}

[data-theme='suave'] .results-bar::after,
[data-theme='suave'] .toolbar::after {
  content: '' !important;
  position: absolute !important;
  inset: -2px !important;
  border-radius: 16px !important;
  background: linear-gradient(135deg, #bfff8a, #dbff95, #e7ffad, #bfff8a) !important;
  z-index: -1 !important;
  opacity: 0.6 !important;
}

/* 3. PILLS/CHIPS DE INFORMACI√ìN */
[data-theme='suave'] .q-pill,
[data-theme='suave'] .pill,
[data-theme='suave'] .chip {
  background: linear-gradient(135deg, #e7ffad, #dbff95) !important;
  border: 2px solid rgba(191, 255, 138, 0.5) !important;
  border-radius: 999px !important;
  padding: 8px 16px !important;
  box-shadow: 0 2px 8px rgba(191, 255, 138, 0.2) !important;
  transition: all 0.3s ease !important;
}

[data-theme='suave'] .q-pill:hover,
[data-theme='suave'] .chip:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(191, 255, 138, 0.3) !important;
  background: linear-gradient(135deg, #dbff95, #bfff8a) !important;
}

/* 4. SELECT DE ORDENAR */
[data-theme='suave'] .toolbar select,
[data-theme='suave'] .results-bar select,
[data-theme='suave'] #selSort,
[data-theme='suave'] #selSortV4 {
  background: linear-gradient(135deg, #ffffff, #fafff2) !important;
  border: 2px solid #dbff95 !important;
  border-radius: 12px !important;
  padding: 10px 16px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.3s ease !important;
}

[data-theme='suave'] .toolbar select:focus,
[data-theme='suave'] select:hover {
  border-color: #bfff8a !important;
  box-shadow: 0 0 0 4px rgba(191, 255, 138, 0.15) !important;
  transform: translateY(-1px) !important;
}

/* 5. BOTONES DE VISTA (GRID/LIST) */
[data-theme='suave'] .view-toggle {
  background: linear-gradient(135deg, #e7ffad, #dbff95) !important;
  border: 2px solid rgba(191, 255, 138, 0.4) !important;
  border-radius: 12px !important;
  overflow: hidden !important;
  box-shadow: 0 2px 8px rgba(191, 255, 138, 0.2) !important;
}

[data-theme='suave'] .view-toggle button {
  background: transparent !important;
  transition: all 0.3s ease !important;
  font-weight: 700 !important;
}

[data-theme='suave'] .view-toggle button[aria-pressed="true"] {
  background: linear-gradient(135deg, #bfff8a, #91e67f) !important;
  color: #1a1a1a !important;
  box-shadow: 0 2px 6px rgba(145, 230, 127, 0.3) !important;
}



/* 7. LOGO/ICONO DE NEGOCIO */
[data-theme='suave'] .card-logo,
[data-theme='suave'] .list-item .logo {
  background: linear-gradient(135deg, #bfff8a 0%, #91e67f 50%, #dbff95 100%) !important;
  box-shadow: 0 4px 16px rgba(191, 255, 138, 0.4),
              inset 0 1px 0 rgba(255, 255, 255, 0.6) !important;
}

/* 8. BADGE VERIFICADA EN LISTADO */
[data-theme='suave'] .card-company .badge,
[data-theme='suave'] .list-item .badge {
  background: linear-gradient(135deg, #bfff8a, #91e67f) !important;
  box-shadow: 0 3px 10px rgba(191, 255, 138, 0.5) !important;
  border: 2px solid rgba(255, 255, 255, 0.7) !important;
  font-weight: 800 !important;
}

/* 9. B√öSQUEDAS RECIENTES */
[data-theme='suave'] .recent-wrap,
[data-theme='suave'] #recentMount {
  background: linear-gradient(90deg, 
              transparent, 
              rgba(191, 255, 138, 0.08), 
              transparent) !important;
  padding: 12px !important;
  border-radius: 12px !important;
  margin: 16px 0 !important;
}

[data-theme='suave'] .recent-chip {
  background: linear-gradient(135deg, #e7ffad, #dbff95) !important;
  border: 2px solid rgba(191, 255, 138, 0.4) !important;
  box-shadow: 0 2px 6px rgba(191, 255, 138, 0.2) !important;
  transition: all 0.3s ease !important;
}

[data-theme='suave'] .recent-chip:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(191, 255, 138, 0.3) !important;
  background: linear-gradient(135deg, #dbff95, #bfff8a) !important;
}

/* 10. PAGINACI√ìN */
[data-theme='suave'] .pager,
[data-theme='suave'] .load-more-wrap {
  margin-top: 24px !important;
  padding: 16px !important;
  background: linear-gradient(90deg, 
              transparent, 
              rgba(191, 255, 138, 0.05), 
              transparent) !important;
  border-radius: 12px !important;
}

[data-theme='suave'] .pager .btn {
  background: linear-gradient(135deg, #e7ffad, #dbff95) !important;
  border: 2px solid rgba(191, 255, 138, 0.4) !important;
  box-shadow: 0 2px 8px rgba(191, 255, 138, 0.2) !important;
}

[data-theme='suave'] .pager .btn[disabled] {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
}

/* 11. VISTA LISTA (alternativa a grid) */
[data-theme='suave'] .list-item {
  
  
  border-radius: 16px !important;
  padding: 16px !important;
  transition: all 0.3s ease !important;
}

[data-theme='suave'] .list-item:hover {
  transform: translateX(6px) !important;
  box-shadow: 0 6px 20px rgba(191, 255, 138, 0.25) !important;
  
}
/* 1. CONTENEDOR DEL FORMULARIO CON TONO NATURAL */
[data-theme='suave'] .form-container,
[data-theme='suave'] #contactCard {
  background: linear-gradient(135deg, #ebfaaa 0%, #eef7e1 50%, #bbf6cc 100%) !important;
  border: 3px solid transparent !important;
  background-clip: padding-box !important;
  position: relative !important;
}

/* BORDE RESALTANTE PARA TARJETAS DE NEGOCIOS EN LISTADO */

[data-theme='suave'] .card-company,
[data-theme='suave'] .grid-list > article,
[data-theme='suave'] .list-item {
  border: 3px solid transparent !important;
  background: 
              linear-gradient(135deg, #bfff8a 0%, #91e67f 30%, #dbff95 60%, #e7ffad 100%) border-box !important;
  box-shadow: 0 6px 20px rgba(191, 255, 138, 0.25) !important;
}

[data-theme='suave'] .card-company:hover,
[data-theme='suave'] .grid-list > article:hover,
[data-theme='suave'] .list-item:hover {
  background: 
              linear-gradient(135deg, #91e67f 0%, #bfff8a 30%, #dbff95 60%, #bfff8a 100%) border-box !important;
  box-shadow: 0 10px 30px rgba(191, 255, 138, 0.35),
              0 0 20px rgba(145, 230, 127, 0.3) !important;
}
/* 12. BREADCRUMBS EN LISTADO */
[data-theme='suave'] .breadcrumbs {
  background: linear-gradient(90deg, 
              transparent, 
              rgba(191, 255, 138, 0.1), 
              transparent) !important;
  padding: 12px !important;
  border-radius: 12px !important;
  margin-bottom: 20px !important;
}

/* 13. ESTADO VAC√çO (sin resultados) */
[data-theme='suave'] .empty,
[data-theme='suave'] .empty-state {
  background: linear-gradient(135deg, #fafff2, #efffe1) !important;
  border: 2px dashed #dbff95 !important;
  border-radius: 16px !important;
  padding: 32px !important;
  text-align: center !important;
}


</style>

<section id="principalPanel" aria-live="polite">
  <div class="pp-container">
    <div class="pp-header">
      <div>
        <h2 class="pp-title">Panel Principal ‚Äî Promociones destacadas</h2>
        <div class="pp-sub">Explora las ofertas m√°s recientes de los emprendedores locales.</div>
      </div>
      <div class="small">Ofertas: <strong id="ppCount">0</strong></div>
    </div>

    <div class="pp-filters">
      <div class="search">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="opacity:.6">
          <path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="11" cy="11" r="6" stroke="currentColor" stroke-width="1.6"/>
        </svg>
        <input id="ppSearch" type="search" placeholder="Buscar ofertas o empresas...">
      </div>
      <select id="ppCategory">
        <option value="">Todas</option>
        <option value="comida-bebida">Comida & Bebida</option>
        <option value="servicios">Servicios</option>
        <option value="ropa">Ropa</option>
        <option value="hogar">Hogar</option>
        <option value="mascotas">Mascotas</option>
      </select>
      <button id="ppBtnReset" class="pp-cta-ghost">Reset</button>
    </div>

    <div id="ppGrid" class="pp-grid" role="list"></div>
  </div>
</section>

<button id="ppFloatBtn" class="float-offers-btn" aria-controls="principalPanel">
  ‚ú® Explora las mejores ofertas
</button>

<script>
/* =========================================================
   BLOQUE PLUS 02 ‚Äî L√≥gica sin import/export JSON
   ========================================================= */
(function(){
  let OFFERS = [];
  const panel = document.getElementById('principalPanel');
  const floatBtn = document.getElementById('ppFloatBtn');
  const grid = document.getElementById('ppGrid');
  const countEl = document.getElementById('ppCount');
  const searchEl = document.getElementById('ppSearch');
  const catEl = document.getElementById('ppCategory');
  const resetBtn = document.getElementById('ppBtnReset');

  function nowISO(){return new Date().toISOString();}
  function idGen(){return 'o-'+Math.random().toString(36).slice(2,9);}
  function escapeHtml(s=''){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
  function sortByTime(arr){return arr.slice().sort((a,b)=>new Date(b.ts)-new Date(a.ts));}
  function formatDateTime(iso){const d=new Date(iso);return d.toLocaleString();}

  function applyFilters(list){
    const q=(searchEl.value||'').toLowerCase();
    const cat=(catEl.value||'').trim();
    return list.filter(o=>{
      if(cat&&(o.categoria||'')!==cat)return false;
      if(!q)return true;
      const hay=[o.title,o.empresa,o.desc].join(' ').toLowerCase();
      return hay.includes(q);
    });
  }

  function renderCard(o){
    const imgs=Array.isArray(o.images)?o.images:(o.images?[o.images]:[]);
    const imgHtml=imgs.length?`
      <div class="pp-media" data-id="${o.id}">
        <img src="${escapeHtml(imgs[0])}" alt="${escapeHtml(o.title)}"/>
        ${imgs.length>1?`<div class="img-count">${1}/${imgs.length}</div>`:''}
      </div>`:`<div class="pp-media" style="color:var(--muted)">Sin imagen</div>`;
    const badge=o.verificada?'<span class="badge">VERIFICADA</span>':'';
    const price=o.price?`<span class="badge">${escapeHtml(o.price)}</span>`:'';
    return `
      <article class="pp-card" data-id="${o.id}">
        ${imgHtml}
        <div class="pp-body">
          <div class="pp-row">
            <div>
              <div class="pp-titleCard">${escapeHtml(o.title)}</div>
              <div class="pp-subline">${escapeHtml(o.empresa||'')} ¬∑ ${escapeHtml(o.categoria||'')}</div>
            </div>
            <div class="pp-badges">${badge}${price}<div class="small">${formatDateTime(o.ts)}</div></div>
          </div>
          <div class="pp-desc">${escapeHtml(o.desc||'')}</div>
          <div class="pp-ctas">
            <a href="${o.url||'#'}" target="_blank" class="pp-cta-primary">Ir a la web</a>
          </div>
        </div>
      </article>`;
  }

  function render(){
    const arr=applyFilters(sortByTime(OFFERS));
    grid.innerHTML=arr.map(renderCard).join('')||`<div class="small" style="grid-column:1/-1;padding:18px">No hay ofertas.</div>`;
    countEl.textContent=OFFERS.length;
  }

  window.addOffer=function(offer){
    const o={
      id:offer.id||idGen(),
      empresa:offer.empresa||'Sin nombre',
      categoria:offer.categoria||'',
      title:offer.title||offer.desc?.slice(0,40)||'Oferta',
      desc:offer.desc||'',
      ts:offer.ts||nowISO(),
      url:offer.url||'#',
      verificada:!!offer.verificada,
      images:offer.images||offer.image||[],
      price:offer.price||''
    };
    OFFERS.push(o);render();return o.id;
  };
  window.setOffers=function(arr){
    OFFERS=Array.isArray(arr)?arr.map(a=>({...a,id:a.id||idGen(),ts:a.ts||nowISO()})):[];
    render();
  };

  floatBtn.addEventListener('click',()=>{location.hash='#/principal';});
  window.addEventListener('hashchange',()=>{panel.style.display=location.hash==='#/principal'?'block':'none';render();});
  document.addEventListener('DOMContentLoaded',()=>{if(location.hash==='#/principal'){panel.style.display='block';render();}});
  resetBtn.addEventListener('click',()=>{searchEl.value='';catEl.value='';render();});
  [searchEl,catEl].forEach(el=>el.addEventListener('input',()=>{clearTimeout(render.t);render.t=setTimeout(render,150);}))

  /* Ejemplo inicial */
  document.addEventListener('DOMContentLoaded',()=>{
    setOffers([
      {empresa:'Panader√≠a Sol',categoria:'comida-bebida',title:'Descuento 20% en tortas',desc:'Solo por hoy hasta agotar stock.',images:['https://picsum.photos/seed/torta/800/500'],url:'file:///C:/Users/User/Desktop/ChesskingOwen/STUDIO%20CODE/integradorlocal/impulsolocal001.html#/empresa/e-001',verificada:true,price:'-20%'},
      {empresa:'Taller AutoPro',categoria:'servicios',title:'Cambio de aceite gratis',desc:'Al realizar mantenimiento completo.                          ',images:['https://picsum.photos/seed/auto/800/500'],url:'#',verificada:false},
      {empresa:'Florer√≠a Natura',categoria:'hogar',title:'Rosas premium',desc:'Entrega a domicilio en 2 horas solo por hoy contamos con el descuento del 80% en todos nuestros productos seleccionados, no esperes m√°s y acercate a nuestras tiendas m√°s cercanas.-------------------------------------------',images:['https://picsum.photos/seed/flores/800/500'],url:'#',verificada:true},
      {empresa:'Jard√≠n de Ida',categoria:'hogar',title:'Rosas premium',desc:'Entrega a domicilio en 2 horas.',images:['images/width_800.jpeg'],url:'#',verificada:true}
    ]);
  });
})();
</script>

<!-- ========================================================= -->
<!-- FIN BLOQUE PLUS 02 (FINAL) -->
<!-- ========================================================= -->
<!-- ========================================================= -->
<!-- BLOQUE PLUS 2 ‚Äî PANEL PRINCIPAL (solo visible en #/principal) -->
<!-- ========================================================= -->
<script>
(function(){
  const PANEL_ID = "principalPanel";
  const FLOAT_BTN_ID = "ppFloatBtn";

  const ROUTER_CONTAINERS = ["main", "#main", "#app", ".router-view", ".contenido", ".page-container"];

  // Busca el contenedor principal de la SPA
  function findRouterContainer(){
    for(const sel of ROUTER_CONTAINERS){
      const el = document.querySelector(sel);
      if(el) return el;
    }
    return document.body;
  }

  // Detecta encabezado o barra superior
  function getHeader(){
    return document.querySelector("header, .navbar, .main-header, .topbar, .titulo-principal, .nav-bar");
  }

  // Muestra el panel dentro del contenedor
  function mountPanel(){
    const panel = document.getElementById(PANEL_ID);
    if(!panel) return;
    const container = findRouterContainer();
    if(!container) return;

    // Si ya est√° montado correctamente, solo mostrarlo
    if (panel.parentNode !== container) {
      container.innerHTML = ""; // limpia vista anterior (como p√°gina no encontrada)
      container.appendChild(panel);
    }

    // Calcular espacio superior (header + respiro)
    const header = getHeader();
    const headerH = header ? header.getBoundingClientRect().height : 0;
    const extraSpace = 24;
    const totalTop = headerH + extraSpace;

    // Estilos del panel
    panel.style.display = "block";
    panel.style.position = "relative";
    panel.style.marginTop = `${totalTop}px`;
    panel.style.zIndex = "10";
    panel.style.scrollMarginTop = `${totalTop}px`;

    // Scroll suave al mostrar
    setTimeout(() => {
      panel.scrollIntoView({ behavior: "smooth", block: "start" });
    }, 100);
  }

  // Oculta completamente el panel (sin eliminarlo)
  function hidePanel(){
    const panel = document.getElementById(PANEL_ID);
    if(panel){
      panel.style.display = "none";
    }
  }

  // Controla la ruta actual del hash
  function checkRoute(){
    const hash = location.hash || "";
    if(hash.startsWith("#/principal")){
      mountPanel();
    } else {
      hidePanel();
    }
  }

  // Vigila si el router cambia contenido
  const observer = new MutationObserver(()=>{
    const panel = document.getElementById(PANEL_ID);
    if(location.hash.startsWith("#/principal")){
      // Reinsertar el panel si el router lo elimin√≥
      const container = findRouterContainer();
      if(panel && container && !container.contains(panel)){
        mountPanel();
      }
    } else {
      hidePanel();
    }
  });
  observer.observe(document.body, {childList:true,subtree:true});

  // Eventos principales
  window.addEventListener("hashchange", checkRoute);
  document.addEventListener("DOMContentLoaded", checkRoute);

  // Bot√≥n flotante üåø
  const floatBtn = document.getElementById(FLOAT_BTN_ID);
  if(floatBtn){
    floatBtn.addEventListener("click",(e)=>{
      e.preventDefault();
      location.hash = "#/principal";
      checkRoute();
    });
  }

  // Ajuste din√°mico si cambia el tama√±o del header
  const header = getHeader();
  if (header) {
    new ResizeObserver(()=>{
      if(location.hash.startsWith("#/principal")) mountPanel();
    }).observe(header);
  }
})();
</script>




<script>
/* ============================================================
   SUPER JS FINAL ‚Äî WhatsApp + Gmail protegido + Prellenado
   Se ejecuta por encima de todos los dem√°s scripts.
   Evita overrides, reinyecta eventos y captura formulario.
============================================================ */

/* -----------------------
   1. Detectar empresa actual
------------------------ */
function IL_getEmpresaID() {
  const m = location.hash.match(/empresa\/(e-\d+)/);
  return m ? m[1] : null;
}

let IL_EMPRESA = IL_getEmpresaID();

window.addEventListener("hashchange", () => {
  IL_EMPRESA = IL_getEmpresaID();
});

/* -----------------------
   2. Obtener contacto seguro
------------------------ */
function IL_getContacto() {
  const id = IL_getEmpresaID();
  if (!id || !DATA || !DATA.empresas) return null;

  let emp = DATA.empresas.find(e => e.id === id);
  if (!emp) return null;

  let telefono = emp.telefono;
  let email    = emp.email;

  if (window.DATOS_MANUALES && DATOS_MANUALES[id]) {
    telefono ||= DATOS_MANUALES[id].telefono;
    email    ||= DATOS_MANUALES[id].email;
  }

  return { telefono, email, nombre: emp.nombre };
}

/* -----------------------
   3. WhatsApp protegido
------------------------ */
function IL_abrirWhatsApp(msg){
  const c = IL_getContacto();
  const numero = c.telefono.replace(/\D/g, "");
  const finalMsg = encodeURIComponent(msg || "");  
  window.open(`https://wa.me/${numero}?text=${finalMsg}`, "_blank");
}

/* -----------------------
   4. Gmail con mensaje prellenado desde el formulario
------------------------ */
function IL_abrirGmail() {
  const c = IL_getContacto();

  if (!c || !c.email) {
    alert("‚ö† Esta empresa no tiene correo registrado.");
    return;
  }

  // Capturar formulario
  const nombre   = document.getElementById("nombre")?.value.trim() || "";
  const correo   = document.getElementById("correo")?.value.trim() || "";
  const telefono = document.getElementById("telefono")?.value.trim() || "";
  const mensaje  = document.getElementById("mensaje")?.value.trim() || "";
  const acepto   = document.getElementById("politica")?.checked || false;

  // Validaciones
  let errores = [];
  if (!nombre)   errores.push("Debes ingresar tu nombre.");
  if (!correo)   errores.push("Debes ingresar un correo v√°lido.");
  if (!mensaje)  errores.push("Debes escribir tu mensaje.");
  if (!acepto)   errores.push("Debes aceptar la pol√≠tica de privacidad.");

  if (errores.length > 0) {
    alert("No se puede enviar a√∫n:\n\n" + errores.join("\n"));
    return;
  }

  // Construcci√≥n del cuerpo prellenado
  let body = "";
  body += ` Nombre: ${nombre}\n`;
  body += ` Correo: ${correo}\n`;
  if (telefono) body += ` Tel√©fono: ${telefono}\n`;
  body += `\n Mensaje:\n${mensaje}\n`;
  body += `\n---\nEnviado desde ImpulsoLocal\n${location.href}`;

  const asunto = `Consulta para ${c.nombre}`;

  // Abrir Gmail/cliente de correo
  const url = 
    `mailto:${c.email}?subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(body)}`;

  location.href = url;
}

/* -----------------------
   5. Forzar conexi√≥n de botones y evitar overrides
------------------------ */
function IL_conectarBotones() {
  const wa = document.getElementById("btnWhatsApp");
  const gm = document.getElementById("btnGmail");

  if (wa) {
    btnWhatsApp.onclick = () => {
  IL_openWAShortcuts((mensajeSeleccionado) => {
    IL_abrirWhatsApp(mensajeSeleccionado);
  });
};
    wa.removeAttribute("disabled");
  }

  if (gm) {
    gm.onclick = IL_abrirGmail;
    gm.removeAttribute("disabled");
  }
}

/* -----------------------
   6. Reinyecci√≥n autom√°tica si el DOM cambia
------------------------ */
const IL_observer = new MutationObserver(() => IL_conectarBotones());
IL_observer.observe(document.body, { childList: true, subtree: true });

/* -----------------------
   7. Cargar siempre
------------------------ */
document.addEventListener("DOMContentLoaded", IL_conectarBotones);
window.addEventListener("hashchange", () => {
  setTimeout(IL_conectarBotones, 80);
});
setTimeout(IL_conectarBotones, 1000);




(function () {
  // Esperamos a que IL_EMPRESA ya exista
  document.addEventListener("DOMContentLoaded", function () {

    if (typeof IL_EMPRESA === "undefined") return;

    // buscar empresa dentro de DATA
    const empresa = DATA.empresas.find(e => e.id === IL_EMPRESA);

    if (!empresa) return;

    const box = document.getElementById("IL_nombreEmpresaBox");
    if (box) {
      box.textContent = `Se enviar√° a: ${empresa.nombre}`;
    }

  });
})();
/* ===========================================================
   PROTECCI√ìN: Nombre de empresa blindado ante otros scripts
   Este m√≥dulo:
   ‚úî Espera a que IL_EMPRESA exista
   ‚úî Reintenta si otros scripts interfieren
   ‚úî Reescribe el nombre si otro JS lo cambia
   ‚úî Nunca afecta otros m√≥dulos
=========================================================== */

(function IL_protectedNameBox(){

  function setNameSafely() {
    try {
      if (typeof DATA === "undefined") return;
      if (typeof IL_EMPRESA === "undefined") return;

      const empresa = DATA.empresas.find(e => e.id === IL_EMPRESA);
      if (!empresa) return;

      const box = document.getElementById("IL_nombreEmpresaBox");
      if (!box) return;

      const desiredText = `Se enviar√° a: ${empresa.nombre}`;

      // Si el texto actual NO es el que debe ser ‚Üí lo reescribe
      if (box.textContent.trim() !== desiredText.trim()) {
        box.textContent = desiredText;
      }

    } catch(e){ /* evita ca√≠das */ }
  }

  // Protecci√≥n de carga inicial
  document.addEventListener("DOMContentLoaded", setNameSafely);

  // Protecci√≥n continua contra sobrescritura por otros scripts
  const observer = new MutationObserver(setNameSafely);
  const interval = setInterval(setNameSafely, 200);

  document.addEventListener("DOMContentLoaded", () => {
    const box = document.getElementById("IL_nombreEmpresaBox");
    if (box) {
      observer.observe(box, { childList: true, characterData: true, subtree: true });
      setTimeout(() => clearInterval(interval), 5000); // luego de 5s deja de vigilar
    }
  });

})();


/* ============================================
   SISTEMA GLOBAL DE FAVORITOS
   Compatible, aislado y seguro
============================================ */

(function(){

  // Obtener lista de favoritos almacenados
  const getFavs = () => {
    return JSON.parse(localStorage.getItem("FAV_EMPRESAS") || "[]");
  };

  // Guardar favoritos
  const saveFavs = favs => {
    localStorage.setItem("FAV_EMPRESAS", JSON.stringify(favs));
  };

  // Activar icono si ya es favorito
  function applyFavState(){
    const icon = document.querySelector(".fav-icon");
    if (!icon) return;

    const favs = getFavs();
    const id = icon.getAttribute("data-id");

    if (favs.includes(id)) {
      icon.classList.add("fav-active");
      icon.textContent = "üß°";
    } else {
      icon.classList.remove("fav-active");
      icon.textContent = "‚ô°";
    }
  }

  // Acci√≥n al hacer click
  document.addEventListener("click", function(e){
    if (!e.target.classList.contains("fav-icon")) return;

    const icon = e.target;
    const id = icon.getAttribute("data-id");
    let favs = getFavs();

    if (favs.includes(id)) {
      // quitar de favoritos
      favs = favs.filter(x => x !== id);
      icon.classList.remove("fav-active");
      icon.textContent = "‚ô°";
    } 
    else {
      // a√±adir a favoritos
      favs.push(id);
      icon.classList.add("fav-active");
      icon.textContent = "üß°";
    }

    saveFavs(favs);
  });

  // Reaplicar estado al recargar
  document.addEventListener("DOMContentLoaded", applyFavState);

})();
/* ===================================================================
   PROTECCI√ìN AVANZADA PARA MANTENER üß° A√öN CON window.location.reload()
   - Reaplica estado muchas veces durante la carga
   - Se ejecuta incluso ANTES de que el DOM termine
   - Vuelve a corregir si otros scripts lo alteran
=================================================================== */

(function(){

  function IL_forceFavState(){
    const icon = document.querySelector(".fav-icon");
    if (!icon) return;

    const favs = JSON.parse(localStorage.getItem("FAV_EMPRESAS") || "[]");
    const id = icon.getAttribute("data-id");
    const isFav = favs.includes(id);

    const correctText = isFav ? "üß°" : "‚ô°";

    // Restaurar texto si cambia
    if (icon.textContent.trim() !== correctText) {
      icon.textContent = correctText;
    }

    // Restaurar clase si cambia
    if (isFav && !icon.classList.contains("fav-active")) {
      icon.classList.add("fav-active");
    }
    if (!isFav && icon.classList.contains("fav-active")) {
      icon.classList.remove("fav-active");
    }
  }

  /* ---------------------------------------------------------------
     1) CORRECCI√ìN TEMPRANA - Antes de que el DOM termine de cargar
  ---------------------------------------------------------------- */
  const earlyInterval = setInterval(() => {
    IL_forceFavState();
  }, 50);

  /* ---------------------------------------------------------------
     2) CORRECCI√ìN NORMAL - Cuando el DOM ya carg√≥
  ---------------------------------------------------------------- */
  document.addEventListener("DOMContentLoaded", () => {
    IL_forceFavState();
    setTimeout(IL_forceFavState, 50);
    setTimeout(IL_forceFavState, 150);
    setTimeout(IL_forceFavState, 300);
    setTimeout(IL_forceFavState, 450);
    
    clearInterval(earlyInterval);
  });

  /* ---------------------------------------------------------------
     3) CORRECCI√ìN ANTI-MUTACI√ìN - Si otro script cambia el icono
  ---------------------------------------------------------------- */
  const observer = new MutationObserver(() => IL_forceFavState());

  function activateObserver(){
    const icon = document.querySelector(".fav-icon");
    if (!icon) return;

    observer.observe(icon, {
      childList: true,
      characterData: true,
      attributes: true,
      subtree: true
    });
  }

  document.addEventListener("DOMContentLoaded", activateObserver);

  /* ---------------------------------------------------------------
     4) REFUERZO EXTENDIDO - Durante 4 segundos por si hay recargas r√°pidas
  ---------------------------------------------------------------- */
  let pass = 0;
  const reinforced = setInterval(() => {
    IL_forceFavState();
    pass++;
    if (pass > 40) clearInterval(reinforced); // dura ~4 segundos
  }, 100);

})();

</script>



<!-- =========================================================
     MODAL DE ATAJOS WHATSAPP ‚Äî MODELO A (CENTRADO)
     C√≥digo 100% independiente y compatible con cualquier sitio
========================================================= -->

<style>
  /* Fondo oscuro difuminado */
  #waShortcutOverlay {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.55);
    backdrop-filter: blur(3px);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 99999;
  }

  /* Caja principal */
  #waShortcutModal {
  position: relative;
  background: white;
  width: 90%;
  max-width: 360px;
  padding: 20px;
  padding-top: 28px; /* para que no choque la X */
  border-radius: 14px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.25);
  animation: fadeInModal 0.25s ease-out;
}

  @keyframes fadeInModal {
    from { transform: scale(0.85); opacity: 0; }
    to   { transform: scale(1); opacity: 1; }
  }

  #waShortcutModal h3 {
    margin-top: 0;
    margin-bottom: 16px;
    font-size: 18px;
    text-align: center;
    font-weight: 600;
  }

  .wa-option-btn {
    width: 100%;
    padding: 10px 14px;
    margin-bottom: 8px;
    background: #e8f5e9;
    border: 1px solid #b5dfc0;
    border-radius: 8px;
    text-align: left;
    cursor: pointer;
    font-size: 14px;
    transition: 0.15s;
  }

  .wa-option-btn:hover {
    background: #d5f0da;
  }

  .wa-omit-btn {
    width: 100%;
    padding: 10px;
    background: #f2f2f2;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 500;
    margin-top: 8px;
    text-align: center;
  }
#waCloseBtn {
  position: absolute;
  top: 8px;
  right: 10px;
  font-size: 18px;
  font-weight: 600;
  color: #777;
  cursor: pointer;
  transition: 0.15s;
}

#waCloseBtn:hover {
  color: #333;
  transform: scale(1.15);
}
/* ===== Protecci√≥n de color para todo el modal (incluye t√≠tulo) ===== */
#waShortcutModal,
#waShortcutModal * {
  color: inherit !important;
}

/* Fuerza el color espec√≠fico de los textos dentro del modal */
#waShortcutModal h3,
#waShortcutModal h3 * {
  color: #222 !important;        /* color del t√≠tulo */
  font-weight: 600 !important;
}

/* Fuerza el color espec√≠fico de los botones de opci√≥n */
#waShortcutModal .wa-option-btn,
#waShortcutModal .wa-option-btn * {
  color: #1f2937 !important;     /* texto botones (gris oscuro) */
}

/* Bot√≥n Omitir */
#waShortcutModal .wa-omit-btn,
#waShortcutModal .wa-omit-btn * {
  color: #374151 !important;     /* texto omit (gris) */
}

/* X de cierre */
#waCloseBtn,
#waCloseBtn * {
  color: #6b7280 !important;     /* color de la X */
}

/* Si usas tema oscuro dentro del modal, puedes anular aqu√≠:
#waShortcutModal { background: #111; }
#waShortcutModal h3 { color: #fff !important; }
*/



/* ============================================
   BANNER/PANEL SUPERIOR DE EMPRESA
============================================ */
.empresa-banner {
  width: 100%;
  aspect-ratio: 21/9; /* proporci√≥n panor√°mica */
  border-radius: 16px 16px 0 0;
  overflow: hidden;
  position: relative;
  background: linear-gradient(180deg, 
    rgba(10,124,255,0.15) 0%, 
    rgba(98,209,255,0.08) 100%);
  margin-bottom: -20px; /* solapamiento con ficha-head */
  z-index: 1;
}

.empresa-banner img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  transition: transform 0.3s ease;
}

.empresa-banner:hover img {
  transform: scale(1.02);
}

/* Ajuste del header para que est√© debajo del banner */
.ficha-head {
  position: relative;
  z-index: 2;
  margin-top: 0;
}

/* Versi√≥n responsiva */
@media (max-width: 468px) {
  .empresa-banner {
    aspect-ratio: 16/9;
    margin-bottom: -16px;
  }
}



/* ============================================
   SLOGAN PERSONALIZADO DE EMPRESA
============================================ */
.empresa-slogan {
  font-size: 16px;
  font-weight: 600;
  font-style: italic;
  color: var(--muted);
  margin: 6px 0 8px 0;
  letter-spacing: 0.3px;
  line-height: 1.4;
  position: relative;
  padding-left: 12px;
}

/* Decoraci√≥n de comillas o l√≠nea */
.empresa-slogan::before {
  content: '"';
  position: absolute;
  left: 0;
  top: -4px;
  font-size: 24px;
  color: var(--brand-2);
  opacity: 0.6;
  font-family: Georgia, serif;
}

/* Versi√≥n para tema verde-suave */
[data-theme='suave'] .empresa-slogan {
  color: #4b5a24;
  font-weight: 700;
  background: linear-gradient(135deg, #2e3220, #4b5a24, #6b7a42);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

[data-theme='suave'] .empresa-slogan::before {
  color: #bfff8a;
  opacity: 0.8;
}

/* Responsivo */
@media (max-width: 768px) {
  .empresa-slogan {
    font-size: 14px;
    padding-left: 8px;
  }
  
  .empresa-slogan::before {
    font-size: 20px;
  }
}


/* ============================================
   LOGOTIPO PERSONALIZADO DE EMPRESA
============================================ */
.ficha-logo,
.card-logo,
.brand-logo {
  width: 60px;
  height: 60px;
  border-radius: 14px;
  display: grid;
  place-items: center;
  font-weight: 900;
  color: #fff;
  background: conic-gradient(from 180deg at 50% 50%, var(--brand), var(--brand-2), var(--brand));
  box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.14);
  position: relative;
  overflow: hidden;
  flex-shrink: 0;
}

/* Logotipo con imagen */
.ficha-logo img,
.card-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  display: block;
  border-radius: inherit;
  background: white;
  padding: 4px;
}

/* Logotipo en ficha de empresa (m√°s grande) */
.ficha-head .ficha-logo {
  width: 80px;
  height: 80px;
  border-radius: 16px;
}

/* Logotipo en tarjetas de listado */
.card-company .card-logo,
.list-item .logo {
  width: 60px;
  height: 60px;
}

/* Fallback para emoji si no hay imagen */
.ficha-logo .emoji-fallback,
.card-logo .emoji-fallback {
  font-size: 32px;
}

.ficha-head .ficha-logo .emoji-fallback {
  font-size: 40px;
}

/* Efecto hover en logotipo */
.ficha-logo:hover img,
.card-logo:hover img {
  transform: scale(1.08);
  transition: transform 0.3s ease;
}

/* Versi√≥n para tema verde-suave */
[data-theme='suave'] .ficha-logo,
[data-theme='suave'] .card-logo {
  background: linear-gradient(135deg, #bfff8a 0%, #91e67f 50%, #dbff95 100%);
  box-shadow: 0 4px 16px rgba(191, 255, 138, 0.4),
              inset 0 1px 0 rgba(255, 255, 255, 0.6);
}

/* Badge verificada sobre el logo (opcional) */
.logo-verified-badge {
  position: absolute;
  bottom: -4px;
  right: -4px;
  width: 24px;
  height: 24px;
  background: linear-gradient(135deg, #10b981, #34d399);
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 12px;
  box-shadow: 0 2px 8px rgba(16, 185, 129, 0.4);
  border: 2px solid white;
  z-index: 2;
}

/* Responsivo */
@media (max-width: 768px) {
  .ficha-head .ficha-logo {
    width: 64px;
    height: 64px;
  }
  
  .card-logo, .list-item .logo {
    width: 48px;
    height: 48px;
  }
}

/* ============================================
   LOGO Y SLOGAN EN TARJETAS DE LISTADO
============================================ */

/* Ajustar el contenedor del logo en listados */
.card-company .card-head,
.list-item {
  gap: 14px;
}

/* Logo en listados - reutiliza estilos existentes */
.card-company .card-head .card-logo {
  width: 64px;
  height: 64px;
  border-radius: 14px;
  overflow: hidden;
  flex-shrink: 0;
}

.card-company .card-logo img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  background: white;
  padding: 4px;
}

/* Slogan en tarjetas de listado */
.card-title .empresa-slogan {
  font-size: 13px;
  font-style: italic;
  color: var(--muted);
  margin: 4px 0 6px 0;
  line-height: 1.3;
  font-weight: 500;
  padding-left: 0; /* Quitar padding del ::before en listados */
}

.card-title .empresa-slogan::before {
  display: none; /* Sin comillas en listado */
}

/* Versi√≥n para tema verde-suave en listados */
[data-theme='suave'] .card-title .empresa-slogan {
  color: #4b5a24;
  font-weight: 600;
  background: linear-gradient(135deg, #2e3220, #4b5a24);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Mini badge verificada en el logo */
.card-logo .mini-verified {
  position: absolute;
  bottom: -3px;
  right: -3px;
  width: 20px;
  height: 20px;
  background: linear-gradient(135deg, #10b981, #34d399);
  border-radius: 50%;
  display: grid;
  place-items: center;
  font-size: 11px;
  box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4);
  border: 2px solid white;
  z-index: 2;
}

/* Responsivo */
@media (max-width: 768px) {
  .card-company .card-logo {
    width: 52px;
    height: 52px;
  }
  
  .card-title .empresa-slogan {
    font-size: 12px;
  }
}
</style>


<div id="waShortcutOverlay">
  <div id="waShortcutModal">
    <div id="waCloseBtn">‚úï</div>
    <h3>¬øC√≥mo deseas iniciar la conversaci√≥n?</h3>

    <button class="wa-option-btn" data-msg="Hola, estoy interesado y quiero saber m√°s detalles.">
      Hola, estoy interesado y quiero saber m√°s detalles.
    </button>

    <button class="wa-option-btn" data-msg="Hola, quiero consultar precios y disponibilidad.">
      Hola, quiero consultar precios y disponibilidad.
    </button>

    <button class="wa-option-btn" data-msg="Hola, quisiera hacer un pedido.">
      Hola, quisiera hacer un pedido.
    </button>

    <div class="wa-omit-btn" id="waOmitir">Omitir</div>
  </div>
</div>


<script>
/* =========================================================
   SISTEMA DE POPUP DE ATAJOS PARA WHATSAPP
   Este bloque NO reemplaza tu c√≥digo actual, solo lo extiende.
========================================================= */

(function(){

  // --- Abrir popup ---
  window.IL_openWAShortcuts = function(callbackSendWhatsApp){
    window.__IL_WA_SEND_CALLBACK = callbackSendWhatsApp;
    document.getElementById("waShortcutOverlay").style.display = "flex";
  };

  // --- Cerrar popup ---
  function IL_closeWAShortcuts(){
    document.getElementById("waShortcutOverlay").style.display = "none";
  }

  // --- Detectar selecci√≥n de mensaje ---
  document.querySelectorAll(".wa-option-btn").forEach(btn => {
    btn.addEventListener("click", () => {
      const msg = btn.getAttribute("data-msg");
      if (window.__IL_WA_SEND_CALLBACK){
        window.__IL_WA_SEND_CALLBACK(msg);
      }
      IL_closeWAShortcuts();
    });
  });

  // --- Bot√≥n Omitir ---
  document.getElementById("waOmitir").addEventListener("click", () => {
    if (window.__IL_WA_SEND_CALLBACK){
      window.__IL_WA_SEND_CALLBACK(""); // mensaje vac√≠o
    }
    IL_closeWAShortcuts();
  });
document.getElementById("waCloseBtn").addEventListener("click", () => {
  document.getElementById("waShortcutOverlay").style.display = "none";
});
})();

// Recarga autom√°tica cuando el usuario usa atr√°s/adelante
window.addEventListener("popstate", function () {
  window.location.reload();
});

/* ============================================================
   Helper: Renderizar logo con fallback
============================================================ */
// Reemplaza/asegura la funci√≥n renderLogo existente
function renderLogo(empresa, size = 'normal') {
  const sizeClass = size === 'large' ? 'ficha-logo' : 'card-logo';
  const logo = empresa.logo || '';
  const icon = empresa.icon || '';
  const verified = empresa.verificada ? true : false;

  // Usa encodeURI para evitar problemas con espacios/caracteres
  const src = logo && String(logo).trim() ? encodeURI(logo) : '';

  if (src) {
    return `
      <div class="${sizeClass}" aria-hidden="true" style="position:relative;overflow:hidden;">
        <img src="${src}" alt="Logo de ${empresa.nombre}" 
             loading="lazy" 
             style="width:100%;height:100%;object-fit:cover;border-radius:12px;background:white;padding:4px;display:block;"
             onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
        <div class="emoji-fallback" style="display:none;align-items:center;justify-content:center;height:100%;font-size:20px;">
          ${icon}
        </div>
        ${verified ? '<span class="logo-verified-badge" aria-hidden="true">‚úì</span>' : ''}
      </div>`;
  } else {
    return `
      <div class="${sizeClass}" aria-hidden="true" style="display:grid;place-items:center;border-radius:12px;background:linear-gradient(180deg,var(--brand-2),var(--brand));color:white;font-weight:900;">
        <span style="font-size:20px">${icon || (empresa.nombre || '').slice(0,2).toUpperCase()}</span>
        ${verified ? '<span class="logo-verified-badge" aria-hidden="true">‚úì</span>' : ''}
      </div>`;
  }
}

</script>


<script>
/* ============================================================
   ‚úÖ CORRECCI√ìN FINAL - Logo real + Slogan en tarjetas
   Usa exactamente el mismo c√≥digo que funciona en la ficha
============================================================ */

(function LOGO_REAL_Y_SLOGAN_FINAL(){
  
  console.log('‚úÖ Aplicando logo real y slogan...');
  
  // ‚úÖ Funci√≥n de logo EXACTA como en la ficha
  function renderLogoReal(e) {
    const nombre = e.nombre || e.name || 'Negocio';
    const iniciales = nombre.substring(0, 2).toUpperCase();
    const logo = e.logo || null;
    const icon = e.icon || '';
    
    // Si tiene logo real que empiece con 'images/'
    const tieneLogoReal = logo && String(logo).trim() && String(logo).startsWith('images/');
    
    if (tieneLogoReal) {
      // Logo con imagen real
      return `
        <img src="${logo}" 
             alt="Logo de ${nombre}" 
             loading="lazy" 
             style="width:100%;height:100%;object-fit:cover;border-radius:12px;background:white;padding:4px;"
             onerror="this.style.display='none';this.nextElementSibling.style.display='flex';">
        <span style="display:none;font-size:24px;font-weight:900;color:white;text-shadow:0 2px 4px rgba(0,0,0,.15);">${iniciales}</span>`;
    } else {
      // Iniciales con gradiente (sin emoji)
      return `<span style="font-size:24px;font-weight:900;color:white;text-shadow:0 2px 4px rgba(0,0,0,.15);">${iniciales}</span>`;
    }
  }
  
  // ‚úÖ TARJETA COMPLETA para vista Grid con imagen en tercio inferior
function tarjetaGrid(e) {
  const nombre = e.nombre || e.name || 'Negocio';
  const logo = e.logo || null;
  const tieneLogoReal = logo && String(logo).trim() && String(logo).startsWith('images/');
  const logoBackground = tieneLogoReal ? 'white' : 'linear-gradient(135deg, #0a7cff, #62d1ff)';
  const badge = e.verificada ? '<span class="badge">Verificada</span>' : '';
  
  // ‚úÖ NUEVA: Imagen de presentaci√≥n en el tercio inferior
  const imgPresentacion = e.imgpresentacion || null;
  
  const imagenInferiorHtml = imgPresentacion 
    ? `<div class="card-img-bottom" style="
         position: absolute;
         bottom: 0;
         left: 0;
         right: 0;
         height: 33.333%;
         overflow: hidden;
         z-index: 0;
         opacity: 0.6;
       ">
         <img src="${imgPresentacion}" 
              alt="Vista de ${nombre}" 
              loading="lazy"
              style="
                width: 100%;
                height: 100%;
                object-fit: cover;
                filter: brightness(1.05);
              ">
         <div style="
           position: absolute;
           inset: 0;
           background: linear-gradient(to bottom, 
             rgba(255,255,255,0.75) 0%, 
             rgba(255,255,255,0.2) 60%, 
             transparent 100%
           );
         "></div>
       </div>`
    : '';
  
  return `
  <article class="card-company" style="position:relative;overflow:hidden;">
    ${imagenInferiorHtml}
    <header class="card-head" style="position:relative;z-index:1;">
      <div class="card-logo" style="width:64px;height:64px;border-radius:14px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:${logoBackground};box-shadow:inset 0 0 0 2px rgba(255,255,255,.14);position:relative;flex-shrink:0;">
        ${renderLogoReal(e)}
        ${e.verificada ? '<span style="position:absolute;bottom:-3px;right:-3px;width:20px;height:20px;background:linear-gradient(135deg,#10b981,#34d399);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;color:white;border:2px solid white;z-index:2;">‚úì</span>' : ''}
      </div>
      <div class="card-title" style="flex:1;">
        <a href="#/empresa/${e.id}" style="font-weight:900;display:block;">${nombre}</a>
        ${e.slogan ? `<div class="empresa-slogan" style="font-size:13px;font-style:italic;color:var(--muted);margin:4px 0 6px 0;line-height:1.3;font-weight:500;display:block;">${e.slogan}</div>` : ''}
        <div class="card-badges">${badge}</div>
      </div>
    </header>
    <div class="card-body" style="position:relative;z-index:1;">
      <p style="margin:0;color:var(--muted);font-size:13px;">${e.descrip || ''}</p>
      <div style="margin-top:8px;">
        <span class="chip" style="backdrop-filter:blur(3px);background:rgba(255,255,255,0.85);">üìç ${e.loc}</span>
      </div>
      <div class="card-actions" style="margin-top:10px;">
        <a class="btn" href="#/empresa/${e.id}">Ver m√°s</a>
      </div>
    </div>
  </article>`;
}
  
 
  
  // ‚úÖ SOBRESCRIBIR renderGridRich
  window.renderGridRich = function(list, sel) {
    const el = typeof sel === 'string' ? document.querySelector(sel) : sel;
    if (!el) return;
    
    if (!list?.length) {
      el.innerHTML = `<div class="section"><h3>Sin resultados</h3></div>`;
      return;
    }
    
    el.innerHTML = `<div class="grid-list">${list.map(e => tarjetaGrid(e)).join('')}</div>`;
    console.log('‚úÖ Grid renderizado con', list.length, 'empresas');
  };
  
 
  
  
  
  
})();

</script>


<script>
/* ============================================================
   GALER√çA MEJORADA - Bordes circulares, copiar imagen y navegaci√≥n
============================================================ */
(function(){
  
  // 1. APLICAR BORDES CIRCULARES A LA IMAGEN PRINCIPAL
  function aplicarBordesCirculares() {
    const imgPrincipal = document.querySelector('#galMain');
    if (imgPrincipal) {
      imgPrincipal.style.borderRadius = '38%';
      
    }
  }

   // 2. CREAR BOT√ìN DE COPIAR IMAGEN
  function crearBotonCopiar() {
    const galeria = document.querySelector('.gallery-main');
    if (!galeria || document.getElementById('btnCopiarImagen')) return;

    const btnCopiar = document.createElement('button');
    btnCopiar.id = 'btnCopiarImagen';
    btnCopiar.innerHTML = 'üìã';
    btnCopiar.title = 'Copiar imagen';
    btnCopiar.style.cssText = `
      position: absolute;
      top: 10px;
      right: 10px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid #0a7cff;
      cursor: pointer;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    `;

    btnCopiar.addEventListener('mouseenter', () => {
      btnCopiar.style.transform = 'scale(1.1)';
      btnCopiar.style.background = 'rgba(10, 124, 255, 0.9)';
    });

    btnCopiar.addEventListener('mouseleave', () => {
      btnCopiar.style.transform = 'scale(1)';
      btnCopiar.style.background = 'rgba(255, 255, 255, 0.9)';
    });

    btnCopiar.addEventListener('click', async (e) => {
      e.stopPropagation();
      await copiarImagenNativa();
    });

    galeria.appendChild(btnCopiar);
  }

  // COPIAR IMAGEN COMO SI FUERA CLIC DERECHO ‚Üí COPIAR IMAGEN
  async function copiarImagenNativa() {
    const img = document.querySelector('#galMain');
    if (!img || !img.src) {
      mostrarAviso('‚ö†Ô∏è No se encontr√≥ la imagen', 'error');
      return;
    }

    try {
      const btnCopiar = document.getElementById('btnCopiarImagen');
      if (btnCopiar) {
        btnCopiar.innerHTML = '‚è≥';
        btnCopiar.style.pointerEvents = 'none';
      }

      // Convertir imagen a blob
      const response = await fetch(img.src);
      const blob = await response.blob();
      
      // Copiar al portapapeles usando Clipboard API
      if (navigator.clipboard && window.ClipboardItem) {
        await navigator.clipboard.write([
          new ClipboardItem({
            [blob.type]: blob
          })
        ]);
        
        mostrarAviso('‚úÖ Imagen copiada', 'success');
      } else {
        // Fallback: intentar con canvas
        copiarConCanvas(img);
      }

      // Restaurar bot√≥n
      setTimeout(() => {
        if (btnCopiar) {
          btnCopiar.innerHTML = '‚úì';
          setTimeout(() => {
            btnCopiar.innerHTML = 'üìã';
            btnCopiar.style.pointerEvents = 'auto';
          }, 1200);
        }
      }, 300);

    } catch (error) {
      console.error('Error:', error);
      mostrarAviso('‚ö†Ô∏è No se pudo copiar. Usa clic derecho ‚Üí Copiar imagen', 'error');
      
      if (document.getElementById('btnCopiarImagen')) {
        document.getElementById('btnCopiarImagen').innerHTML = '‚ùå';
        setTimeout(() => {
          document.getElementById('btnCopiarImagen').innerHTML = 'üìã';
          document.getElementById('btnCopiarImagen').style.pointerEvents = 'auto';
        }, 1500);
      }
    }
  }

  // Fallback usando canvas
  function copiarConCanvas(img) {
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    
    canvas.width = img.naturalWidth;
    canvas.height = img.naturalHeight;
    ctx.drawImage(img, 0, 0);
    
    canvas.toBlob(async (blob) => {
      try {
        await navigator.clipboard.write([
          new ClipboardItem({ 'image/png': blob })
        ]);
        mostrarAviso('‚úÖ Imagen copiada', 'success');
      } catch (err) {
        mostrarAviso('‚ö†Ô∏è Usa clic derecho ‚Üí Copiar imagen', 'error');
      }
    });
  }

  function mostrarAviso(mensaje, tipo = 'success') {
    if (window.Toast) {
      Toast.show(mensaje, tipo === 'success' ? 'ok' : 'error');
      return;
    }

    const aviso = document.createElement('div');
    aviso.textContent = mensaje;
    aviso.style.cssText = `
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: ${tipo === 'success' ? '#10b981' : '#ef4444'};
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      z-index: 99999;
      animation: slideIn 0.3s ease;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    `;
    document.body.appendChild(aviso);
    setTimeout(() => {
      aviso.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => aviso.remove(), 300);
    }, 2500);
  }

  // 3. NAVEGACI√ìN EN LIGHTBOX (DESPLAZA IM√ÅGENES REALES)
  function agregarNavegacionLightbox() {
    const lightbox = document.getElementById('ilLightbox');
    if (!lightbox || document.getElementById('lbPrev')) return;

    const wrap = lightbox.querySelector('.wrap');
    if (!wrap) return;

    // Crear botones de navegaci√≥n
    const btnPrev = document.createElement('button');
    btnPrev.id = 'lbPrev';
    btnPrev.innerHTML = '‚Äπ';
    btnPrev.title = 'Imagen anterior (‚Üê)';
    btnPrev.style.cssText = `
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      border: none;
      color: #0a7cff;
      font-size: 36px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: all 0.25s ease;
      box-shadow: 0 4px 16px rgba(0,0,0,0.25);
      font-family: Arial, sans-serif;
      line-height: 1;
      padding-bottom: 3px;
    `;

    const btnNext = document.createElement('button');
    btnNext.id = 'lbNext';
    btnNext.innerHTML = '‚Ä∫';
    btnNext.title = 'Siguiente imagen (‚Üí)';
    btnNext.style.cssText = btnPrev.style.cssText.replace('left: 20px', 'right: 20px');

    // Efectos hover
    [btnPrev, btnNext].forEach(btn => {
      btn.addEventListener('mouseenter', () => {
        btn.style.background = '#0a7cff';
        btn.style.color = 'white';
        btn.style.transform = 'translateY(-50%) scale(1.15)';
        btn.style.boxShadow = '0 6px 20px rgba(10,124,255,0.4)';
      });

      btn.addEventListener('mouseleave', () => {
        btn.style.background = 'rgba(255, 255, 255, 0.95)';
        btn.style.color = '#0a7cff';
        btn.style.transform = 'translateY(-50%) scale(1)';
        btn.style.boxShadow = '0 4px 16px rgba(0,0,0,0.25)';
      });

      btn.addEventListener('mousedown', () => {
        btn.style.transform = 'translateY(-50%) scale(1.05)';
      });

      btn.addEventListener('mouseup', () => {
        btn.style.transform = 'translateY(-50%) scale(1.15)';
      });
    });

    // L√≥gica de navegaci√≥n - CAMBIA IMAGEN DEL LIGHTBOX
    btnPrev.addEventListener('click', (e) => {
      e.stopPropagation();
      navegarImagenLightbox(-1);
    });

    btnNext.addEventListener('click', (e) => {
      e.stopPropagation();
      navegarImagenLightbox(1);
    });

    wrap.appendChild(btnPrev);
    wrap.appendChild(btnNext);

    // Navegaci√≥n con teclado
    const handlerTeclado = (e) => {
      if (!lightbox.classList.contains('show')) return;
      
      if (e.key === 'ArrowLeft') {
        e.preventDefault();
        navegarImagenLightbox(-1);
      }
      if (e.key === 'ArrowRight') {
        e.preventDefault();
        navegarImagenLightbox(1);
      }
    };

    // Remover listeners anteriores
    window.removeEventListener('keydown', handlerTeclado);
    window.addEventListener('keydown', handlerTeclado);
  }

  // NAVEGAR ENTRE IM√ÅGENES EN EL LIGHTBOX
  function navegarImagenLightbox(direccion) {
    const lightbox = document.getElementById('ilLightbox');
    const imgLightbox = document.querySelector('#ilLightboxImg');
    const thumbs = Array.from(document.querySelectorAll('.thumb'));
    const activo = document.querySelector('.thumb[aria-current="true"]');
    
    if (!thumbs.length || !activo || !imgLightbox) return;

    const indiceActual = thumbs.indexOf(activo);
    let nuevoIndice = indiceActual + direccion;

    // Ciclo infinito
    if (nuevoIndice < 0) nuevoIndice = thumbs.length - 1;
    if (nuevoIndice >= thumbs.length) nuevoIndice = 0;

    const nuevoThumb = thumbs[nuevoIndice];
    const nuevaSrc = nuevoThumb.dataset.src || nuevoThumb.querySelector('img')?.src || '';

    if (nuevaSrc) {
      // Efecto de transici√≥n suave
      imgLightbox.style.opacity = '0.5';
      imgLightbox.style.transform = 'scale(0.95)';

      setTimeout(() => {
        imgLightbox.src = nuevaSrc;
        imgLightbox.alt = `Imagen ${nuevoIndice + 1} de ${thumbs.length}`;
        
        // Actualizar thumbnails activos
        thumbs.forEach(t => t.setAttribute('aria-current', 'false'));
        nuevoThumb.setAttribute('aria-current', 'true');

        // Restaurar visual
        setTimeout(() => {
          imgLightbox.style.opacity = '1';
          imgLightbox.style.transform = 'scale(1)';
        }, 50);
      }, 150);
    }
  }
    // Navegaci√≥n con teclado
    window.addEventListener('keydown', (e) => {
      if (!lightbox.classList.contains('show')) return;
      
      if (e.key === 'ArrowLeft') navegarImagen(-1);
      if (e.key === 'ArrowRight') navegarImagen(1);
    });
  

  // FUNCI√ìN PARA NAVEGAR ENTRE IM√ÅGENES
  function navegarImagen(direccion) {
    const thumbs = Array.from(document.querySelectorAll('.thumb'));
    const activo = document.querySelector('.thumb[aria-current="true"]');
    
    if (!thumbs.length || !activo) return;

    const indiceActual = thumbs.indexOf(activo);
    let nuevoIndice = indiceActual + direccion;

    // Ciclo infinito
    if (nuevoIndice < 0) nuevoIndice = thumbs.length - 1;
    if (nuevoIndice >= thumbs.length) nuevoIndice = 0;

    thumbs[nuevoIndice].click();
  }

  // INICIALIZAR TODO
  function inicializar() {
    aplicarBordesCirculares();
    crearBotonCopiar();
    agregarNavegacionLightbox();
  }

  // OBSERVADOR PARA DETECTAR CAMBIOS EN LA GALER√çA
  const observer = new MutationObserver(() => {
    if (document.querySelector('.gallery-main')) {
      inicializar();
    }
  });

  observer.observe(document.body, { childList: true, subtree: true });

  // Ejecutar al cargar
  document.addEventListener('DOMContentLoaded', inicializar);
  window.addEventListener('hashchange', () => setTimeout(inicializar, 100));

  // Ejecutar inmediatamente si ya existe
  if (document.querySelector('.gallery-main')) {
    inicializar();
  }

})();
</script>

<style>
/* Animaci√≥n para el aviso de copiado */
@keyframes slideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Asegurar que los botones sean visibles sobre el lightbox */
#ilLightbox .wrap {
  position: relative;
}

/* Efecto de pulsaci√≥n para los botones */
#btnCopiarImagen:active,
#lbPrev:active,
#lbNext:active {
  transform: scale(0.95) !important;
}
</style>

<style>
/* ============================================
   BOT√ìN WHATSAPP CIRCULAR FLOTANTE
   Solo visible en p√°ginas de empresa
============================================ */

/* Bot√≥n WhatsApp circular */
#btnWhatsAppFloat {
  position: fixed;
  bottom: 96px; /* Encima del bot√≥n de promociones (22px base + 54px altura + 20px espacio) */
  right: 22px;
  width: 64px;
  height: 64px;
  background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  border-radius: 50%;
  border: none;
  cursor: pointer;
  z-index: 999998; /* Un nivel debajo del modal pero encima de promociones */
  box-shadow: 0 8px 24px rgba(37, 211, 102, 0.35);
  display: none; /* Oculto por defecto */
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-size: 32px;
  color: white;
}

#btnWhatsAppFloat:hover {
  transform: scale(1.1);
  box-shadow: 0 12px 32px rgba(37, 211, 102, 0.5);
  background: linear-gradient(135deg, #20bd5a 0%, #0e7a69 100%);
}

#btnWhatsAppFloat:active {
  transform: scale(0.95);
}

/* Animaci√≥n de entrada */
@keyframes bounceIn {
  0% {
    opacity: 0;
    transform: scale(0.3);
  }
  50% {
    opacity: 1;
    transform: scale(1.05);
  }
  70% {
    transform: scale(0.9);
  }
  100% {
    transform: scale(1);
  }
}

#btnWhatsAppFloat.show {
  display: flex;
  animation: bounceIn 0.5s ease-out;
}

/* Pulso suave constante */
@keyframes pulse {
  0%, 100% {
    box-shadow: 0 8px 24px rgba(37, 211, 102, 0.35);
  }
  50% {
    box-shadow: 0 8px 24px rgba(37, 211, 102, 0.6), 0 0 0 8px rgba(37, 211, 102, 0.2);
  }
}

#btnWhatsAppFloat {
  animation: pulse 2s infinite;
}

/* Tooltip al hacer hover */
#btnWhatsAppFloat::before {
  content: "Chatear por WhatsApp";
  position: absolute;
  right: 72px;
  background: rgba(0, 0, 0, 0.85);
  color: white;
  padding: 8px 14px;
  border-radius: 8px;
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.3s ease;
  font-family: var(--font);
}

#btnWhatsAppFloat:hover::before {
  opacity: 1;
}

/* Responsive */
@media (max-width: 640px) {
  #btnWhatsAppFloat {
    width: 56px;
    height: 56px;
    font-size: 28px;
    bottom: 86px;
    right: 18px;
  }
  
  #btnWhatsAppFloat::before {
    display: none; /* Ocultar tooltip en m√≥vil */
  }
}

/* Ajuste del bot√≥n de Gmail para ocupar todo el ancho */
.button-group {
  display: grid;
  grid-template-columns: 1fr; /* Solo una columna */
  gap: 10px;
  margin-bottom: 16px;
}

.btn-whatsapp {
  display: none !important; /* Ocultar bot√≥n WhatsApp del formulario */
}


/* 3) CSS: estilo para el encuadre de descripci√≥n */
.image-description{
  margin-top:12px;
  padding:10px 12px;
  border-radius:12px;
  background: linear-gradient(180deg, var(--surface-2), var(--surface));
  color: var(--muted);
  font-size:14px;
}
.image-description .muted{ opacity:0.75; }
</style>

<!-- Bot√≥n WhatsApp flotante (solo visible en p√°ginas de empresa) -->
<button id="btnWhatsAppFloat" aria-label="Chatear por WhatsApp">
  <img src="images/logowhatsapp2.png" alt="WhatsApp Logo" />
</button>

<script>
/* ============================================================
   L√ìGICA DEL BOT√ìN WHATSAPP FLOTANTE
   - Solo aparece en p√°ginas de empresa (#/empresa/*)
   - Se conecta con la funci√≥n existente IL_abrirWhatsApp
   - Incluye animaciones y estados
============================================================ */

(function() {
  const btnFloat = document.getElementById('btnWhatsAppFloat');
  
  // Funci√≥n para detectar si estamos en una p√°gina de empresa
  function esVistaEmpresa() {
    const hash = location.hash || '';
    return hash.match(/^#\/empresa\//);
  }
  
  // Funci√≥n para mostrar/ocultar el bot√≥n
  function actualizarVisibilidadBoton() {
    if (!btnFloat) return;
    
    if (esVistaEmpresa()) {
      btnFloat.classList.add('show');
    } else {
      btnFloat.classList.remove('show');
    }
  }
  
  // Conectar con la funci√≥n de WhatsApp existente
  if (btnFloat) {
    btnFloat.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // Verificar que exista la funci√≥n IL_openWAShortcuts
      if (typeof IL_openWAShortcuts === 'function') {
        IL_openWAShortcuts((mensajeSeleccionado) => {
          if (typeof IL_abrirWhatsApp === 'function') {
            IL_abrirWhatsApp(mensajeSeleccionado);
          }
        });
      } else if (typeof IL_abrirWhatsApp === 'function') {
        // Fallback directo si no hay shortcuts
        IL_abrirWhatsApp('');
      } else {
        console.warn('‚ùå Funciones de WhatsApp no disponibles');
      }
    });
  }
  
  // Actualizar visibilidad al cargar y al cambiar de ruta
  document.addEventListener('DOMContentLoaded', actualizarVisibilidadBoton);
  window.addEventListener('hashchange', actualizarVisibilidadBoton);
  
  // Ejecutar inmediatamente
  actualizarVisibilidadBoton();
  
  // Observer para detectar cambios din√°micos del DOM
  const observer = new MutationObserver(() => {
    actualizarVisibilidadBoton();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
  // Revalidar cada 500ms durante los primeros 3 segundos (por si hay carga lenta)
  let checks = 0;
  const interval = setInterval(() => {
    actualizarVisibilidadBoton();
    checks++;
    if (checks > 6) clearInterval(interval);
  }, 500);
})();




</script>

<script>
(function(){

  function generarRedesEmpresa() {

    // Solo ejecutar en la vista de empresa
    if (!location.hash.startsWith("#/empresa/")) return;

    // Obtener ID
    const match = location.hash.match(/empresa\/(e-\d+)/);
    if (!match) return;
    const id = match[1];

    // Buscar empresa en tu DATA
    const empresa = (window.DATA?.empresas || []).find(e => e.id === id);
    if (!empresa) return;

    // Buscar bloque del encabezado de la empresa
    const header = document.querySelector(".empresa-header");  
    if (!header) return;

    // Evitar duplicaciones
    let box = document.getElementById("redesSupBox");
    if (box) box.remove();

    // Crear contenedor
    box = document.createElement("div");
    box.id = "redesSupBox";
    box.className = "redes-superiores";

    // Crear helper para insertar
    function agregarIcono(url, img) {
      if (!url) return;
      const a = document.createElement("a");
      a.href = url;
      a.target = "_blank";
      a.rel = "noopener";
      a.innerHTML = `<img src="${img}">`;
      box.appendChild(a);
    }

    // Agregar cada red si existe
    agregarIcono(empresa.facebook,  "https://cdn-icons-png.flaticon.com/512/124/124010.png");
    agregarIcono(empresa.instagram, "https://cdn-icons-png.flaticon.com/512/174/174855.png");
    agregarIcono(empresa.tiktok,    "https://cdn-icons-png.flaticon.com/512/3046/3046121.png");

    // Insertar al header
    header.appendChild(box);
  }

  // Observer para SPA
  new MutationObserver(() => generarRedesEmpresa())
    .observe(document.body, { childList:true, subtree:true });

  // Hash carga
  window.addEventListener("hashchange", () => {
    setTimeout(generarRedesEmpresa, 60);
  });

  // Carga inicial
  document.addEventListener("DOMContentLoaded", generarRedesEmpresa);

})();
</script>
<script>
(function(){

  function addCopyWebButton() {

    // Buscar todas las l√≠neas de contacto
    const filas = document.querySelectorAll('.info-row');
    if (!filas.length) return;

    let rowSitio = null;

    // Buscar el <div class="k"> que diga "Sitio web"
    filas.forEach(f => {
      const k = f.querySelector('.k');
      if (k && k.innerText.trim().toLowerCase() === 'vitrina digital') {
        rowSitio = f;
      }
    });

    if (!rowSitio) return;

    const valueBox = rowSitio.querySelector('.v');
    if (!valueBox) return;

    const link = valueBox.querySelector('a');
    if (!link) return;

    // Evitar duplicados
    if (valueBox.querySelector('#btnCopyWeb')) return;

    // Crear bot√≥n de copiar
    const btn = document.createElement('button');
    btn.id = "btnCopyWeb";
    btn.innerHTML = "üîó";
    btn.title = "Copiar enlace web";

    btn.style.cssText = `
      margin-left: 8px;
      width: 32px;
      height: 32px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      background: white;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      font-size: 16px;
      transition: transform .15s ease;
    `;

    btn.addEventListener("mouseenter", () => btn.style.transform = "scale(1.15)");
    btn.addEventListener("mouseleave", () => btn.style.transform = "scale(1)");

    btn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(link.href);
        showToast("üîó Enlace copiado");
      } catch {
        alert("Tu navegador no permite copiar autom√°ticamente");
      }
    });

    valueBox.appendChild(btn);
  }

  function showToast(msg) {
  const box = document.createElement("div");
  box.textContent = msg;
  box.style.cssText = `
    position: fixed;
    bottom: 25px;
    right: 25px;
    background: #0EA5E9;
    color: white;
    padding: 12px 18px;
    border-radius: 8px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.25);
    font-size: 14px;
    font-weight: 600;
    z-index: 9999;
    opacity: 0;
    transform: translateY(10px);
    transition: opacity .25s ease, transform .25s ease;
  `;
  document.body.appendChild(box);

  // Animaci√≥n de entrada
  requestAnimationFrame(() => {
    box.style.opacity = "1";
    box.style.transform = "translateY(0)";
  });

  // Desaparece y se elimina
  setTimeout(() => {
    box.style.opacity = "0";
    box.style.transform = "translateY(10px)";
    setTimeout(() => box.remove(), 250);
  }, 1800);
}


  // Para SPA
  new MutationObserver(() => addCopyWebButton())
    .observe(document.body, { childList: true, subtree: true });

  document.addEventListener("DOMContentLoaded", addCopyWebButton);
  window.addEventListener("hashchange", () => setTimeout(addCopyWebButton, 60));

})();

/* ---------- Helper para renderizar iconos (emoji o imagen) ---------- */
function renderIcon(icon, size = '28px') {
  if (!icon) return 'üè¢';
  
  // Detectar si es una ruta de imagen
  const isImage = icon.startsWith('images/') || icon.startsWith('http') || icon.includes('.png') || icon.includes('.jpg') || icon.includes('.svg');
  
  if (isImage) {
    return `<img src="${icon}" alt="Icono" style="width:${size};height:${size};object-fit:contain;" loading="lazy">`;
  }
  
  return icon; // Es un emoji
}






function setupImageDescriptions(e, p){
  try{
    const textEl = document.getElementById('imageDescriptionText');
    const thumbsEl = document.getElementById('galThumbs');
    
    if(!textEl){
      console.warn('‚ö†Ô∏è #imageDescriptionText no encontrado');
      return;
    }

    // ‚úÖ PRIORIDAD: e.descripciones -> p.descripciones -> fallback
    let captions = [];
    
    if(Array.isArray(e?.descripciones) && e.descripciones.length) {
      captions = e.descripciones.slice();
      console.log('‚úÖ Usando e.descripciones:', captions);
    }
    else if(Array.isArray(p?.descripciones) && p.descripciones.length) {
      captions = p.descripciones.slice();
      console.log('‚úÖ Usando p.descripciones:', captions);
    }
    else {
      console.warn('‚ö†Ô∏è No se encontraron descripciones');
    }

    // Funci√≥n para renderizar descripci√≥n en √≠ndice espec√≠fico
    function renderAt(index){
      const txt = captions[index] || 'Sin descripci√≥n para esta imagen.';
      
      if(!txt || txt === 'Sin descripci√≥n para esta imagen.'){
        textEl.innerHTML = 'Sin descripci√≥n para esta imagen.';
        textEl.classList.add('muted');
      } else {
        textEl.classList.remove('muted');
        textEl.innerHTML = txt;
      }
      
      console.log(`üìù Mostrando descripci√≥n ${index}:`, txt);
    }

    // ‚úÖ INICIALIZAR: buscar thumb activo
    const active = thumbsEl?.querySelector('.thumb[aria-current="true"]');
    const startIdx = active ? Number(active.dataset.index || 0) : 0;
    renderAt(startIdx);

    // ‚úÖ CLICK EN THUMBNAILS
    if(thumbsEl){
      thumbsEl.addEventListener('click', (ev)=>{
        const t = ev.target.closest('.thumb');
        if(!t) return;
        
        const idx = Number(t.dataset.index || 0);
        
        // Actualizar aria-current
        thumbsEl.querySelectorAll('.thumb').forEach(x => 
          x.setAttribute('aria-current','false')
        );
        t.setAttribute('aria-current','true');
        
        // Actualizar descripci√≥n
        renderAt(idx);
      });

      // ‚úÖ OBSERVADOR para cambios externos
      const mo = new MutationObserver(()=> {
        const a = thumbsEl.querySelector('.thumb[aria-current="true"]');
        if(a) {
          const i = Number(a.dataset.index || 0);
          renderAt(i);
        }
      });
      
      mo.observe(thumbsEl, { 
        attributes: true, 
        subtree: true, 
        attributeFilter: ['aria-current'] 
      });

    } else {
      console.warn('‚ö†Ô∏è #galThumbs no encontrado');
    }

    return {
      updateCaptions(newCaptions){
        if(!Array.isArray(newCaptions)) return;
        captions.length = 0;
        captions.push(...newCaptions);
        const a = document.querySelector('.thumb[aria-current="true"]');
        renderAt(a ? Number(a.dataset.index || 0) : 0);
      }
    };
    
  }catch(err){
    console.error('‚ùå setupImageDescriptions error:', err);
  }
}

</script>

<style>
/* Panel flotante de mensaje WhatsApp */
#waPanelFloat {
  position: fixed;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 90%;
  max-width: 500px;
  background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  border-radius: 16px 16px 0 0;
  box-shadow: 0 -8px 32px rgba(37, 211, 102, 0.4);
  z-index: 999997;
  display: none;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease;
}

#waPanelFloat.show {
  display: block;
  animation: slideUpPanel 0.5s ease-out;
}

/* ‚úÖ CAMBIO: Ya no ocultamos todo el panel, solo el body */
/* #waPanelFloat.hidden {
  transform: translateX(-50%) translateY(100%);
} */

@keyframes slideUpPanel {
  from {
    transform: translateX(-50%) translateY(100%);
    opacity: 0;
  }
  to {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }
}

/* Cabecera del panel */
.wa-panel-header {
  padding: 14px 18px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.15);
  cursor: pointer;
  user-select: none;
  border-radius: 16px 16px 0 0; /* ‚úÖ Bordes redondeados cuando est√° colapsado */
}

.wa-panel-title {
  display: flex;
  align-items: center;
  gap: 10px;
  color: white;
  font-weight: 700;
  font-size: 15px;
}

.wa-panel-icon {
  font-size: 22px;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-5px); }
}

.wa-toggle-btn {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  border: none;
  color: white;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  transition: all 0.25s ease;
}

.wa-toggle-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  transform: scale(1.1);
}

.wa-toggle-btn.collapsed {
  transform: rotate(180deg);
}

/* Cuerpo del panel */
.wa-panel-body {
  padding: 16px 18px 20px;
  background: white;
  max-height: 180px; /* ‚úÖ Altura cuando est√° expandido */
  opacity: 1;
  overflow: hidden;
  transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), 
              padding 0.4s ease, 
              opacity 0.3s ease;
}

/* ‚úÖ CAMBIO CLAVE: Solo colapsamos el body, no todo el panel */
#waPanelFloat.collapsed .wa-panel-body {
  max-height: 0;
  padding: 0 18px;
  opacity: 0;
  pointer-events: none;
}

/* ‚úÖ Ocultar el borde inferior del header cuando est√° colapsado */
#waPanelFloat.collapsed .wa-panel-header {
  border-bottom: none;
}

/* √Årea de texto */
.wa-message-box {
  position: relative;
  margin-bottom: 12px;
}

.wa-textarea {
  width: 100%;
  min-height: 70px;
  padding: 12px 14px;
  border: 2px solid #e0e0e0;
  border-radius: 12px;
  font-family: var(--font);
  font-size: 14px;
  resize: vertical;
  transition: border-color 0.25s ease, box-shadow 0.25s ease;
  background: #f9f9f9;
}

.wa-textarea:focus {
  outline: none;
  border-color: #25D366;
  box-shadow: 0 0 0 3px rgba(37, 211, 102, 0.15);
  background: white;
}

.wa-textarea::placeholder {
  color: #999;
}

/* Contador de caracteres */
.wa-char-count {
  position: absolute;
  bottom: -20px;
  right: 4px;
  font-size: 11px;
  color: #666;
}

/* √Årea de bot√≥n */
.wa-panel-actions {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 10px;
  margin-top: 8px;
}

.wa-send-btn {
  padding: 10px 24px;
  background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
  color: white;
  border: none;
  border-radius: 20px;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.25s ease;
  box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3);
}

.wa-send-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(37, 211, 102, 0.4);
  background: linear-gradient(135deg, #20bd5a 0%, #0e7a69 100%);
}

.wa-send-btn:active {
  transform: translateY(0);
}

.wa-send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none !important;
}

/* Indicador visual */
.wa-pulse-indicator {
  width: 10px;
  height: 10px;
  background: #34D399;
  border-radius: 50%;
  animation: pulse 1.5s infinite;
  box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7);
}

@keyframes pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(52, 211, 153, 0.7);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(52, 211, 153, 0);
  }
}

/* Responsive */
@media (max-width: 640px) {
  #waPanelFloat {
    width: 95%;
    max-width: none;
  }
  
  .wa-panel-header {
    padding: 12px 14px;
  }
  
  .wa-panel-title {
    font-size: 14px;
  }
  
  .wa-panel-body {
    padding: 14px;
  }
  
  .wa-textarea {
    min-height: 60px;
    font-size: 13px;
  }
  
  .wa-send-btn {
    padding: 8px 18px;
    font-size: 13px;
  }
}

/* ‚úÖ Ajustar otros botones flotantes seg√∫n el estado del panel */
#waPanelFloat.show:not(.collapsed) ~ #btnWhatsAppFloat,
#waPanelFloat.show:not(.collapsed) ~ #ppFloatBtn,
#waPanelFloat.show:not(.collapsed) ~ #btnToTop {
  bottom: 200px !important;
  transition: bottom 0.4s ease;
}

#waPanelFloat.collapsed ~ #btnWhatsAppFloat,
#waPanelFloat.collapsed ~ #ppFloatBtn,
#waPanelFloat.collapsed ~ #btnToTop {
  bottom: 96px !important;
  transition: bottom 0.4s ease;
}
</style>

<!-- Panel HTML (sin cambios) -->
<div id="waPanelFloat">
  <div class="wa-panel-header" id="waPanelToggle">
    <div class="wa-panel-title">
      <span class="wa-panel-icon">‚úçÔ∏è</span>
      <span>¬°Redacta tu mensaje mientras navegas!</span>
      <div class="wa-pulse-indicator"></div>
    </div>
    <button class="wa-toggle-btn" id="waPanelCollapseBtn" aria-label="Ocultar panel">
      ‚ñº
    </button>
  </div>
  
  <div class="wa-panel-body">
    <div class="wa-message-box">
      <textarea 
        id="waPanelTextarea" 
        class="wa-textarea" 
        placeholder="Escribe tu mensaje aqu√≠... Ej: Hola, estoy interesado en..."
        maxlength="500"
      ></textarea>
      <div class="wa-char-count">
        <span id="waCharCounter">0</span>/500
      </div>
    </div>
    
    <div class="wa-panel-actions">
      <button id="waPanelSendBtn" class="wa-send-btn" disabled>
        <span>Enviar por WhatsApp</span>
        <span>üì§</span>
      </button>
    </div>
  </div>
</div>

<script>
/* ============================================================
   L√ìGICA DEL PANEL FLOTANTE DE MENSAJE WHATSAPP
   ‚úÖ Modificado para colapsar solo el contenido
============================================================ */

(function() {
  const panel = document.getElementById('waPanelFloat');
  const textarea = document.getElementById('waPanelTextarea');
  const sendBtn = document.getElementById('waPanelSendBtn');
  const charCounter = document.getElementById('waCharCounter');
  const collapseBtn = document.getElementById('waPanelCollapseBtn');
  const headerToggle = document.getElementById('waPanelToggle');
  
  let isCollapsed = false;
  
  // Funci√≥n para detectar si estamos en una p√°gina de empresa
  function esVistaEmpresa() {
    const hash = location.hash || '';
    return hash.match(/^#\/empresa\//);
  }
  
  // Funci√≥n para mostrar/ocultar el panel
  function actualizarVisibilidadPanel() {
    if (!panel) return;
    
    if (esVistaEmpresa()) {
      panel.classList.add('show');
      
      // ‚úÖ Guardar el estado colapsado
      const wasCollapsed = localStorage.getItem('waPanelCollapsed') === 'true';
      if (wasCollapsed) {
        panel.classList.add('collapsed'); // ‚úÖ Cambiado de 'hidden' a 'collapsed'
        collapseBtn.classList.add('collapsed');
        isCollapsed = true;
      }
    } else {
      panel.classList.remove('show');
    }
  }
  
  // Contador de caracteres
  if (textarea && charCounter) {
    textarea.addEventListener('input', function() {
      const length = this.value.length;
      charCounter.textContent = length;
      
      // Habilitar/deshabilitar bot√≥n de env√≠o
      if (sendBtn) {
        sendBtn.disabled = length < 3;
      }
      
      // Guardar borrador en localStorage
      if (esVistaEmpresa()) {
        const empresaId = IL_getEmpresaID();
        if (empresaId) {
          localStorage.setItem(`waPanel_draft_${empresaId}`, this.value);
        }
      }
    });
  }
  
  // ‚úÖ Toggle colapsar/expandir - MODIFICADO
  function togglePanel() {
    isCollapsed = !isCollapsed;
    
    if (isCollapsed) {
      panel.classList.add('collapsed'); // ‚úÖ Cambiado de 'hidden' a 'collapsed'
      collapseBtn.classList.add('collapsed');
    } else {
      panel.classList.remove('collapsed'); // ‚úÖ Cambiado de 'hidden' a 'collapsed'
      collapseBtn.classList.remove('collapsed');
    }
    
    // Guardar estado
    localStorage.setItem('waPanelCollapsed', isCollapsed);
  }
  
  if (collapseBtn) {
    collapseBtn.addEventListener('click', function(e) {
      e.stopPropagation();
      togglePanel();
    });
  }
  
  // Clic en el header tambi√©n colapsa/expande
  if (headerToggle) {
    headerToggle.addEventListener('click', function(e) {
      if (e.target === collapseBtn || e.target.closest('.wa-toggle-btn')) return;
      togglePanel();
    });
  }
  
  // Enviar mensaje
  if (sendBtn) {
    sendBtn.addEventListener('click', function() {
      if (textarea.value.length < 3) return;
      
      const mensaje = textarea.value.trim();
      
      // Usar la funci√≥n existente de WhatsApp
      if (typeof IL_abrirWhatsApp === 'function') {
        IL_abrirWhatsApp(mensaje);
        
        // Limpiar textarea despu√©s de enviar
        textarea.value = '';
        charCounter.textContent = '0';
        sendBtn.disabled = true;
        
        // Limpiar borrador
        const empresaId = IL_getEmpresaID();
        if (empresaId) {
          localStorage.removeItem(`waPanel_draft_${empresaId}`);
        }
        
        // Feedback visual
        sendBtn.innerHTML = '<span>‚úì Enviado</span>';
        setTimeout(() => {
          sendBtn.innerHTML = '<span>Enviar por WhatsApp</span><span>üì§</span>';
        }, 2000);
        
      } else {
        alert('‚ö†Ô∏è No se pudo conectar con WhatsApp');
      }
    });
  }
  
  // Restaurar borrador al cargar empresa
  function restaurarBorrador() {
    if (!esVistaEmpresa() || !textarea) return;
    
    const empresaId = IL_getEmpresaID();
    if (empresaId) {
      const borrador = localStorage.getItem(`waPanel_draft_${empresaId}`);
      if (borrador) {
        textarea.value = borrador;
        charCounter.textContent = borrador.length;
        sendBtn.disabled = borrador.length < 3;
      } else {
        textarea.value = '';
        charCounter.textContent = '0';
        sendBtn.disabled = true;
      }
    }
  }
  
  // Atajo de teclado: Ctrl/Cmd + Enter para enviar
  if (textarea) {
    textarea.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        if (!sendBtn.disabled) {
          sendBtn.click();
        }
      }
    });
  }
  
  // Actualizar visibilidad al cargar y al cambiar de ruta
  document.addEventListener('DOMContentLoaded', function() {
    actualizarVisibilidadPanel();
    restaurarBorrador();
  });
  
  window.addEventListener('hashchange', function() {
    actualizarVisibilidadPanel();
    setTimeout(restaurarBorrador, 100);
  });
  
  // Ejecutar inmediatamente
  actualizarVisibilidadPanel();
  restaurarBorrador();
  
  // Observer para detectar cambios din√°micos
  const observer = new MutationObserver(function() {
    actualizarVisibilidadPanel();
  });
  
  observer.observe(document.body, {
    childList: true,
    subtree: true
  });
  
})();
</script>


</body>
</html>